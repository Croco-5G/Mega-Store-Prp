<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DevTrack Pro | إدارة المشاريع</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512'%3E%3Cpath fill='%2300f3ff' d='M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3L562.7 256l-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z'/%3E%3C/svg%3E">

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #00f3ff;       /* نيون سماوي */
            --primary-dark: #00bcd4;
            --secondary: #bd00ff;     /* نيون زهري */
            --bg-dark: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            /* ألوان الحالة */
            --success: #00ff9d;
            --warning: #ffb700;
            --danger: #ff0055;
        }

        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- تأثير الخلفية المتحركة --- */
        body::before {
            content: '';
            position: fixed;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.03) 0%, transparent 60%), 
                        radial-gradient(circle, rgba(189, 0, 255, 0.03) 0%, transparent 60%);
            background-size: 50% 50%, 60% 60%;
            background-position: 0 0, 100% 100%;
            animation: moveBackground 20s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes moveBackground {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 280px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid var(--glass-border);
            height: 100dvh;
            position: fixed;
            right: 0; top: 0;
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(0);
            display: flex; flex-direction: column;
        }

        .brand {
            padding: 30px 20px;
            text-align: center;
            font-family: 'Outfit', sans-serif;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .clock-widget {
            text-align: center;
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .menu-items { padding: 0 15px; flex: 1; overflow-y: auto; }
        
        .sidebar button {
            width: 100%;
            padding: 14px 15px;
            margin-bottom: 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 15px;
            font-weight: 600;
            text-align: right;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex; align-items: center; gap: 12px;
        }

        .sidebar button:hover { background: rgba(255,255,255,0.05); color: #fff; transform: translateX(-5px); }
        
        .sidebar button.active {
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.15), transparent);
            color: var(--primary);
            border-right: 3px solid var(--primary);
        }

        .sidebar button i { width: 25px; text-align: center; }

        /* --- Main Content --- */
        .main-content {
            margin-right: 280px;
            padding: 30px;
            transition: all 0.3s;
        }

        /* --- Cards & Glassmorphism --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; color: #fff; font-size: 20px; }
        h3 i { color: var(--primary); }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .stat-box {
            background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; gap: 15px;
            transition: transform 0.3s;
        }
        .stat-box:hover { transform: translateY(-5px); border-color: var(--primary); }

        .stat-icon {
            width: 50px; height: 50px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px;
            background: rgba(0,0,0,0.3);
        }

        /* --- Forms --- */
        .input-group label { display: block; color: var(--text-muted); margin-bottom: 8px; font-size: 13px; }
        
        input, select, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: #fff;
            padding: 14px;
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            transition: 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }

        /* --- Buttons --- */
        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-glow {
            background: linear-gradient(90deg, var(--primary), #00bcd4);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }
        .btn-glow:hover { box-shadow: 0 0 30px rgba(0, 243, 255, 0.5); transform: scale(1.02); }

        .btn-danger { background: rgba(255, 0, 85, 0.15); color: var(--danger); border: 1px solid rgba(255, 0, 85, 0.3); }
        .btn-danger:hover { background: var(--danger); color: #fff; }

        .btn-whatsapp { background: #25D366; color: #fff; font-size: 12px; padding: 6px 12px; border-radius: 6px; }

        /* --- Tables --- */
        .table-wrap { overflow-x: auto; border-radius: 15px; border: 1px solid var(--glass-border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: rgba(0,0,0,0.3); color: var(--primary); padding: 15px; text-align: center; font-size: 13px; }
        td { padding: 15px; border-bottom: 1px solid var(--glass-border); text-align: center; color: #cbd5e1; font-size: 14px; }
        tr:hover { background: rgba(255,255,255,0.02); }
        
        .progress-bar {
            height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 5px;
        }
        .progress-fill { height: 100%; background: var(--warning); width: 0%; transition: width 1s; }

        /* --- Helpers --- */
        .hidden { display: none; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .flex-row { display: flex; gap: 10px; align-items: center; }

        /* --- Mobile Fixes --- */
        .mobile-btn {
            display: none;
            position: fixed; top: 20px; right: 20px; z-index: 100000;
            background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border); color: #fff;
            width: 45px; height: 45px; border-radius: 12px;
            font-size: 20px; cursor: pointer;
        }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9990; backdrop-filter: blur(5px); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); }
            .sidebar.active { transform: translateX(0); }
            .overlay.active { display: block; }
            .mobile-btn { display: flex; align-items: center; justify-content: center; }
            .main-content { margin-right: 0; padding-top: 80px; }
            
            /* Force Column Layout */
            .grid-2, .grid-3, .flex-row { display: flex !important; flex-direction: column !important; align-items: stretch !important; gap: 15px !important; }
            
            /* Keep Currency Row Horizontal */
            .currency-row { display: flex !important; flex-direction: row !important; gap: 10px !important; }
            .currency-row input { flex: 1 !important; }
            .currency-row select { width: 90px !important; flex: none !important; }
            
            input, select, button, .btn { width: 100% !important; margin: 0 !important; }
        }

        /* --- Notifications --- */
        #notification {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(16, 185, 129, 0.9); backdrop-filter: blur(10px);
            color: #000; padding: 12px 25px; border-radius: 50px;
            font-weight: 700; z-index: 100000; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        #syncStatus {
            position: fixed; top: 25px; left: 25px;
            background: rgba(0,0,0,0.5); padding: 8px 15px;
            border-radius: 50px; font-size: 12px; color: var(--text-muted);
            border: 1px solid var(--glass-border); z-index: 100000;
        }

    </style>
</head>

<body>

<div id="syncStatus"><i class="fas fa-circle-notch fa-spin"></i> جاري الاتصال...</div>
<div id="notification">تم الحفظ بنجاح</div>

<button class="mobile-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
<div class="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div class="brand"><i class="fas fa-code"></i> DevTrack</div>
    <div class="clock-widget" id="clock">00:00</div>
    
    <div class="menu-items">
        <button onclick="nav('dashboard', this)" class="active"><i class="fas fa-rocket"></i> مشاريع جديدة</button>
        <button onclick="nav('deadlines', this)"><i class="fas fa-clock"></i> مواعيد التسليم</button>
        <button onclick="nav('finances', this)"><i class="fas fa-wallet"></i> المحفظة المالية</button>
        <button onclick="nav('history', this)"><i class="fas fa-history"></i> سجل الأعمال</button>
        <button onclick="nav('analytics', this)"><i class="fas fa-chart-pie"></i> التحليلات</button>
        <button onclick="nav('backup', this)"><i class="fas fa-save"></i> النسخ الاحتياطي</button>
    </div>
</div>

<div class="main-content">
    
    <div class="grid-3" style="margin-bottom: 30px;">
        <div class="stat-box">
            <div class="stat-icon" style="color: var(--success)"><i class="fas fa-dollar-sign"></i></div>
            <div><small>الأرباح (USD)</small><div id="statUSD" style="font-size: 20px; font-weight: 700;">0.00 $</div></div>
        </div>
        <div class="stat-box">
            <div class="stat-icon" style="color: var(--primary)"><i class="fas fa-shekel-sign"></i></div>
            <div><small>الأرباح (ILS)</small><div id="statILS" style="font-size: 20px; font-weight: 700;">0.00 ₪</div></div>
        </div>
        <div class="stat-box">
            <div class="stat-icon" style="color: var(--secondary)"><i class="fas fa-briefcase"></i></div>
            <div><small>مشاريع الشهر</small><div id="statProjects" style="font-size: 20px; font-weight: 700;">0</div></div>
        </div>
    </div>

    <div id="dashboard" class="glass-card">
        <h3><i class="fas fa-plus-circle"></i> تسجيل مشروع جديد</h3>
        
        <div class="grid-2" style="margin-top: 20px;">
            <div class="input-group">
                <label>نوع الخدمة</label>
                <input id="pType" placeholder="مثال: موقع إلكتروني، تطبيق...">
            </div>
            <div class="input-group">
                <label>اسم العميل / الجهة</label>
                <input id="pClient" placeholder="اسم العميل">
            </div>
        </div>
        
        <div class="grid-2">
            <div class="input-group">
                <label>رقم التواصل (واتساب)</label>
                <input id="pPhone" placeholder="059xxxxxxx">
            </div>
            <div class="input-group">
                <label>مدة العمل (أيام)</label>
                <input type="number" id="pDuration" placeholder="7">
            </div>
        </div>

        <div class="grid-2" style="margin-top: 10px;">
            <div class="input-group">
                <label>قيمة الاتفاق (المدفوعات)</label>
                <div class="currency-row flex-row" style="gap:10px">
                    <input type="number" id="pAmount" placeholder="0.00">
                    <select id="pCur" style="background:rgba(0,0,0,0.5)"><option value="$">USD $</option><option value="₪">ILS ₪</option></select>
                </div>
            </div>
            <div class="input-group">
                <label>تكاليف التشغيل (سيرفرات/إلخ)</label>
                <div class="currency-row flex-row" style="gap:10px">
                    <input type="number" id="pCost" placeholder="0.00">
                    <select id="pCostCur" style="background:rgba(0,0,0,0.5)"><option value="$">USD $</option><option value="₪">ILS ₪</option></select>
                </div>
            </div>
        </div>

        <div class="glass-card grid-2" style="background:rgba(0,0,0,0.2); margin-top: 20px;">
            <div class="input-group">
                <label>إيداع في محفظة:</label>
                <select id="walletSelect"></select>
            </div>
            <div class="input-group">
                <label>خصم التكاليف من:</label>
                <select id="costWalletSelect"></select>
            </div>
        </div>

        <button class="btn btn-glow" style="width: 100%; margin-top: 10px;" onclick="addProject()">
            <i class="fas fa-check"></i> حفظ المشروع وبدء العمل
        </button>
    </div>

    <div id="deadlines" class="glass-card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3><i class="fas fa-hourglass-half"></i> مشاريع قيد التسليم</h3>
            <button class="btn btn-danger" style="font-size:12px; padding:8px 15px" onclick="cleanDeadlines()">أرشفة المنتهي</button>
        </div>
        <div class="table-wrap">
            <table id="deadlineTable">
                <thead><tr><th>المشروع</th><th>العميل</th><th>الموعد</th><th>الوقت المتبقي</th><th>تواصل</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="finances" class="glass-card hidden">
        <h3><i class="fas fa-wallet"></i> إدارة المحافظ المالية</h3>
        
        <div class="grid-2" style="margin-bottom: 30px;">
            <div class="glass-card" style="margin:0; background:rgba(0,255,157,0.05)">
                <h4 style="color:var(--success); margin:0 0 10px 0;">دخل الدولار الصافي</h4>
                <div id="netUSD" style="font-size:24px; font-weight:900">0.00 $</div>
            </div>
            <div class="glass-card" style="margin:0; background:rgba(0,243,255,0.05)">
                <h4 style="color:var(--primary); margin:0 0 10px 0;">دخل الشيكل الصافي</h4>
                <div id="netILS" style="font-size:24px; font-weight:900">0.00 ₪</div>
            </div>
        </div>

        <div class="table-wrap" style="margin-bottom: 30px;">
            <table>
                <thead><tr><th>المحفظة</th><th>العملة</th><th>الرصيد الحالي</th><th>الإجراء</th></tr></thead>
                <tbody id="walletTable"></tbody>
            </table>
        </div>

        <h3><i class="fas fa-plus"></i> إضافة محفظة جديدة</h3>
        <div class="flex-row" style="background:rgba(0,0,0,0.2); padding:15px; border-radius:15px;">
            <input id="newWName" placeholder="اسم المحفظة (مثلاً: PayPal)">
            <select id="newWCur" style="width:100px"><option value="$">$</option><option value="₪">₪</option></select>
            <button class="btn btn-primary" onclick="addWallet()">إنشاء</button>
        </div>
    </div>

    <div id="history" class="glass-card hidden">
        <h3><i class="fas fa-history"></i> أرشيف المشاريع</h3>
        <input id="searchHist" onkeyup="renderHistory()" placeholder="بحث باسم العميل أو المشروع..." style="margin-bottom:20px;">
        <div class="table-wrap">
            <table id="histTable">
                <thead><tr><th>التاريخ</th><th>المشروع</th><th>العميل</th><th>القيمة</th><th>التكلفة</th><th>المحفظة</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="analytics" class="hidden">
        <div class="grid-2">
            <div class="glass-card" style="height:400px; display:flex; flex-direction:column; justify-content:center;">
                <h4 style="text-align:center">توزيع المشاريع (العدد)</h4>
                <div style="position:relative; flex:1; min-height:0;"><canvas id="chartPie"></canvas></div>
            </div>
            <div class="glass-card" style="height:400px; display:flex; flex-direction:column; justify-content:center;">
                <h4 style="text-align:center">الأداء الشهري</h4>
                <div style="position:relative; flex:1; min-height:0;"><canvas id="chartBar"></canvas></div>
            </div>
        </div>
    </div>

    <div id="backup" class="glass-card hidden">
        <h3><i class="fab fa-github"></i> الربط السحابي (GitHub)</h3>
        <div class="grid-2" style="margin-bottom: 20px;">
            <div class="input-group"><label>User</label><input id="ghUser"></div>
            <div class="input-group"><label>Repo</label><input id="ghRepo"></div>
            <div class="input-group"><label>Token</label><input type="password" id="ghToken"></div>
            <div class="input-group"><label>Filename</label><input id="ghFile" value="data.json"></div>
        </div>
        <div class="flex-row">
            <button class="btn btn-primary" onclick="saveGHSettings()">حفظ الإعدادات</button>
            <button class="btn btn-glow" onclick="syncDown()">سحب البيانات <i class="fas fa-download"></i></button>
            <button class="btn btn-glow" style="background:#bd00ff" onclick="syncUp()">رفع البيانات <i class="fas fa-upload"></i></button>
        </div>

        <hr style="border-color:var(--glass-border); margin:30px 0;">

        <h3><i class="fas fa-file-export"></i> تصدير واستيراد محلي</h3>
        <div class="flex-row" style="background:rgba(0,0,0,0.2); padding:20px; border-radius:15px;">
            <button class="btn btn-primary" onclick="exportLocal()">تحميل ملف JSON</button>
            <div style="flex:1; border-left:1px solid var(--glass-border); padding-right:15px; display:flex; flex-direction:column; gap:10px;">
                <input type="file" id="importFile" style="padding:10px;">
                <button class="btn btn-danger" onclick="importLocal()">استعادة</button>
            </div>
        </div>
    </div>

</div>

<script>
// --- CORE LOGIC ---
const DB_VERSION = "2.0";
let db = {
    wallets: {},
    projects: [],
    settings: { ghUser:"", ghRepo:"", ghToken:"", ghFile:"data.json" }
};

let chartInstance1 = null;
let chartInstance2 = null;

function init() {
    // Load local data
    if(localStorage.getItem("devtrack_db")) {
        db = JSON.parse(localStorage.getItem("devtrack_db"));
    } else {
        // Default Data
        db.wallets = {
            "PayPal": { bal: 0, cur: "$" },
            "Bank": { bal: 0, cur: "₪" }
        };
    }
    
    // Fill Settings inputs
    document.getElementById("ghUser").value = db.settings.ghUser || "";
    document.getElementById("ghRepo").value = db.settings.ghRepo || "";
    document.getElementById("ghToken").value = db.settings.ghToken || "";
    
    // Initial Render
    renderWallets();
    renderStats();
    renderDeadlines();
    
    // Clock
    setInterval(() => {
        const now = new Date();
        document.getElementById("clock").innerText = now.toLocaleTimeString('en-US', {hour12:false}) + " | " + now.toLocaleDateString('en-GB');
    }, 1000);

    // Auto Sync if configured
    if(db.settings.ghToken) syncDown();
}

// --- NAVIGATION ---
function nav(pageId, btn) {
    document.querySelectorAll('.glass-card, .hidden').forEach(el => {
        if(el.id && el.id !== 'notification' && el.id !== 'syncStatus') el.style.display = 'none';
    });
    
    const page = document.getElementById(pageId);
    page.style.display = 'block';
    
    // Fix flex/grid display issues when unhiding
    if(pageId === 'analytics') {
        page.style.display = 'block';
        renderCharts();
    }
    
    document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // Close sidebar on mobile
    if(window.innerWidth <= 768) toggleSidebar();
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('active');
    document.querySelector('.overlay').classList.toggle('active');
}

// --- ACTIONS ---
function addProject() {
    const type = document.getElementById("pType").value;
    const client = document.getElementById("pClient").value;
    const phone = document.getElementById("pPhone").value;
    const days = +document.getElementById("pDuration").value;
    const amount = +document.getElementById("pAmount").value;
    const cur = document.getElementById("pCur").value;
    const cost = +document.getElementById("pCost").value;
    const costCur = document.getElementById("pCostCur").value;
    const walletKey = document.getElementById("walletSelect").value;
    const costWalletKey = document.getElementById("costWalletSelect").value;

    if(!type || !client || !amount) return showNotify("يرجى تعبئة البيانات الأساسية", "red");

    // 1. Calculations
    const now = new Date();
    const deadline = new Date();
    deadline.setDate(deadline.getDate() + days);

    // 2. Wallet Updates
    if(db.wallets[walletKey]) db.wallets[walletKey].bal += amount;
    if(db.wallets[costWalletKey]) db.wallets[costWalletKey].bal -= cost; // Simple deduction, ignoring conversion for simplicity or add conversion logic

    // 3. Save Project
    const project = {
        id: Date.now(),
        date: now.toISOString().split('T')[0],
        type, client, phone, amount, cur, cost, costCur,
        wallet: walletKey,
        deadline: deadline.getTime(),
        reminded: false
    };
    
    db.projects.push(project);
    saveData();
    
    // 4. Reset & Celebrate
    document.getElementById("pType").value = "";
    document.getElementById("pClient").value = "";
    document.getElementById("pAmount").value = "";
    document.getElementById("pCost").value = "";
    
    showNotify("تم إضافة المشروع بنجاح!", "#00ff9d");
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    
    renderStats();
}

function addWallet() {
    const name = document.getElementById("newWName").value;
    const cur = document.getElementById("newWCur").value;
    if(!name) return;
    db.wallets[name] = { bal: 0, cur };
    saveData();
    renderWallets();
    document.getElementById("newWName").value = "";
}

// --- RENDERING ---
function renderWallets() {
    const table = document.getElementById("walletTable");
    const select1 = document.getElementById("walletSelect");
    const select2 = document.getElementById("costWalletSelect");
    
    table.innerHTML = "";
    select1.innerHTML = "";
    select2.innerHTML = "";
    
    let totalUSD = 0, totalILS = 0;

    for(let [name, data] of Object.entries(db.wallets)) {
        // Table Row
        table.innerHTML += `<tr>
            <td style="font-weight:bold; color:var(--primary)">${name}</td>
            <td><span class="badge" style="background:rgba(255,255,255,0.1)">${data.cur}</span></td>
            <td dir="ltr" style="font-weight:bold">${data.bal.toFixed(2)}</td>
            <td><button class="btn-danger" style="padding:4px 8px; font-size:10px" onclick="deleteWallet('${name}')">حذف</button></td>
        </tr>`;

        // Select Options
        let opt = `<option value="${name}">${name} (${data.cur})</option>`;
        select1.innerHTML += opt;
        select2.innerHTML += opt;

        // Totals
        if(data.cur === '$') totalUSD += data.bal;
        else totalILS += data.bal;
    }
    
    document.getElementById("netUSD").innerText = totalUSD.toFixed(2) + " $";
    document.getElementById("netILS").innerText = totalILS.toFixed(2) + " ₪";
}

function renderDeadlines() {
    const tbody = document.querySelector("#deadlineTable tbody");
    tbody.innerHTML = "";
    const now = Date.now();

    const activeProjects = db.projects.filter(p => !p.archived);

    activeProjects.sort((a,b) => a.deadline - b.deadline);

    activeProjects.forEach(p => {
        const diff = p.deadline - now;
        const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
        const percent = Math.max(0, Math.min(100, (daysLeft / 30) * 100)); // Just a visual representation
        
        let status = daysLeft + " يوم";
        let color = "var(--success)";
        
        if(daysLeft <= 0) {
            status = "انتهى الموعد";
            color = "var(--danger)";
        } else if (daysLeft <= 3) {
            color = "var(--warning)";
        }

        // Whatsapp Link
        let phone = p.phone.replace(/\D/g, '');
        if(phone.startsWith('0')) phone = '970' + phone.substring(1);
        const waMsg = `مرحباً ${p.client}، بخصوص مشروع (${p.type})...`;
        const waLink = `https://wa.me/${phone}?text=${encodeURIComponent(waMsg)}`;

        // Row Style
        const rowStyle = p.reminded ? "background: rgba(0, 255, 157, 0.1);" : "";

        tbody.innerHTML += `
        <tr style="${rowStyle}">
            <td>${p.type}</td>
            <td>${p.client}</td>
            <td dir="ltr">${new Date(p.deadline).toLocaleDateString()}</td>
            <td>
                <span style="color:${color}; font-weight:bold">${status}</span>
                <div class="progress-bar"><div class="progress-fill" style="width:${daysLeft > 0 ? '50%' : '100%'}; background:${color}"></div></div>
            </td>
            <td>
                <a href="${waLink}" target="_blank" onclick="markRemind(${p.id})" class="btn-whatsapp"><i class="fab fa-whatsapp"></i></a>
            </td>
        </tr>`;
    });
}

function renderHistory() {
    const tbody = document.querySelector("#histTable tbody");
    const search = document.getElementById("searchHist").value.toLowerCase();
    tbody.innerHTML = "";

    db.projects.slice().reverse().forEach(p => {
        if(search && !p.client.toLowerCase().includes(search) && !p.type.toLowerCase().includes(search)) return;
        
        tbody.innerHTML += `<tr>
            <td>${p.date}</td>
            <td>${p.type}</td>
            <td>${p.client}</td>
            <td style="color:var(--success)">${p.amount} ${p.cur}</td>
            <td style="color:var(--danger)">${p.cost} ${p.costCur}</td>
            <td>${p.wallet}</td>
        </tr>`;
    });
}

function renderStats() {
    document.getElementById("statUSD").innerText = db.projects.filter(p=>p.cur==='$').reduce((a,b)=>a+b.amount,0).toFixed(2) + " $";
    document.getElementById("statILS").innerText = db.projects.filter(p=>p.cur==='₪').reduce((a,b)=>a+b.amount,0).toFixed(2) + " ₪";
    document.getElementById("statProjects").innerText = db.projects.length;
}

function renderCharts() {
    const ctx1 = document.getElementById('chartPie');
    const ctx2 = document.getElementById('chartBar');
    if(!ctx1 || !ctx2) return;

    if(chartInstance1) chartInstance1.destroy();
    if(chartInstance2) chartInstance2.destroy();

    // Chart 1: Project Types
    const types = {};
    db.projects.forEach(p => { types[p.type] = (types[p.type] || 0) + 1; });
    
    chartInstance1 = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: Object.keys(types),
            datasets: [{
                data: Object.values(types),
                backgroundColor: ['#00f3ff', '#bd00ff', '#ff0055', '#ffb700'],
                borderWidth: 0
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
    });

    // Chart 2: Monthly Income
    // Simplified for demo
    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun"];
    const income = [0, 0, 0, 0, 0, 0]; // Placeholder logic
    
    chartInstance2 = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'الدخل الشهري',
                data: [12, 19, 3, 5, 2, 3], // Mock data
                backgroundColor: '#00bcd4',
                borderRadius: 4
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { 
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#fff' } },
                x: { grid: { display: false }, ticks: { color: '#fff' } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

// --- DATA MANAGEMENT ---
function saveData() {
    localStorage.setItem("devtrack_db", JSON.stringify(db));
    syncUp();
}

function deleteWallet(name) {
    if(confirm("حذف المحفظة؟")) {
        delete db.wallets[name];
        saveData();
        renderWallets();
    }
}

function markRemind(id) {
    const p = db.projects.find(x => x.id === id);
    if(p) { p.reminded = true; saveData(); renderDeadlines(); }
}

function cleanDeadlines() {
    if(confirm("هل تريد أرشفة المشاريع المنتهية؟ (لن تظهر هنا ولكن ستبقى في السجل)")) {
        const now = Date.now();
        db.projects.forEach(p => {
            if(p.deadline < now) p.archived = true;
        });
        saveData();
        renderDeadlines();
    }
}

// --- GITHUB SYNC ---
function saveGHSettings() {
    db.settings.ghUser = document.getElementById("ghUser").value;
    db.settings.ghRepo = document.getElementById("ghRepo").value;
    db.settings.ghToken = document.getElementById("ghToken").value;
    db.settings.ghFile = document.getElementById("ghFile").value;
    saveData();
    showNotify("تم حفظ الإعدادات", "var(--success)");
}

async function syncUp() {
    if(!db.settings.ghToken) return;
    document.getElementById("syncStatus").innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
    
    try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
        const url = `https://api.github.com/repos/${db.settings.ghUser}/${db.settings.ghRepo}/contents/${db.settings.ghFile}`;
        
        // Get SHA first
        let sha = "";
        try {
            const getResp = await fetch(url, { headers: { 'Authorization': `token ${db.settings.ghToken}` } });
            if(getResp.ok) {
                const json = await getResp.json();
                sha = json.sha;
            }
        } catch(e) {}

        const putResp = await fetch(url, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${db.settings.ghToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: "Sync from DevTrack",
                content: content,
                sha: sha ? sha : undefined
            })
        });

        if(putResp.ok) {
            document.getElementById("syncStatus").innerHTML = '<i class="fas fa-check"></i> متزامن';
            setTimeout(() => { document.getElementById("syncStatus").innerHTML = '<i class="fas fa-cloud"></i> جاهز'; }, 2000);
        } else {
            throw new Error();
        }
    } catch(err) {
        document.getElementById("syncStatus").innerHTML = '<i class="fas fa-times"></i> خطأ بالمزامنة';
    }
}

async function syncDown() {
    if(!db.settings.ghToken) return;
    document.getElementById("syncStatus").innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري السحب...';
    
    try {
        const url = `https://api.github.com/repos/${db.settings.ghUser}/${db.settings.ghRepo}/contents/${db.settings.ghFile}`;
        const resp = await fetch(url, { headers: { 'Authorization': `token ${db.settings.ghToken}`, 'Accept': 'application/vnd.github.v3+json' } });
        
        if(resp.ok) {
            const json = await resp.json();
            const content = decodeURIComponent(escape(atob(json.content)));
            db = JSON.parse(content);
            localStorage.setItem("devtrack_db", JSON.stringify(db));
            
            // Refresh UI
            renderWallets();
            renderStats();
            renderDeadlines();
            
            document.getElementById("syncStatus").innerHTML = '<i class="fas fa-check"></i> تم التحديث';
        }
    } catch(err) {
        document.getElementById("syncStatus").innerHTML = '<i class="fas fa-exclamation"></i> فشل السحب';
    }
}

// --- UTILS ---
function showNotify(msg, color) {
    const n = document.getElementById("notification");
    n.innerText = msg;
    n.style.background = color || "var(--primary)";
    n.style.display = "block";
    setTimeout(() => n.style.display = "none", 3000);
}

function exportLocal() {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([JSON.stringify(db)], {type: "application/json"}));
    a.download = "devtrack_backup.json";
    a.click();
}

function importLocal() {
    const file = document.getElementById("importFile").files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        db = JSON.parse(e.target.result);
        saveData();
        location.reload();
    };
    reader.readAsText(file);
}

// Start
window.onload = init;

</script>
</body>
</html>
