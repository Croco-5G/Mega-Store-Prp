<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mega Store Pro | System</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%236366f1' d='M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z'/%3E%3C/svg%3E">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --accent: #f59e0b;
            --success: #10b981; --danger: #ef4444;
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-input: #f8fafc; --bg-sidebar: #0f172a;
            --text-main: #1e293b; --text-muted: #64748b; --border-color: #e2e8f0;
            --stat-card-border: rgba(255,255,255,0.8);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --yellow-bg: #fefce8; --yellow-border: #fde047; --yellow-text: #854d0e;
            --yellow-item-bg: #fffbeb; --yellow-item-border: #eab308; --yellow-item-text: #713f12;
            --yellow-btn-bg: #eab308; --yellow-btn-hover: #ca8a04;
        }
        body.dark-mode {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-input: #334155; --bg-sidebar: #020617;
            --text-main: #f1f5f9; --text-muted: #94a3b8; --border-color: #334155;
            --stat-card-border: #334155; --card-shadow: none;
            --yellow-bg: rgba(234, 179, 8, 0.1); --yellow-border: rgba(234, 179, 8, 0.3);
            --yellow-text: #fde047; --yellow-item-bg: rgba(234, 179, 8, 0.15);
            --yellow-item-border: #eab308; --yellow-item-text: #fef08a;
            --yellow-btn-bg: #eab308; --yellow-btn-hover: #ca8a04;
        }
        body.dark-mode .stat-icon[style*="#e0e7ff"] { background: rgba(99, 102, 241, 0.2) !important; color: #818cf8 !important; }
        body.dark-mode .stat-icon[style*="#dcfce7"] { background: rgba(16, 185, 129, 0.2) !important; color: #34d399 !important; }
        body.dark-mode .stat-icon[style*="#fef3c7"] { background: rgba(245, 158, 11, 0.2) !important; color: #fbbf24 !important; }
        
        * { box-sizing: border-box; font-family: 'Tajawal', 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }
        body.dark-mode ::-webkit-scrollbar-thumb { background-color: #334155; }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }

        html, body { width: 100%; height: 100%; overflow-x: hidden; position: relative; }
        body { background: var(--bg-body); margin: 0; color: var(--text-main); display: flex; min-height: 100vh; transition: background 0.3s, color 0.3s; }
        
        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 300000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
        .modal-content { background: var(--bg-card); width: 90%; max-width: 500px; padding: 30px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--text-main); transform: translateY(20px); animation: slideUp 0.3s forwards; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { to { transform: translateY(0); } }
        .detail-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; color: var(--text-muted); }
        .detail-value { font-weight: 700; color: var(--text-main); }
        .val-inc { color: var(--success); } .val-dec { color: var(--danger); }

        /* --- LOGIN STYLES --- */
        .login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%); z-index: 200000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; overflow: hidden; }
        .login-overlay::before { content: ''; position: absolute; width: 600px; height: 600px; background: rgba(99, 102, 241, 0.15); border-radius: 50%; top: -100px; left: -100px; animation: float 10s infinite ease-in-out; }
        .login-overlay::after { content: ''; position: absolute; width: 400px; height: 400px; background: rgba(245, 158, 11, 0.1); border-radius: 50%; bottom: -50px; right: -50px; animation: float 8s infinite ease-in-out reverse; }
        @keyframes float { 0% { transform: translate(0, 0); } 50% { transform: translate(20px, 40px); } 100% { transform: translate(0, 0); } }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 50px 40px; border-radius: 30px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 100%; max-width: 420px; text-align: center; position: relative; z-index: 10; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); transform: translateY(20px); opacity: 0; animation: slideUpFade 0.6s forwards 0.2s; transition: background 0.3s, border-color 0.3s; }
        body.dark-mode .login-card { background: rgba(30, 41, 59, 0.95); border-color: rgba(255,255,255,0.1); }
        body.dark-mode .login-card h2 { color: #f1f5f9; } body.dark-mode .login-card p { color: #94a3b8; }
        @keyframes slideUpFade { to { transform: translateY(0); opacity: 1; } }
        .login-icon-wrap { width: 90px; height: 90px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px auto; color: white; font-size: 36px; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); animation: pulseIcon 3s infinite; }
        @keyframes pulseIcon { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); transform: scale(1); } 50% { transform: scale(1.05); } 70% { box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); transform: scale(1); } }
        .login-card h2 { color: #1e293b; margin-bottom: 5px; font-weight: 800; font-size: 24px; }
        .login-card p { color: #64748b; margin-bottom: 30px; font-size: 14px; }
        .custom-input { position: relative; margin-bottom: 20px; }
        .custom-input i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: 0.3s; }
        .custom-input input { width: 100%; padding: 14px 45px 14px 15px; border-radius: 16px; border: 2px solid #e2e8f0; background: #f8fafc; color: #1e293b; font-size: 15px; transition: all 0.3s; outline: none; }
        .custom-input input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .custom-input input:focus + i { color: var(--primary); }
        body.dark-mode .custom-input input { background: #0f172a; border-color: #334155; color: #f1f5f9; }
        body.dark-mode .custom-input input:focus { border-color: var(--primary); background: #1e293b; }
        .btn-login { width: 100%; padding: 16px; background: linear-gradient(90deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-login:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4); }
        .btn-login:active { transform: translateY(-1px); }
        .loading-spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        .btn-login.loading .loading-spinner { display: block; }
        .btn-login.loading span { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .login-theme-toggle { position: absolute; top: 20px; right: 20px; z-index: 200001; }
        .login-theme-toggle label { background: rgba(255,255,255,0.2); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.3s; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .login-theme-toggle label:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .login-theme-toggle input { display: none; }
        body.dark-mode .login-theme-toggle label { background: var(--primary); color: white; }

        /* --- STANDARD APP CSS --- */
        .sidebar { width: 280px; background: var(--bg-sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100dvh; right: 0; top: 0; z-index: 9999; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: -5px 0 25px rgba(0,0,0,0.2); border-left: 1px solid var(--border-color); transform: translateX(0); padding-bottom: 20px; }
        .mobile-menu-btn { display: none; position: fixed; top: max(15px, env(safe-area-inset-top)); right: max(15px, env(safe-area-inset-right)); z-index: 100000; background: var(--primary); color: white; border: none; padding: 12px 16px; border-radius: 12px; font-size: 20px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        .mobile-menu-btn:active { transform: scale(0.95); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9990; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
        .brand { padding: 30px 20px 5px 20px; text-align: center; font-size: 18px; font-weight: 900; background: linear-gradient(135deg, var(--primary), #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
        .theme-switch-container { display: flex; justify-content: center; align-items: center; padding-bottom: 10px; gap: 10px; font-size: 13px; color: #94a3b8; }
        .theme-switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .theme-switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        .menu-items { padding: 10px; flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .sidebar button { width: 100%; padding: 14px 18px; margin-bottom: 5px; border: none; border-radius: 12px; background: transparent; color: #94a3b8; font-size: 15px; font-weight: 600; cursor: pointer; text-align: right; display: flex; align-items: center; gap: 12px; transition: all 0.3s; }
        .sidebar button:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .sidebar button.active { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); }
        .main-content { flex: 1; margin-right: 280px; padding: 30px; transition: all 0.3s; width: 100%; max-width: 100%; filter: blur(0px); }
        body.locked .main-content, body.locked .sidebar, body.locked .mobile-menu-btn, body.locked #syncStatus { filter: blur(15px); pointer-events: none; user-select: none; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 20px; display: flex; align-items: center; gap: 15px; box-shadow: var(--card-shadow); border: 1px solid var(--stat-card-border); color: var(--text-main); }
        .stat-icon { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .card { background: var(--bg-card); border-radius: 24px; padding: 35px; box-shadow: var(--card-shadow); border: 1px solid var(--border-color); margin-bottom: 30px; animation: fadeIn 0.5s ease-out; color: var(--text-main); position: relative; z-index: 1; }
        .inner-box { background: var(--bg-input) !important; border: 1px solid var(--border-color) !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h3 { font-size: 22px; font-weight: 800; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        h4 { color: var(--text-main); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-muted); font-size: 14px; }
        input, select, textarea { width: 100%; padding: 12px 16px; border-radius: 12px; border: 2px solid var(--border-color); background: var(--bg-input); color: var(--text-main); font-size: 15px; transition: all 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        .btn { padding: 12px 24px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        body.dark-mode .btn-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-warning { background: #fffbeb; color: #d97706; }
        body.dark-mode .btn-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .btn-warning:hover { background: #fef3c7; }
        .btn-whatsapp { background: #25D366; color: white; font-size: 12px; padding: 8px 12px; }
        .btn-whatsapp:hover { background: #128C7E; }
        .table-container { overflow-x: auto; border-radius: 15px; border: 1px solid var(--border-color); width: 100%; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); min-width: 600px; }
        th { background: var(--bg-input); padding: 16px; text-align: center; color: var(--text-muted); font-weight: 700; }
        td { padding: 16px; border-bottom: 1px solid var(--border-color); text-align: center; color: var(--text-main); }
        tr.reminded { background-color: #dcfce7 !important; }
        body.dark-mode tr.reminded { background-color: rgba(16, 185, 129, 0.2) !important; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; overflow: hidden; }
        .hidden { display: none !important; }
        #notification { position: fixed; bottom: 30px; left: 30px; padding: 16px 25px; border-radius: 16px; color: white; font-weight: 700; z-index: 100000; display: none; animation: slideIn 0.3s ease-out; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        #syncStatus { position: fixed; top: 20px; left: 30px; padding: 8px 15px; border-radius: 50px; font-size: 12px; font-weight: 700; z-index: 100000; background: var(--bg-card); color: var(--text-main); border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; transition: all 0.3s; cursor: pointer; }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }
        .badge-success { background: #dcfce7; color: var(--success); }
        .badge-info { background: #e0e7ff; color: var(--primary); }
        .badge-danger { background: #fee2e2; color: var(--danger); }
        .badge-warning { background: #fef3c7; color: #d97706; }
        body.dark-mode .badge-success { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        body.dark-mode .badge-info { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
        body.dark-mode .badge-danger { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        body.dark-mode .badge-warning { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .yellow-section { background-color: var(--yellow-bg); border: 2px solid var(--yellow-border); border-radius: 20px; padding: 25px; color: var(--yellow-text); }
        .yellow-section h3 { color: var(--yellow-text) !important; }
        .yellow-section .btn-primary { background: var(--yellow-btn-bg); color: #fff; border: none; }
        .yellow-section .btn-primary:hover { background: var(--yellow-btn-hover); }
        .todo-item { display: flex; align-items: center; justify-content: space-between; background: var(--yellow-item-bg); padding: 15px; border-radius: 12px; border-right: 4px solid var(--yellow-item-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 10px; color: var(--yellow-item-text); }
        #generalNotesBox .todo-item { background: var(--bg-input); border-right: 4px solid var(--primary); color: var(--text-main); }
        .todo-item > div:first-child { flex: 1; min-width: 0; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; padding-left: 15px; white-space: pre-wrap; }
        .settings-section, .github-section { background: var(--bg-input); padding: 20px; border-radius: 18px; border: 1px solid var(--border-color); margin-top: 20px; color: var(--text-main); }
        .github-section { background: #1e293b; color: white; }
        .github-section h3, .github-section h3 i { color: white !important; }
        .github-section label { color: #94a3b8; }
        .github-section input { background: #334155; border-color: #475569; color: white; }
        .security-status-active { color: var(--success); font-weight: bold; }
        .security-status-banned { color: var(--danger); font-weight: bold; }

        /* --- CUSTOM DIALOG MODALS (replaces confirm/prompt) --- */
        .dialog-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index: 500000; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(4px); animation: fadeIn 0.2s; }
        .dialog-box { background: var(--bg-card); border-radius: 24px; padding: 30px; width: 90%; max-width: 420px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); border: 1px solid var(--border-color); animation: slideUp 0.2s forwards; text-align: center; }
        .dialog-box h3 { margin-top: 0; font-size: 18px; }
        .dialog-box p { color: var(--text-muted); margin-bottom: 20px; font-size: 14px; }
        .dialog-icon { font-size: 42px; margin-bottom: 12px; }
        .dialog-actions { display: flex; gap: 10px; margin-top: 20px; }
        .dialog-actions .btn { flex: 1; padding: 12px; }
        .dialog-input { width: 100%; margin: 10px 0 5px 0; }

        /* --- GLOBAL SEARCH --- */
        #globalSearchWrap { position: fixed; top: max(15px, env(safe-area-inset-top)); left: 80px; z-index: 99000; }
        #globalSearchWrap input { width: 260px; padding: 10px 40px 10px 16px; border-radius: 50px; border: 1.5px solid var(--border-color); background: var(--bg-card); color: var(--text-main); font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s; }
        #globalSearchWrap input:focus { border-color: var(--primary); width: 320px; box-shadow: 0 4px 20px rgba(99,102,241,0.2); }
        #globalSearchWrap .srch-icon { position:absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        #globalSearchResults { position: absolute; top: calc(100% + 8px); left: 0; width: 360px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); max-height: 380px; overflow-y: auto; display: none; }
        #globalSearchResults .sr-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s; font-size: 13px; text-align: right; }
        #globalSearchResults .sr-item:hover { background: var(--bg-input); }
        #globalSearchResults .sr-item:last-child { border-bottom: none; }
        #globalSearchResults .sr-tag { font-size: 10px; padding: 2px 7px; border-radius: 6px; background: #e0e7ff; color: var(--primary); font-weight: 700; display: inline-block; margin-left: 6px; }
        #globalSearchResults .sr-empty { padding: 20px; color: var(--text-muted); text-align: center; }
        @media (max-width: 768px) { #globalSearchWrap { display: none; } }

        /* --- PHONE VALIDATION INDICATOR --- */
        .phone-valid { border-color: var(--success) !important; }
        .phone-invalid { border-color: var(--danger) !important; }

        /* --- EXPORT BUTTONS --- */
        .btn-export-csv { background: #dcfce7; color: var(--success); }
        .btn-export-csv:hover { background: var(--success); color: white; }
        .btn-export-print { background: #e0e7ff; color: var(--primary); }
        .btn-export-print:hover { background: var(--primary); color: white; }
        body.dark-mode .btn-export-csv { background: rgba(16,185,129,0.2); color: #34d399; }
        body.dark-mode .btn-export-print { background: rgba(99,102,241,0.2); color: #818cf8; }

        /* --- EXPIRY BADGE on sidebar --- */
        .notif-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; background: var(--danger); color: white; border-radius: 50%; font-size: 11px; font-weight: 800; margin-right: auto; padding: 0 4px; }

        /* PRINT STYLES */
        @media print {
            .sidebar, .mobile-menu-btn, #syncStatus, #notification, #globalSearchWrap, #demoBanner { display: none !important; }
            .main-content { margin-right: 0 !important; padding: 10px !important; }
            .card { box-shadow: none !important; border: 1px solid #ddd !important; }
            .hidden { display: none !important; }
            #history { display: block !important; }
            .btn { display: none !important; }
        }

        /* DEMO MODE BANNER */
        #demoBanner { display:none; position:fixed; top:0; left:0; width:100%; height:8px; background:repeating-linear-gradient(45deg, #ef4444, #ef4444 10px, #b91c1c 10px, #b91c1c 20px); z-index:99999; }
        body.demo-mode #demoBanner { display:block; }
        body.demo-mode #syncStatus { background:#fee2e2; border-color:#ef4444; color:#b91c1c; }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); right: 0; }
            .sidebar.active { transform: translateX(0); }
            .sidebar-overlay.active { display: block; }
            .main-content { margin-right: 0; padding: 70px 15px 20px 15px; }
            .mobile-menu-btn { display: block !important; }
            .stats-grid { grid-template-columns: 1fr; }
            .card { padding: 20px 15px; }
            .card > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; gap: 15px !important; }
            .inner-box { display: flex !important; flex-direction: column !important; gap: 15px !important; }
            .input-group > div { display: flex !important; width: 100% !important; gap: 10px !important; }
            .input-group > div > input { flex: 1 !important; min-width: 0 !important; }
            .input-group > div > select { flex: 0 0 80px !important; width: 80px !important; }
            .settings-section > div, .github-section > div { grid-template-columns: 1fr !important; }
            th, td { font-size: 12px; padding: 10px 5px; }
            #syncStatus { top: 15px; left: 15px; }
            .modal-content { width: 95%; margin: 10px; padding: 20px; }
        }
    </style>
</head>

<body class="locked">

<div id="demoBanner" title="ูุถุน ุชุฌุฑูุจู (ุงูุจูุงูุงุช ูุง ุชุญูุธ)"></div>
<div id="syncStatus" onclick="pushToGithub()"><i class="fas fa-cloud"></i> <span>ุฌุงุฑู ุงูุชุญููู...</span></div>

<div id="loginLayer" class="login-overlay">
    
    <div class="login-theme-toggle">
        <input type="checkbox" id="loginThemeCheck" onchange="toggleDarkMode()">
        <label for="loginThemeCheck"><i class="fas fa-adjust"></i></label>
    </div>

    <div id="cloudSetupCard" class="login-card hidden">
        <div class="login-icon-wrap"><i class="fas fa-cloud-upload-alt"></i></div>
        <h2>ุงูุฑุจุท ุงูุณุญุงุจู (ุฃูุงู)</h2>
        <p>ูุฌุจ ุฑุจุท ุงููุธุงู ุจู GitHub ุฃููุงู ูุฌูุจ ุจูุงูุงุช ุงููุณุชุฎุฏููู</p>
        
        <div class="custom-input">
            <input id="loginGhUser" placeholder="Github Username">
            <i class="fab fa-github"></i>
        </div>
        <div class="custom-input">
            <input id="loginGhRepo" placeholder="Repository Name">
            <i class="fas fa-folder"></i>
        </div>
        <div class="custom-input">
            <input id="loginGhToken" type="password" placeholder="Access Token">
            <i class="fas fa-key"></i>
        </div>
        
        <button class="btn-login" id="btnCloudSetup" onclick="setupCloudAndFetch()">
            <div class="loading-spinner"></div>
            <span><i class="fas fa-sync"></i> ุฑุจุท ููุฒุงููุฉ</span>
        </button>
        <p id="cloudMsg" style="margin-top:15px; font-size:12px; color:var(--text-muted)"></p>
    </div>

    <div id="loginCard" class="login-card hidden">
        <div class="login-icon-wrap"><i class="fas fa-shield-alt"></i></div>
        <h2>ุชุณุฌูู ุงูุฏุฎูู</h2>
        <p>ูุฑุฌู ุฅุฏุฎุงู ุจูุงูุงุช ุงูุงุนุชูุงุฏ ูููุชุงุจุนุฉ</p>
        
        <div class="custom-input">
            <input id="loginUser" placeholder="ุงุณู ุงููุณุชุฎุฏู">
            <i class="fas fa-user"></i>
        </div>
        <div class="custom-input">
            <input id="loginPass" type="password" placeholder="ูููุฉ ุงููุฑูุฑ">
            <i class="fas fa-lock"></i>
        </div>
        
        <button class="btn-login" id="btnLogin" onclick="attemptLogin()">
            <div class="loading-spinner"></div>
            <span><i class="fas fa-sign-in-alt"></i> ุฏุฎูู</span>
        </button>
    </div>

</div>

<div id="detailsModal" class="modal-overlay hidden" onclick="closeModal(event)">
    <div class="modal-content">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px;">ุชูุงุตูู ุงูุญุฑูุฉ</h3>
        <div id="modalBody"></div>
        <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="closeModal('force')">ุฅุบูุงู</button>
    </div>
</div>

<button class="mobile-menu-btn" id="menuBtn" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
</button>

<!-- GLOBAL SEARCH -->
<div id="globalSearchWrap" style="display:none; position: relative;">
    <input id="globalSearchInput" placeholder="ุจุญุซ ุดุงูู..." oninput="runGlobalSearch()" onblur="setTimeout(()=>hideSearchResults(),200)">
    <i class="fas fa-search srch-icon"></i>
    <div id="globalSearchResults"></div>
</div>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- CUSTOM CONFIRM DIALOG -->
<div id="customConfirmDialog" class="dialog-modal" style="display:none;">
    <div class="dialog-box">
        <div id="cdIcon" class="dialog-icon"></div>
        <h3 id="cdTitle"></h3>
        <p id="cdMsg"></p>
        <div class="dialog-actions">
            <button id="cdOkBtn" class="btn btn-primary"></button>
            <button id="cdCancelBtn" class="btn btn-danger" onclick="resolveConfirm(false)"></button>
        </div>
    </div>
</div>

<!-- CUSTOM PROMPT DIALOG -->
<div id="customPromptDialog" class="dialog-modal" style="display:none;">
    <div class="dialog-box">
        <div id="pdIcon" class="dialog-icon">โ๏ธ</div>
        <h3 id="pdTitle"></h3>
        <p id="pdMsg"></p>
        <input id="pdInput" class="dialog-input" placeholder="">
        <div class="dialog-actions">
            <button class="btn btn-primary" onclick="resolvePrompt(true)">ุชุฃููุฏ</button>
            <button class="btn" style="background:transparent; border:1px solid var(--border-color); color:var(--text-muted);" onclick="resolvePrompt(false)">ุฅูุบุงุก</button>
        </div>
    </div>
</div>

<!-- PURCHASE CONFIRMATION MODAL -->
<div id="purchaseConfirmModal" class="dialog-modal" style="display:none;">
    <div class="dialog-box" style="text-align:right; max-width:480px">
        <div style="text-align:center; font-size:36px; margin-bottom:10px">๐</div>
        <h3 style="text-align:center; margin-top:0">ุชุฃููุฏ ุงูุนูููุฉ</h3>
        <div id="purchaseConfirmBody" style="background:var(--bg-input); border-radius:14px; padding:15px; margin:15px 0; font-size:13px; line-height:2;"></div>
        <div class="dialog-actions">
            <button class="btn btn-primary" id="purchaseConfirmOkBtn">โ ุฅุชูุงู ูุญูุธ</button>
            <button class="btn btn-danger" onclick="document.getElementById('purchaseConfirmModal').style.display='none'">ุฅูุบุงุก</button>
        </div>
    </div>
</div>

<div class="sidebar" id="mySidebar">
    <div class="brand"><i class="fas fa-rocket"></i> MEGA STORE</div>
    <div class="theme-switch-container">
        <i class="fas fa-moon"></i>
        <label class="theme-switch"><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"><span class="slider"></span></label>
        <i class="fas fa-sun"></i>
    </div>
    <div id="currentUserDisplay" style="text-align:center; padding: 10px; font-size:12px; color: var(--text-muted);"></div>

    <div class="menu-items">
        <button onclick="showPage('purchase', this)" class="active" id="btnPurchase"><i class="fas fa-shopping-cart"></i> ุนูููุฉ ุดุฑุงุก</button>
        <button onclick="showPage('stock', this)" id="btnStock" class="hidden"><i class="fas fa-cubes"></i> ุงููุฎุฒูู</button>
        <button onclick="showPage('expiring', this)" id="btnExpiring"><i class="fas fa-hourglass-half"></i> ุชูุจููุงุช ุงูุงูุชูุงุก <span id="expiryBadge" class="notif-badge" style="display:none"></span></button>
        <button onclick="showPage('wallets', this)" id="btnWallets"><i class="fas fa-wallet"></i> ุฃุฑุตุฏุฉ ุงููุญุงูุธ</button>
        <button onclick="showPage('history', this)" id="btnHistory"><i class="fas fa-history"></i> ุณุฌู ุงูุนูููุงุช</button>
        <button onclick="showPage('analytics', this)" id="btnAnalytics"><i class="fas fa-chart-bar"></i> ุงูุฅุญุตุงุฆูุงุช</button>
        <button onclick="showPage('investment', this)" id="btnInvestment"><i class="fas fa-chart-line"></i> ุชูุฒูุน ุงูุฃุฑุจุงุญ</button>
        <button onclick="showPage('generalNotes', this)" id="btnNotes"><i class="fas fa-sticky-note"></i> ููุงุญุธุงุช</button>
        <button onclick="showPage('security', this)" id="btnSecurity" class="hidden"><i class="fas fa-user-shield"></i> ุงูุฃูุงู ูุงููุณุชุฎุฏููู</button>
        <button onclick="showPage('logs', this)" id="btnLogs" class="hidden"><i class="fas fa-clipboard-list"></i> ุญุฑูุงุช ุงููููุน</button>
        <button onclick="showPage('backup', this)" id="btnBackup"><i class="fas fa-database"></i> ุงููุณุฎ ุงูุงุญุชูุงุทู</button>
        <button onclick="showPage('modify', this)" id="btnSettings"><i class="fas fa-cog"></i> ุงูุฅุนุฏุงุฏุงุช</button>
        <button onclick="logout()" style="color:var(--danger)"><i class="fas fa-sign-out-alt"></i> ุชุณุฌูู ุฎุฑูุฌ</button>
    </div>
</div>

<div class="main-content">
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e0e7ff; color: var(--primary);"><i class="fas fa-dollar-sign"></i></div>
            <div><label>ุฅุฌูุงูู ุงูุฏููุงุฑ</label><div id="statDollar" style="font-size: 20px; font-weight: 800;">0.00 $</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #dcfce7; color: var(--success);"><i class="fas fa-coins"></i></div>
            <div><label>ุฅุฌูุงูู ุงูุดููู</label><div id="statShekel" style="font-size: 20px; font-weight: 800;">0.00 โช</div></div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #fef3c7; color: var(--accent);"><i class="fas fa-shopping-bag"></i></div>
            <div><label>ุนูููุงุช ุงูููู</label><div id="statSales" style="font-size: 20px; font-weight: 800;">0</div></div>
        </div>
    </div>

    <div id="notification"></div>

    <div id="purchase" class="card">
        <h3><i class="fas fa-cart-plus"></i> ุชุณุฌูู ุงุดุชุฑุงู ุฌุฏูุฏ</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group"><label>ููุน ุงูุงุดุชุฑุงู</label><input id="sub" placeholder="ูุซุงู: ููุชููููุณุ ููุชููุจ..."></div>
            <div class="input-group"><label>ุงุณู ุงูุนููู</label><input id="customer" placeholder="ุงุณู ุงูุนููู"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group"><label>ุฑูู ุฌูุงู ุงูุนููู</label><input id="customerPhone" placeholder="059xxxxxxx" oninput="validatePhoneInput(this)"></div>
            <div class="input-group"><label>ูุฏุฉ ุงูุงุดุชุฑุงู</label>
                <select id="subDuration">
                    <option value="1">1 ุดูุฑ</option><option value="2">2 ุดูุฑ</option><option value="3">3 ุดููุฑ</option><option value="4">4 ุดููุฑ</option><option value="5">5 ุดููุฑ</option><option value="6">6 ุดููุฑ</option><option value="7">7 ุดููุฑ</option><option value="8">8 ุดููุฑ</option><option value="9">9 ุดููุฑ</option><option value="10">10 ุดููุฑ</option><option value="11">11 ุดูุฑ</option><option value="12">12 ุดูุฑ (ุณูุฉ)</option>
                </select>
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
            <div class="input-group"><label>ุงููุจูุบ ุงููุฏููุน ูู ุงูุนููู</label><div style="display:flex; gap:10px"><input type="number" id="paidAmount" placeholder="0.00"><select id="paidCurrency" style="width:120px"><option value="โช">โช ุดููู</option><option value="$">$ ุฏููุงุฑ</option></select></div></div>
            <div class="input-group"><label>ุงูุชูููุฉ ุนูููุง</label><div style="display:flex; gap:10px"><input type="number" id="costAmount" placeholder="0.00"><select id="costCurrency" style="width:120px"><option value="$">$ ุฏููุงุฑ</option><option value="โช">โช ุดููู</option></select></div></div>
        </div>
        <div class="inner-box" style="padding: 25px; border-radius: 18px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-style: dashed;">
            <div><label>ููุฎุตู ูู ูุญูุธุฉ (ุงููุตุฏุฑ):</label><select id="fromWallet"></select></div>
            <div><label>ูููุฏุน ุงูุฑุจุญ ูู ูุญูุธุฉ:</label><select id="wallet"></select></div>
        </div>
        <button class="btn btn-primary" id="btnSubmitPurchase" style="width:100%; margin-top:30px; padding: 16px;" onclick="addPurchase()"><i class="fas fa-check-circle"></i> ุฅุชูุงู ุงูุนูููุฉ ูุญูุธ ุงูุจูุงูุงุช</button>
    </div>

    <div id="security" class="card hidden">
        <h3><i class="fas fa-user-shield"></i> ุฅุฏุงุฑุฉ ุงูุฃูุงู ูุงููุณุชุฎุฏููู</h3>
        <div class="inner-box" style="padding:25px; border-radius:20px; margin-bottom:30px;">
            <h4><i class="fas fa-user-plus"></i> ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
                <input id="newUserName" placeholder="ุงุณู ุงููุณุชุฎุฏู" style="border-radius:12px">
                <input id="newUserPass" placeholder="ูููุฉ ุงููุฑูุฑ" style="border-radius:12px">
                <select id="newUserRole" style="border-radius:12px">
                    <option value="viewer">ูุดุงูุฏ ุนุงุฏู (ูููุฏ)</option>
                    <option value="viewer_plus">ูุดุงูุฏ ูุชูุฏู</option>
                    <option value="employee">ููุธู (Employee)</option>
                    <option value="admin">ุฃุฏูู (Admin)</option>
                </select>
                <button class="btn btn-primary" onclick="addNewUser()">ุฅุถุงูุฉ</button>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>ุงุณู ุงููุณุชุฎุฏู</th><th>ุงูุตูุงุญูุฉ</th><th>ุงูุญุงูุฉ</th><th>ุขุฎุฑ ุฏุฎูู</th><th>ุงูุฌูุงุฒ</th><th>ุชุญูู</th></tr></thead>
                <tbody id="usersTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="logs" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h3><i class="fas fa-clipboard-list"></i> ุณุฌู ุญุฑูุงุช ุงููููุน (Audit Log)</h3>
            <div style="display:flex; gap:10px">
                <button id="btnVisLogs" class="btn btn-warning hidden" onclick="changeLogsVis()" style="padding: 8px 15px; font-size:13px"><i class="fas fa-eye"></i> ุฅุนุฏุงุฏุงุช ุงูุธููุฑ</button>
                <button id="btnClearLogs" class="btn btn-danger hidden" onclick="clearLogs()" style="padding: 8px 15px; font-size:13px"><i class="fas fa-trash"></i> ูุณุญ ุงูุณุฌู</button>
            </div>
        </div>
        
        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="logsSearch" onkeyup="refreshLogs()" placeholder="ุจุญุซ ูู ุงูุณุฌู..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th style="width:200px">ุงูุชุงุฑูุฎ ูุงูููุช</th><th style="width:150px">ุงููุณุชุฎุฏู</th><th>ุชูุงุตูู ุงูุญุฑูุฉ</th><th>ุนุฑุถ</th></tr></thead>
                <tbody id="logsTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="expiring" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin-bottom:0"><i class="fas fa-hourglass-half"></i> ุงุดุชุฑุงูุงุช ุชูุชูู ูุฑูุจุงู</h3>
            <button id="btnHideExpired" class="btn btn-danger" onclick="deleteExpired()" style="padding: 8px 15px; font-size:13px; background:#ef4444; color:white;"><i class="fas fa-eye-slash"></i> ุฅุฎูุงุก ุงูููุชูู</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>ุงูุฎุฏูุฉ</th><th>ุงุณู ุงูุนููู</th><th>ุฑูู ุงูุฌูุงู</th><th>ููุชูู ุจุชุงุฑูุฎ</th><th>ุงููุชุจูู</th><th>ูุฑุงุณูุฉ</th></tr></thead>
                <tbody id="expiringBody"></tbody>
            </table>
        </div>
    </div>

    <div id="stock" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h3 style="margin-bottom:0"><i class="fas fa-cubes"></i> ุงููุฎุฒูู (ุงุดุชุฑุงูุงุช ูุชููุฑุฉ)</h3>
            <button class="btn btn-primary" onclick="openAddStockModal()"><i class="fas fa-plus"></i> ุฅุถุงูุฉ</button>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>ุงูุฎุฏูุฉ</th><th>ุชุงุฑูุฎ ุงูุดุฑุงุก</th><th>ุงููุฏุฉ</th><th>ูุชุจูู (ููู)</th><th>ุชูุงุตูู</th><th>ุจูุน</th></tr></thead>
                <tbody id="stockBody"></tbody>
            </table>
        </div>
    </div>

    <div id="analytics" class="card hidden">
        <h3><i class="fas fa-chart-bar"></i> ุงูุฅุญุตุงุฆูุงุช</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px;">
            <div class="inner-box" style="padding: 20px; border-radius: 20px;"><div class="chart-wrapper"><canvas id="profitChart"></canvas></div></div>
            <div class="inner-box" style="padding: 20px; border-radius: 20px;"><div class="chart-wrapper"><canvas id="salesChart"></canvas></div></div>
        </div>
    </div>

    <div id="wallets" class="card hidden">
        <h3><i class="fas fa-wallet"></i> ุชูุฒูุน ุงูุณูููุฉ</h3>
        <div class="table-container">
            <table>
                <thead><tr><th>ุงููุญูุธุฉ</th><th>ุงูุนููุฉ</th><th style="text-align:center">ุงูุฑุตูุฏ</th><th>ุงูุญุงูุฉ</th></tr></thead>
                <tbody id="walletList"></tbody>
            </table>
        </div>
    </div>

    <div id="history" class="card hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
            <h3><i class="fas fa-list-ul"></i> ุงูุฃุฑุดูู ุงููุงูู</h3>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button class="btn btn-export-csv" onclick="exportHistoryCSV()" title="ุชุตุฏูุฑ CSV"><i class="fas fa-file-csv"></i> Excel</button>
                <button class="btn btn-export-print" onclick="printHistory()" title="ุทุจุงุนุฉ / PDF"><i class="fas fa-print"></i> PDF</button>
                <button id="btnUndo" class="btn btn-primary" onclick="undoLastPurchase()"><i class="fas fa-undo"></i> ุชุฑุงุฌุน</button>
                <button id="btnClearHistory" class="btn btn-danger" onclick="clearHistory()"><i class="fas fa-trash"></i> ูุณุญ ุงููู</button>
            </div>
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <div style="position:relative;">
                <input id="historySearch" onkeyup="filterHistory()" placeholder="ุงุจุญุซ ุจุงุณู ุงูุนููู..." style="padding-right: 40px;">
                <i class="fas fa-search" style="position:absolute; right:15px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
            </div>
        </div>
        <div class="table-container">
            <table>
                <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุนููู</th><th>ุงูุฌูุงู</th><th>ุงูุฎุฏูุฉ</th><th>ุงููุฏุฉ</th><th>ุงูุฏูุน</th><th>ุงูุชูููุฉ</th><th>ุงููุญูุธุฉ</th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <div id="investment" class="card hidden">
        <h3><i class="fas fa-chart-pie"></i> ุญุตุต ุงูุดุฑูุงุก</h3>
        <div id="investBox" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;"></div>
        <div class="inner-box" style="margin-top:40px; padding:30px; border-radius:20px;">
            <h4 style="margin-top:0; color:var(--danger)"><i class="fas fa-external-link-alt"></i> ุทูุจ ุณุญุจ ุฃุฑุจุงุญ</h4>
            <div style="margin-bottom:15px; font-size:13px; color:var(--text-muted);">
                <i class="fas fa-info-circle"></i> <b>ุชูุจูู:</b> ุงููุจูุบ ุณูุชู ุฎุตูู ุชููุงุฆูุงู ุจููุณ ุนููุฉ ุงููุญูุธุฉ ุงููุฎุชุงุฑุฉ.
            </div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                
                <div class="input-group">
                    <label>ุณุญุจ ูู ุญุตุฉ ุฃุญูุฏ</label>
                    <div style="display:flex; flex-direction:column; gap:8px">
                        <select id="wWalletAhmad" style="width:100%"><option value="">ุงุฎุชุฑ ูุญูุธุฉ ุงูุณุญุจ</option></select>
                        <div style="display:flex; gap:5px">
                            <input id="withdrawAhmad" type="number" placeholder="0.00" style="width:100%">
                        </div>
                        <button class="btn btn-danger" onclick="withdrawPartial('ahmad')" style="width:100%">ุณุญุจ</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>ุณุญุจ ูู ุญุตุฉ ูุญูุฏ</label>
                    <div style="display:flex; flex-direction:column; gap:8px">
                        <select id="wWalletMohamed" style="width:100%"><option value="">ุงุฎุชุฑ ูุญูุธุฉ ุงูุณุญุจ</option></select>
                        <div style="display:flex; gap:5px">
                            <input id="withdrawMohamed" type="number" placeholder="0.00" style="width:100%">
                        </div>
                        <button class="btn btn-danger" onclick="withdrawPartial('mohamed')" style="width:100%">ุณุญุจ</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>ุณุญุจ ูู ุญุตุฉ ุงููุชุฌุฑ</label>
                    <div style="display:flex; flex-direction:column; gap:8px">
                        <select id="wWalletStore" style="width:100%"><option value="">ุงุฎุชุฑ ูุญูุธุฉ ุงูุณุญุจ</option></select>
                        <div style="display:flex; gap:5px">
                            <input id="withdrawStore" type="number" placeholder="0.00" style="width:100%">
                        </div>
                        <button class="btn btn-danger" onclick="withdrawPartial('store')" style="width:100%">ุณุญุจ</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="modify" class="card hidden">
        
        <div id="demo-mode-section" style="background: linear-gradient(135deg, #1e293b, #0f172a); color: white; padding: 20px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="color: white; margin-bottom: 5px;"><i class="fas fa-flask"></i> ุงููุถุน ุงูุชุฌุฑูุจู (Sandbox)</h3>
                    <p style="font-size: 13px; color: #94a3b8; margin: 0;">ุนูุฏ ุงูุชูุนููุ ุชุชููู ุงููุฒุงููุฉ ุงูุณุญุงุจูุฉ ููุงุฆูุงู. ููููู ุงูุชุฌุฑุจุฉ ุจุญุฑูุฉ. ุนูุฏ ุงูุฅููุงูุ ุณูุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ููุณุญ ุงูุชุบููุฑุงุช.</p>
                </div>
                <label class="theme-switch" style="width: 60px; height: 30px;">
                    <input type="checkbox" id="demoModeToggle" onchange="toggleDemoMode()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h3><i class="fas fa-key"></i> ุชุบููุฑ ูููุฉ ุงููุฑูุฑ</h3>
        <div class="inner-box" style="padding:20px; border-radius:15px; margin-bottom:40px">
            <input type="password" id="changePassInput" placeholder="ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ" style="margin-bottom:10px">
            <button class="btn btn-primary" onclick="changeMyPassword()">ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ</button>
        </div>

        <div id="sec-manual-wallet">
            <h3 style="margin-top:0"><i class="fas fa-exchange-alt"></i> ุงูุชุญููู ุจูู ุงููุญุงูุธ</h3>
            
            <div class="inner-box" style="padding:20px; border-radius:15px; margin-bottom:40px">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px">
                    <div class="input-group"><label>ูู ูุญูุธุฉ (ุงููุตุฏุฑ)</label><select id="tfFromWallet"></select></div>
                    <div class="input-group"><label>ุฅูู ูุญูุธุฉ (ุงููุณุชูู)</label><select id="tfToWallet"></select></div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:15px">
                    <div class="input-group"><label>ุงููุจูุบ ุงููุฑุงุฏ ุชุญูููู</label><input type="number" id="tfAmount" placeholder="0.00" oninput="calculateTransfer()"></div>
                    <div class="input-group">
                        <label>ุนูููุฉ ุงูุชุญููู (ุชุฎุตู ูู ุงููุตุฏุฑ)</label>
                        <input type="number" id="tfFee" placeholder="0.00" value="0" oninput="calculateTransfer()">
                        <small style="color:var(--text-muted)">ุณูุชู ุฎุตู ููุณ ุงููููุฉ ูู ุฃุฑุจุงุญ ุงููุชุฌุฑ ุจููุณ ุงูุนููุฉ.</small>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom:15px">
                    <label>ุณุนุฑ ุงูุฏููุงุฑ ููุงุจู ุงูุดููู (1$ = ุ โช)</label>
                    <input type="number" id="tfRate" placeholder="ุฃุฏุฎู ุงูุณุนุฑ (ูุซูุงู 3.15)" value="1" oninput="calculateTransfer()">
                    <small style="color:var(--text-muted)">ุณูููู ุงููุธุงู ุจุญุณุงุจ ุงูุชุญููู ุชููุงุฆูุงู ุจูุงุกู ุนูู ุงูุนููุงุช.</small>
                </div>

                <div class="input-group" style="background:var(--yellow-bg); padding:15px; border-radius:12px; border:1px solid var(--yellow-border);">
                    <label style="color:var(--yellow-text)">ุงููุงุชุฌ ุงูููุงุฆู (ูู ูุญูุธุฉ ุงููุณุชูู)</label>
                    <input type="number" id="tfResult" placeholder="0.00" readonly>
                </div>

                <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="executeTransfer()">ุฅุชูุงู ุงูุชุญููู</button>
            </div>
        </div>

        <div id="sec-set-wallet-balance">
            <h3 style="margin-top:40px"><i class="fas fa-edit"></i> ุชุนููู ุฑุตูุฏ ูุญูุธุฉ ูุจุงุดุฑ</h3>
            <div style="display:flex; gap:10px; align-items:flex-end">
                <div class="input-group" style="flex:1"><label>ุงููุญูุธุฉ</label><select id="modWallet"></select></div>
                <div class="input-group" style="flex:1"><label>ุงูุฑุตูุฏ ุงูุฌุฏูุฏ</label><input id="modAmount" type="number" placeholder="0.00"></div>
                <button class="btn btn-primary" style="background:#0ea5e9; height:48px; margin-bottom:15px" onclick="setWallet()">ุชุนููู</button>
                <button class="btn btn-danger" style="height:48px; margin-bottom:15px" onclick="deleteWallet()"><i class="fas fa-trash"></i></button>
            </div>
        </div>

        <div id="sec-set-profit-share" style="margin-top:40px;">
            <h3><i class="fas fa-hand-holding-usd"></i> ุชุนููู ุญุตุฉ ุดุฑูู ูุจุงุดุฑ</h3>
            <div class="inner-box" style="padding:20px; border-radius:15px; margin-bottom:40px; border: 1px dashed var(--primary);">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end">
                    <div class="input-group" style="flex:1; min-width:150px">
                        <label>ุงูุดุฑูู / ุงูุฌูุฉ</label>
                        <select id="setSharePerson">
                            <option value="ahmad">ุฃุญูุฏ</option>
                            <option value="mohamed">ูุญูุฏ</option>
                            <option value="store">ุงููุชุฌุฑ</option>
                        </select>
                    </div>
                    <div class="input-group" style="width:100px">
                        <label>ุงูุนููุฉ</label>
                        <select id="setShareCurrency">
                            <option value="d">ุฏููุงุฑ $</option>
                            <option value="s">ุดููู โช</option>
                        </select>
                    </div>
                    <div class="input-group" style="flex:1; min-width:150px">
                        <label>ุงูุฑุตูุฏ ุงูุฌุฏูุฏ ููุญุตุฉ</label>
                        <input id="setShareAmount" type="number" placeholder="0.00">
                    </div>
                    <button class="btn btn-primary" style="height:48px; margin-bottom:15px" onclick="setProfitShare()">ุชุญุฏูุซ ุงูุญุตุฉ</button>
                </div>
            </div>
        </div>

        <div id="sec-manage-wallets">
            <h3><i class="fas fa-plus-circle"></i> ุฅุฏุงุฑุฉ ุงููุญุงูุธ</h3>
            <div class="inner-box" style="display:flex; gap:15px; padding:20px; border-radius:15px; margin-bottom:40px">
                <input id="newWalletName" placeholder="ุงุณู ุงููุญูุธุฉ ุงูุฌุฏูุฏุฉ">
                <select id="newWalletCurrency" style="width:150px"><option value="$">$ ุฏููุงุฑ</option><option value="โช">โช ุดููู</option></select>
                <button class="btn btn-primary" onclick="addNewWallet()">ุฅูุดุงุก</button>
            </div>
        </div>

        <div id="sec-rename-wallet">
            <h3><i class="fas fa-edit"></i> ุชุนุฏูู ุงุณู ูุญูุธุฉ</h3>
            <div class="inner-box" style="display:flex; gap:15px; padding:20px; border-radius:15px; margin-bottom:40px">
                <select id="renameWalletSelect" style="width:200px"></select>
                <input id="renameWalletInput" placeholder="ุงูุงุณู ุงูุฌุฏูุฏ ูููุญูุธุฉ">
                <button class="btn btn-warning" onclick="renameWallet()">ุชุบููุฑ ุงูุงุณู</button>
            </div>
        </div>

        <div id="sec-profit-settings">
            <h3><i class="fas fa-percent"></i> ุฅุนุฏุงุฏุงุช ุชูุฒูุน ุงูุฃุฑุจุงุญ</h3>
            <div class="settings-section" style="margin-bottom:40px; margin-top:0;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div class="input-group"><label>ูุณุจุฉ ุฃุญูุฏ (%)</label><input type="number" id="setAhmadProp" placeholder="35"></div>
                    <div class="input-group"><label>ูุณุจุฉ ูุญูุฏ (%)</label><input type="number" id="setMohamedProp" placeholder="35"></div>
                    <div class="input-group"><label>ูุณุจุฉ ุงููุชุฌุฑ (%)</label><input type="number" id="setStoreProp" placeholder="30"></div>
                </div>
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="setDeductCost" style="width: 20px; height: 20px;">
                    <label for="setDeductCost" style="margin-bottom: 0;">ุฎุตู ุงูุชูุงููู ูู ุงูุฅุฌูุงูู ูุจู ุชูุฒูุน ุงูุฑุจุญุ</label>
                </div>
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border-color);">
                <div class="input-group">
                    <label>ุณุนุฑ ุตุฑู ุงูุฏููุงุฑ ุงูุซุงุจุช (ููุงุจู ุงูุดููู)</label>
                    <div style="display:flex; align-items:center; gap:10px">
                        <input type="number" id="setExchangeRate" placeholder="ุฃุฏุฎู ุงูุณุนุฑ (ูุซูุงู 3.5)">
                        <small style="color:var(--text-muted); width: 100%;">ุงุชุฑูู 0 ุฃู ูุงุฑุบุงู ููุณุคุงู ูู ูุฑุฉ.</small>
                    </div>
                </div>
                <button class="btn btn-primary" style="margin-top: 20px;" onclick="saveProfitSettings()">ุญูุธ ุฅุนุฏุงุฏุงุช ุงููุธุงู</button>
            </div>
        </div>

        <div class="github-section" style="margin-bottom:40px; margin-top:0;">
            <h3><i class="fab fa-github"></i> ุฅุนุฏุงุฏุงุช ุงูุฑุจุท ุงูุณุญุงุจู (GitHub)</h3>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px">
                <div class="input-group"><label>ุงุณู ุงููุณุชุฎุฏู</label><input id="ghUser"></div>
                <div class="input-group"><label>ุงููุณุชูุฏุน</label><input id="ghRepo"></div>
                <div class="input-group"><label>Token</label><input id="ghToken" type="password"></div>
                <div class="input-group"><label>ุงุณู ุงูููู</label><input id="ghFile" value="db.json"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button class="btn btn-primary" onclick="saveGithubSettings()">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
                <button class="btn btn-warning" onclick="fetchFromGithub()"><i class="fas fa-download"></i> ุณุญุจ</button>
                <button class="btn btn-success" style="background:var(--success); color:#fff" onclick="pushToGithub()"><i class="fas fa-upload"></i> ุฑูุน</button>
            </div>
        </div>

        <div class="yellow-section" id="sec-todo">
            <h3><i class="fas fa-tasks"></i> ูุงุฆูุฉ ุงูููุงู (To-Do)</h3>
            <div style="display:flex; gap:15px; margin-bottom:20px">
                <input id="todoInput" placeholder="ุงูุชุจ ุงููููุฉ...">
                <button class="btn btn-primary" onclick="addTodo()">ุฅุถุงูุฉ</button>
            </div>
            <div id="todoBox"></div>
        </div>
    </div>

    <div id="generalNotes" class="card hidden">
        <h3><i class="fas fa-pen-fancy"></i> ุงููููุฑุฉ</h3>
        <div style="display:flex; gap:15px">
            <textarea id="gnText" placeholder="ุงูุชุจ ููุงุญุธุฉ..." style="height: 60px;"></textarea>
            <button class="btn btn-primary" onclick="addGeneralNote()">ุญูุธ</button>
        </div>
        <div id="generalNotesBox" style="margin-top:30px;"></div>
    </div>

    <div id="backup" class="card hidden">
        <h3><i class="fas fa-shield-alt"></i> ุญูุงูุฉ ุงูุจูุงูุงุช</h3>
        <div style="text-align:center; padding:40px; border:2px dashed var(--border-color); border-radius:30px">
            <i class="fas fa-cloud-download-alt" style="font-size:50px; color:var(--primary); margin-bottom:20px"></i>
            <p style="color:var(--text-main)">ุงุญุชูุธ ุจูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ุจูุงูุงุชู ุฏุงุฆูุงู.</p>
            <button class="btn btn-primary" onclick="exportData()"><i class="fas fa-download"></i> ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</button>
            <div style="margin: 30px 0; border-top:1px solid var(--border-color)"></div>
            <div class="inner-box" style="border:none; padding:0; display:flex; gap:15px; align-items:center;">
                <input type="file" id="importFile" style="width:auto; margin-bottom:10px">
                <button class="btn btn-danger" style="background:var(--bg-input); color:var(--text-muted); border:1px solid var(--border-color)" onclick="importData()">ุงุณุชุนุงุฏุฉ ุจูุงูุงุช</button>
            </div>
        </div>
    </div>

</div>

<div id="editUserModal" class="modal-overlay hidden" onclick="closeEditUserModal(event)">
    <div class="modal-content">
        <h3 style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px;"><i class="fas fa-user-edit"></i> ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏู</h3>
        <input type="hidden" id="editUserIndex">
        <div class="input-group"><label>ุงุณู ุงููุณุชุฎุฏู</label><input id="editUserName" readonly style="background:#f1f5f9; color:#94a3b8"></div>
        <div class="input-group"><label>ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label><input id="editUserPassInput" type="password" placeholder="ุงุชุฑูู ูุงุฑุบุงู ูุนุฏู ุงูุชุบููุฑ"></div>
        <div class="input-group"><label>ุงูุตูุงุญูุฉ</label>
            <select id="editUserRoleSelect">
                <option value="viewer">ูุดุงูุฏ ุนุงุฏู (ูููุฏ)</option>
                <option value="viewer_plus">ูุดุงูุฏ ูุชูุฏู</option>
                <option value="employee">ููุธู</option>
                <option value="admin">ุฃุฏูู</option>
            </select>
        </div>
        <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="saveUserEdit()"><i class="fas fa-save"></i> ุญูุธ ุงูุชุนุฏููุงุช</button>
        <button class="btn" style="width:100%; margin-top:10px; background:transparent; color:var(--text-muted); border:1px solid var(--border-color)" onclick="closeEditUserModal('force')">ุฅูุบุงุก</button>
    </div>
</div>

<div id="stockModal" class="modal-overlay hidden" onclick="closeStockModal(event)">
    <div class="modal-content">
        <h3 id="stockModalTitle" style="margin-top:0; border-bottom:1px solid var(--border-color); padding-bottom:15px;">ุฅุถุงูุฉ ุงุดุชุฑุงู ูููุฎุฒูู</h3>
        <input type="hidden" id="stockIndex">
        <div class="input-group"><label>ููุน ุงูุฎุฏูุฉ</label><input id="stService" placeholder="ูุซุงู: ููุชููููุณ"></div>
        <div class="input-group"><label>ูุฏุฉ ุงูุงุดุชุฑุงู (ุจุงูุฃุดูุฑ)</label>
            <select id="stDuration"><option value="1">1 ุดูุฑ</option><option value="2">2 ุดูุฑ</option><option value="3">3 ุดููุฑ</option><option value="6">6 ุดููุฑ</option><option value="12">12 ุดูุฑ</option></select>
        </div>
        <div class="input-group"><label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label><input id="stEmail" placeholder="email@example.com"></div>
        <div class="input-group"><label>ูููุฉ ุงููุฑูุฑ</label><input id="stPass" placeholder="Password"></div>
        <div class="input-group"><label>ููุงุญุธุงุช ุฅุถุงููุฉ</label><textarea id="stNotes" style="height:80px" placeholder="ุฃู ุชูุงุตูู..."></textarea></div>
        <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="saveStock()"><i class="fas fa-save"></i> ุญูุธ</button>
        <button class="btn" style="width:100%; margin-top:10px; background:transparent; color:var(--text-muted); border:1px solid var(--border-color)" onclick="closeStockModal('force')">ุฅูุบุงุก</button>
    </div>
</div>

<script>
const fix=n=>Number(n).toFixed(2);

// --- SAFE JSON PARSE (prevents crash if data is corrupted) ---
function safeJSON(str, fallback) {
    try { return str ? JSON.parse(str) : fallback; }
    catch(e) { console.warn("JSON parse error:", e); return fallback; }
}

// --- CUSTOM DIALOG SYSTEM (replaces browser confirm/prompt) ---
let _confirmResolve = null;
let _promptResolve = null;

function showConfirm(title, msg, okText = "ุชุฃููุฏ", cancelText = "ุฅูุบุงุก", icon = "โ๏ธ") {
    return new Promise(resolve => {
        _confirmResolve = resolve;
        document.getElementById("cdIcon").textContent = icon;
        document.getElementById("cdTitle").textContent = title;
        document.getElementById("cdMsg").textContent = msg;
        document.getElementById("cdOkBtn").textContent = okText;
        document.getElementById("cdCancelBtn").textContent = cancelText;
        document.getElementById("cdOkBtn").onclick = () => resolveConfirm(true);
        document.getElementById("customConfirmDialog").style.display = "flex";
    });
}
function resolveConfirm(val) {
    document.getElementById("customConfirmDialog").style.display = "none";
    if(_confirmResolve) { _confirmResolve(val); _confirmResolve = null; }
}

function showPrompt(title, msg = "", placeholder = "", icon = "โ๏ธ") {
    return new Promise(resolve => {
        _promptResolve = resolve;
        document.getElementById("pdIcon").textContent = icon;
        document.getElementById("pdTitle").textContent = title;
        document.getElementById("pdMsg").textContent = msg;
        document.getElementById("pdInput").placeholder = placeholder;
        document.getElementById("pdInput").value = "";
        document.getElementById("customPromptDialog").style.display = "flex";
        setTimeout(() => document.getElementById("pdInput").focus(), 100);
    });
}
function resolvePrompt(ok) {
    document.getElementById("customPromptDialog").style.display = "none";
    let val = ok ? document.getElementById("pdInput").value.trim() : null;
    if(_promptResolve) { _promptResolve(val); _promptResolve = null; }
}
// Allow Enter key in prompt
document.addEventListener("keydown", e => {
    if(e.key === "Enter") {
        if(document.getElementById("customPromptDialog").style.display === "flex") resolvePrompt(true);
        if(document.getElementById("customConfirmDialog").style.display === "flex") resolveConfirm(true);
    }
    if(e.key === "Escape") {
        if(document.getElementById("customPromptDialog").style.display === "flex") resolvePrompt(false);
        if(document.getElementById("customConfirmDialog").style.display === "flex") resolveConfirm(false);
        if(document.getElementById("purchaseConfirmModal").style.display === "flex") document.getElementById("purchaseConfirmModal").style.display = "none";
    }
});
let myProfitChart = null;
let mySalesChart = null;
let currentUser = null; 
let isDemoMode = false;
let syncTimer = null; 

let ghConfig = {
    user: localStorage.getItem("gh_user") || "",
    repo: localStorage.getItem("gh_repo") || "",
    token: localStorage.getItem("gh_token") || "",
    file: localStorage.getItem("gh_file") || "db.json",
    sha: ""
};

let isSyncing = false; 
let syncPending = false; 
let retryAttempt = 0;
const MAX_RETRIES = 10; 

const DEFAULT_USER = {
    username: "Mohamed Ahmed",
    password: "0000",
    role: "admin", 
    status: "active",
    lastLogin: "-",
    deviceInfo: "-"
};

// --- MODAL UTILS ---
function showModalDetails(details) {
    if(!details) return;
    const body = document.getElementById("modalBody");
    body.innerHTML = "";
    
    if(details.type === 'manual') {
        body.innerHTML += row("ุงูุนูููุฉ", "ุชุนุฏูู ุฑุตูุฏ ูุญูุธุฉ");
        body.innerHTML += row("ุงูุณุจุจ", details.reason);
        body.innerHTML += row("ุงููุญูุธุฉ", details.wallet);
        body.innerHTML += row("ุงูุฑุตูุฏ ุงูุณุงุจู", fix(details.before), false);
        body.innerHTML += row("ุงูุชุบููุฑ", (details.diff >= 0 ? "+"+details.diff : details.diff), true, details.diff >= 0);
        body.innerHTML += row("ุงูุฑุตูุฏ ุงูุฌุฏูุฏ", fix(details.after), false);
    } 
    else if(details.type === 'manual_invest') {
        body.innerHTML += row("ุงูุนูููุฉ", "ุชุนุฏูู ุญุตุฉ ุดุฑูู");
        body.innerHTML += row("ุงูุดุฑูู", details.person);
        body.innerHTML += row("ุงูุนููุฉ", details.currency === 'd' ? 'ุฏููุงุฑ' : 'ุดููู');
        body.innerHTML += row("ุงูุณุจุจ", details.reason);
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("ูุจู ุงูุชุนุฏูู", fix(details.before));
        body.innerHTML += row("ุจุนุฏ ุงูุชุนุฏูู", fix(details.after));
    }
    else if (details.type === 'transfer') {
        body.innerHTML += row("ุงูุนูููุฉ", "ุชุญููู ุฃุฑุตุฏุฉ");
        body.innerHTML += row("ูู", details.from);
        body.innerHTML += row("ุฅูู", details.to);
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("ุงููุจูุบ ุงูููู", details.amount + " (" + details.fromCur + ")");
        body.innerHTML += row("ุงูุนูููุฉ", details.fee + " (" + details.fromCur + ")", true, false);
        body.innerHTML += row("ุฎุตู ุงูุนูููุฉ ูู", "ุญุตุฉ ุงููุชุฌุฑ (Capital)");
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += row("ุงูุตุงูู ููุชุญููู", details.netAmount);
        body.innerHTML += row("ุณุนุฑ ุงูุฏููุงุฑ", details.rate);
        body.innerHTML += row("ุงูููุฏุน (ูุณุชูู)", "+"+details.result + " (" + details.toCur + ")", true, true);
    } else if (details.type === 'purchase') {
        body.innerHTML += row("ุงูุนูููุฉ", "ุชุณุฌูู ุดุฑุงุก");
        body.innerHTML += row("ุงูุนููู", details.customer);
        body.innerHTML += row("ุงูุฎุฏูุฉ", details.sub);
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<h4>ุงููุญูุธุฉ ุงููุตุฏุฑ: ${details.wName}</h4>`;
        body.innerHTML += row("ูุจู ุงูุฎุตู", fix(details.wBefore));
        body.innerHTML += row("ุงููุฎุตูู", "-"+details.cost, true, false);
        body.innerHTML += row("ุจุนุฏ ุงูุฎุตู", fix(details.wAfter));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<h4>ุงููุญูุธุฉ ุงููุณุชููุฉ: ${details.toName}</h4>`;
        body.innerHTML += row("ูุจู ุงูุฅูุฏุงุน", fix(details.tBefore));
        body.innerHTML += row("ุงูููุจูุถ", "+"+details.paid, true, true);
        body.innerHTML += row("ุจุนุฏ ุงูุฅูุฏุงุน", fix(details.tAfter));
    } else if (details.type === 'withdraw') {
        body.innerHTML += row("ุงูุนูููุฉ", "ุณุญุจ ุฃุฑุจุงุญ");
        body.innerHTML += row("ุงูุดุฑูู/ุงูุฌูุฉ", details.person);
        body.innerHTML += row("ุงูุณุจุจ", details.reason);
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<h4>ูุญูุธุฉ ุงูุณุญุจ: ${details.walletName}</h4>`;
        body.innerHTML += row("ุงููุจูุบ ุงููุฎุตูู", "-"+fix(details.amount) + " " + (details.currency==='$'?'$':'โช'), true, false);
        body.innerHTML += row("ุฑุตูุฏ ุงููุญูุธุฉ ุจุนุฏ", fix(details.walletAfter));
        body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
        body.innerHTML += `<h4>ุฑุตูุฏ ุงูุญุตุฉ</h4>`;
        body.innerHTML += row("ูุจู ุงูุณุญุจ", fix(details.shareBefore));
        body.innerHTML += row("ุจุนุฏ ุงูุณุญุจ", fix(details.shareAfter));
        
    } else if (details.type === 'undo') {
        body.innerHTML += `<div style="text-align:center; color:var(--accent); margin-bottom:10px"><i class="fas fa-undo"></i> ุชุฑุงุฌุน ุนู ุนูููุฉ</div>`;
        body.innerHTML += `<p style="text-align:center; font-size:13px">ุชู ุนูุณ ุงูุนูููุฉ ุงูุฃุฎูุฑุฉ ูุฅุนุงุฏุฉ ุงูุฃุฑุตุฏุฉ ููุถุนูุง ุงูุณุงุจู:</p>`;
        if(details.data) {
             body.innerHTML += row("ุงูุฎุฏูุฉ ุงูููุบุงุฉ", details.data.sub);
             body.innerHTML += row("ุงูุนููู", details.data.customer);
             body.innerHTML += `<hr style="margin:10px 0; border:0; border-top:1px dashed var(--border-color)">`;
             body.innerHTML += row(`ุงุณุชุฑุฌุงุน ุชูููุฉ (${details.data.fromWallet})`, "+"+details.data.cost, true, true);
             body.innerHTML += row(`ุฎุตู ุฑุจุญ (${details.data.wallet})`, "-"+details.data.paid, true, false);
        }
    } else {
        body.innerHTML += `<p>${JSON.stringify(details)}</p>`;
    }
    
    document.getElementById("detailsModal").classList.remove("hidden");
}

function row(label, value, colored=false, positive=true) {
    let colorStyle = colored ? (positive ? "color:var(--success)" : "color:var(--danger)") : "";
    return `<div class="detail-row"><span class="detail-label">${label}</span><span class="detail-value" style="${colorStyle}">${value}</span></div>`;
}

function closeModal(e) {
    if(e === 'force' || e.target.id === 'detailsModal') {
        document.getElementById("detailsModal").classList.add("hidden");
    }
}

function updateSyncStatus(msg, type="loading") {
    const el = document.getElementById("syncStatus");
    if(isDemoMode) {
         el.innerHTML = `<i class="fas fa-flask"></i> <span>ูุถุน ุชุฌุฑูุจู</span>`;
         return;
    }
    if(type==="loading") {
        el.innerHTML = `<i class="fas fa-circle-notch fa-spin" style="color:var(--primary)"></i> <span>${msg}</span>`;
    } else if (type==="success") {
        el.innerHTML = `<i class="fas fa-check" style="color:var(--success)"></i> <span>${msg}</span>`;
        setTimeout(() => el.innerHTML = `<i class="fas fa-cloud"></i> <span>ูุชุฒุงูู</span>`, 3000);
    } else if (type==="error") {
        el.innerHTML = `<i class="fas fa-times" style="color:var(--danger)"></i> <span>${msg}</span>`;
    } else {
        el.innerHTML = `<i class="fas fa-cloud"></i> <span>${msg}</span>`;
    }
}

function logAction(actionDescription, details=null) {
    if(!currentUser) return;
    let logs = safeJSON(localStorage.activityLog, []);
    logs.unshift({
        user: currentUser.username,
        action: actionDescription,
        time: new Date().toLocaleString("ar-EG"),
        details: details 
    });
    if(logs.length > 500) logs = logs.slice(0, 500);
    localStorage.activityLog = JSON.stringify(logs);
    if(document.getElementById("logs").classList.contains("hidden") === false) refreshLogs();
}

function init(){
    // ALWAYS INITIALIZE DEFAULT DATA FIRST TO PREVENT NULL ERRORS
    if(!localStorage.users) localStorage.users = JSON.stringify([DEFAULT_USER]);
    if(!localStorage.wallets){
        localStorage.wallets=JSON.stringify({
            "ุฌูุงู ุจุงู โ ุณุนุงุฏ":{bal:0, cur:"โช", active:true},
            "ุฌูุงู ุจุงู โ ูุญูุฏ":{bal:0, cur:"โช", active:true},
            "ุจุงู ุจุงู โ ุฃุญูุฏ":{bal:0, cur:"โช", active:true},
            "ุจุงูููุณ โ ุงุญูุฏ":{bal:0, cur:"$", active:true}
        });
    }
    if(!localStorage.purchases) localStorage.purchases="[]";
    if(!localStorage.invest) localStorage.invest=JSON.stringify({ahmad:{d:0,s:0},mohamed:{d:0,s:0},store:{d:0,s:0}});
    if(!localStorage.generalNotes) localStorage.generalNotes="[]";
    if(!localStorage.todoList) localStorage.todoList="[]";
    if(!localStorage.settings) localStorage.settings = JSON.stringify({ahmad: 35, mohamed: 35, store: 30, deductCost: true, exchangeRate: 0, logsVis: 'all'});
    if(!localStorage.activityLog) localStorage.activityLog = "[]";
    if(!localStorage.stock) localStorage.stock = "[]";

    if(localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        document.getElementById("darkModeToggle").checked = true;
        if(document.getElementById("loginThemeCheck")) document.getElementById("loginThemeCheck").checked = true;
    }

    // CHECK DEMO MODE ON STARTUP
    if(localStorage.getItem("isDemoMode") === "true") {
        isDemoMode = true;
        document.body.classList.add("demo-mode");
        document.getElementById("demoModeToggle").checked = true;
        updateSyncStatus();
    }
    
    // UI LOGIC FOR LOGIN vs SETUP
    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) {
        document.getElementById("cloudSetupCard").classList.remove("hidden");
        document.getElementById("loginCard").classList.add("hidden");
    } else {
        // IMPORTANT FIX: Show Login Card IMMEDIATELY if config exists (Offline First)
        document.getElementById("cloudSetupCard").classList.add("hidden");
        document.getElementById("loginCard").classList.remove("hidden");
        
        // Try fetching in background
        fetchFromGithub(true);
    }
    
    // START POLLING LOOP (IF NOT DEMO)
    startSyncLoop();
}

function startSyncLoop() {
    if(syncTimer) clearInterval(syncTimer);
    if(!isDemoMode) {
        syncTimer = setInterval(() => fetchFromGithub(false), 3000);
    }
}

async function toggleDemoMode() {
    let current = localStorage.getItem("isDemoMode") === "true";
    let newState = !current;
    
    if (newState) {
        let ok = await showConfirm("ุชูุนูู ุงููุถุน ุงูุชุฌุฑูุจู", "ุณูุชููู ุงูุฑุจุท ุงูุณุญุงุจูุ ูููููู ุงูุชุฌุฑุจุฉ ุจุญุฑูุฉ. ุนูุฏ ุงูุฅููุงู ุณูุชู ุญุฐู ุฌููุน ุงูุชุบููุฑุงุช ุงูุชุฌุฑูุจูุฉ.", "ุชูุนูู", "ุฅูุบุงุก", "๐งช");
        if(!ok) { document.getElementById("demoModeToggle").checked = false; return; }
        localStorage.setItem("isDemoMode", "true");
        location.reload();
    } else {
        let ok = await showConfirm("ุฅููุงู ุงููุถุน ุงูุชุฌุฑูุจู", "ุณูุชู ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ูู ุงูุณุญุงุจุฉ ูุญุฐู ุฃู ุชุนุฏููุงุช ููุช ุจูุง ุงูุขู.", "ุฅููุงู", "ุฅูุบุงุก", "โ๏ธ");
        if(!ok) { document.getElementById("demoModeToggle").checked = true; return; }
        
        updateSyncStatus("ุฌุงุฑู ุงูุงุณุชุนุงุฏุฉ...", "loading");
        fetchFromGithub(true).then(() => {
            localStorage.setItem("isDemoMode", "false");
            location.reload();
        }).catch(() => {
            notify("ุฎุทุฃ: ูุง ูููู ุฅููุงู ุงููุถุน ุงูุชุฌุฑูุจู. ุชุญูู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช.", "error");
            document.getElementById("demoModeToggle").checked = true;
            updateSyncStatus("ูุดู ุงูุงุชุตุงู", "error");
        });
    }
}

async function setupCloudAndFetch() {
    const btn = document.getElementById("btnCloudSetup");
    const u = document.getElementById("loginGhUser").value.trim();
    const r = document.getElementById("loginGhRepo").value.trim();
    const t = document.getElementById("loginGhToken").value.trim();
    
    if(!u || !r || !t) { document.getElementById("cloudMsg").innerText = "ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู"; return; }
    
    btn.classList.add('loading');
    
    localStorage.setItem("gh_user", u); localStorage.setItem("gh_repo", r);
    localStorage.setItem("gh_token", t); localStorage.setItem("gh_file", "db.json");
    ghConfig = { user: u, repo: r, token: t, file: "db.json", sha: "" };
    
    document.getElementById("cloudMsg").innerText = "ุฌุงุฑู ุงูุงุชุตุงู ูุงูุชุญูู...";
    
    try {
        await fetchFromGithub(true);
    } catch(e) {
        document.getElementById("cloudMsg").innerText = "ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน.";
    }
    
    btn.classList.remove('loading');
}

async function fetchFromGithub(force = false) {
    // If Demo Mode is ON, DO NOT fetch (unless forced, e.g. when turning off demo mode)
    if(isDemoMode && !force) return;

    if(force) updateSyncStatus("ูุญุต ุงูุจูุงูุงุช ุงูุณุญุงุจูุฉ...");
    
    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;
    try {
        const response = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' }, cache: "no-store" });
        
        // HANDLE 404: File doesn't exist -> Create it (First Time Setup)
        if (response.status === 404) {
            console.log("File not found, attempting creation...");
            if(force) {
                 await pushToGithub(true);
                 // If push succeeds, show login
                 document.getElementById("cloudSetupCard").classList.add("hidden");
                 document.getElementById("loginCard").classList.remove("hidden");
                 document.getElementById("cloudMsg").innerText = "";
            }
            return;
        }

        if (!response.ok) throw new Error("API Error");
        const data = await response.json();
        
        // --- SMART UPDATE ---
        if ((data.sha !== ghConfig.sha && !isSyncing && !syncPending) || force) {
            ghConfig.sha = data.sha;
            const db = JSON.parse(decodeURIComponent(escape(atob(data.content))));
            
            if(db.users) localStorage.users = JSON.stringify(db.users);
            if(db.wallets) localStorage.wallets = JSON.stringify(db.wallets);
            if(db.purchases) localStorage.purchases = JSON.stringify(db.purchases);
            if(db.invest) localStorage.invest = JSON.stringify(db.invest);
            if(db.settings) localStorage.settings = JSON.stringify(db.settings);
            if(db.generalNotes) localStorage.generalNotes = JSON.stringify(db.generalNotes);
            if(db.todoList) localStorage.todoList = JSON.stringify(db.todoList);
            if(db.activityLog) localStorage.activityLog = JSON.stringify(db.activityLog);
            if(db.stock) localStorage.stock = JSON.stringify(db.stock);
            
            if(currentUser) refreshAll(); 
            if(force) {
                updateSyncStatus("ูุชุฒุงูู", "success");
                // Switch cards on success
                document.getElementById("cloudSetupCard").classList.add("hidden");
                document.getElementById("loginCard").classList.remove("hidden");
            }
        }
    } catch (error) {
        console.error(error);
        if(force) {
            updateSyncStatus("ุฎุทุฃ ูู ุงูุงุชุตุงู", "error");
            document.getElementById("cloudMsg").innerText = "ูุดู ุงูุงุชุตุงู ุจู GitHub. ุชุฃูุฏ ูู ุงูุจูุงูุงุช.";
            // Re-throw to handle in toggleDemoMode
            throw error;
        }
    }
}

async function attemptLogin() {
    const btn = document.getElementById("btnLogin");
    const u = document.getElementById("loginUser").value.trim();
    const p = document.getElementById("loginPass").value.trim();
    let users = safeJSON(localStorage.users, []);
    
    btn.classList.add('loading'); // START SPINNER

    // Simulate delay for UX
    await new Promise(r => setTimeout(r, 800));

    let userObj = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);

    if (userObj) {
        if(userObj.username === "Mohamed Ahmed") {
            userObj.role = "admin"; userObj.status = "active";
            localStorage.users = JSON.stringify(users);
        }

        if(userObj.status === "banned") { 
            notify("ุชู ุญุธุฑ ูุฐุง ุงูุญุณุงุจ. ุฑุงุฌุน ุงููุณุคูู.", "error"); 
            btn.classList.remove('loading');
            return; 
        }
        currentUser = userObj;
        userObj.lastLogin = new Date().toLocaleString("ar-EG");
        userObj.deviceInfo = getOS();
        localStorage.users = JSON.stringify(users);
        
        logAction("ุชุณุฌูู ุฏุฎูู ูููุธุงู");

        if(!isDemoMode) {
            updateSyncStatus("ุชุญุฏูุซ ุงูุตูุงุญูุงุช ุณุญุงุจูุงู...", "loading");
            await pushToGithub(); 
        }
        
        document.getElementById("loginLayer").style.display = "none";
        document.body.classList.remove("locked");
        document.getElementById("globalSearchWrap").style.display = "block";
        loadWallets(); loadProfitSettings(); loadGithubInputs(); refreshAll(); applyRBAC();
        document.getElementById("currentUserDisplay").innerHTML = `ูุฑุญุจุงูุ ${currentUser.username} (${getRoleName(currentUser.role)})`;
        checkExpiringOnLogin();
    } else { 
        notify("ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ โ", "error");
    }
    
    btn.classList.remove('loading'); // STOP SPINNER
}

function getOS() {
    let platform = window.navigator.platform, os = null;
    if (['Macintosh', 'MacIntel'].indexOf(platform) !== -1) os = 'Mac OS';
    else if (['iPhone', 'iPad'].indexOf(platform) !== -1) os = 'iOS';
    else if (['Win32', 'Win64', 'Windows'].indexOf(platform) !== -1) os = 'Windows';
    else if (/Android/.test(window.navigator.userAgent)) os = 'Android';
    else if (/Linux/.test(platform)) os = 'Linux';
    return os || "Unknown";
}

function logout() { location.reload(); }
function getRoleName(role) { 
    if(role==='admin') return 'ุฃุฏูู';
    if(role==='employee') return 'ููุธู';
    if(role==='viewer_plus') return 'ูุดุงูุฏ ูุชูุฏู';
    return 'ูุดุงูุฏ ุนุงุฏู'; 
}

function applyRBAC() {
    const role = currentUser.role;
    
    document.getElementById("btnSecurity").classList.add("hidden");
    document.getElementById("btnBackup").classList.add("hidden");
    document.getElementById("btnLogs").classList.add("hidden");
    document.getElementById("demo-mode-section").classList.add("hidden"); // Default hidden
    
    document.getElementById("btnSettings").classList.remove("hidden");
    document.getElementById("btnClearLogs").classList.add("hidden");
    document.getElementById("btnVisLogs").classList.add("hidden");

    let settings = safeJSON(localStorage.settings, {});
    let logsVis = settings.logsVis || 'all';

    if (role === 'admin') {
        document.getElementById("btnSecurity").classList.remove("hidden");
        document.getElementById("btnBackup").classList.remove("hidden");
        document.getElementById("btnLogs").classList.remove("hidden"); 
        document.getElementById("btnClearLogs").classList.remove("hidden"); 
        document.getElementById("btnVisLogs").classList.remove("hidden"); 
        document.getElementById("demo-mode-section").classList.remove("hidden"); // Show for Admin
        
        // Settings Sections for Admin
        document.getElementById("sec-manual-wallet").classList.remove("hidden");
        document.getElementById("sec-set-wallet-balance").classList.remove("hidden"); // Only Admin
        document.getElementById("sec-set-profit-share").classList.remove("hidden"); // Only Admin
        document.getElementById("sec-manage-wallets").classList.remove("hidden");
        document.getElementById("sec-rename-wallet").classList.remove("hidden");
        document.getElementById("sec-profit-settings").classList.remove("hidden");
        document.getElementById("sec-todo").classList.remove("hidden");
        
        document.getElementById("btnStock").classList.remove("hidden");
        document.getElementById("btnUndo").classList.remove("hidden");
        document.getElementById("btnClearHistory").classList.remove("hidden");
        document.getElementById("btnHideExpired").classList.remove("hidden");
    } 
    else if (role === 'employee') {
        if(logsVis !== 'no_employee' && logsVis !== 'admin_only') {
            document.getElementById("btnLogs").classList.remove("hidden");
        }
        document.getElementById("demo-mode-section").classList.remove("hidden"); // Show for Employee
        
        // Employee can see transfer but NOT set balance or set profit
        document.getElementById("sec-manual-wallet").classList.remove("hidden");
        document.getElementById("sec-set-wallet-balance").classList.add("hidden");
        document.getElementById("sec-set-profit-share").classList.add("hidden");
        
        document.getElementById("sec-manage-wallets").classList.remove("hidden");
        document.getElementById("sec-rename-wallet").classList.remove("hidden");
        document.getElementById("sec-profit-settings").classList.remove("hidden");
        document.getElementById("sec-todo").classList.remove("hidden");
        document.getElementById("btnStock").classList.remove("hidden");
        document.getElementById("btnUndo").classList.remove("hidden");
        document.getElementById("btnHideExpired").classList.remove("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
    }
    else if (role === 'viewer' || role === 'viewer_plus') {
        if(logsVis !== 'no_viewer' && logsVis !== 'admin_only') {
            document.getElementById("btnLogs").classList.remove("hidden");
        }
        document.getElementById("btnPurchase").classList.add("hidden");
        
        document.getElementById("sec-manual-wallet").classList.add("hidden");
        document.getElementById("sec-set-wallet-balance").classList.add("hidden");
        document.getElementById("sec-set-profit-share").classList.add("hidden");
        document.getElementById("sec-manage-wallets").classList.add("hidden");
        document.getElementById("sec-rename-wallet").classList.add("hidden");
        document.getElementById("sec-profit-settings").classList.add("hidden");
        document.getElementById("sec-todo").classList.add("hidden");
        
        document.getElementById("btnUndo").classList.add("hidden");
        document.getElementById("btnClearHistory").classList.add("hidden");
        document.getElementById("btnHideExpired").classList.add("hidden");
        
        // Hide notes area for both viewers
        document.querySelector("#generalNotes textarea").style.display = "none";
        document.querySelector("#generalNotes button").style.display = "none";

        showPage('history', document.getElementById('btnHistory'));
    }
}

async function changeLogsVis() {
    if(currentUser.role !== 'admin') return;
    let current = (safeJSON(localStorage.settings, {})).logsVis || 'all';
    let map = {'all': 'ููุฌููุน', 'no_viewer': 'ุฅุฎูุงุก ุนู ุงููุดุงูุฏ', 'no_employee': 'ุฅุฎูุงุก ุนู ุงูููุธู', 'admin_only': 'ููุฃุฏูู ููุท'};
    
    // Use a simple inline approach - temporarily replace input with select
    document.getElementById("pdIcon").textContent = "๐๏ธ";
    document.getElementById("pdTitle").textContent = "ุฅุนุฏุงุฏุงุช ุธููุฑ ุณุฌู ุงูุญุฑูุงุช";
    document.getElementById("pdMsg").textContent = `ุงููุถุน ุงูุญุงูู: ${map[current]}`;
    let inp = document.getElementById("pdInput");
    inp.style.display = "none";
    
    // Insert select after input
    let sel = document.createElement("select");
    sel.id = "logsVisSelect"; sel.className = "dialog-input";
    sel.innerHTML = `<option value="all">ุฅุธูุงุฑ ููุฌููุน</option><option value="no_viewer">ุฅุฎูุงุก ุนู ุงููุดุงูุฏ</option><option value="no_employee">ุฅุฎูุงุก ุนู ุงูููุธู</option><option value="admin_only">ููุฃุฏูู ููุท</option>`;
    sel.value = current;
    inp.parentNode.insertBefore(sel, inp.nextSibling);
    
    document.getElementById("customPromptDialog").style.display = "flex";
    
    // Override prompt resolve
    let prevResolve = _promptResolve;
    _promptResolve = (ok) => {
        let newVal = ok ? document.getElementById("logsVisSelect")?.value : null;
        sel.remove(); inp.style.display = "";
        document.getElementById("customPromptDialog").style.display = "none";
        _promptResolve = null;
        if(newVal) {
            let settings = safeJSON(localStorage.settings, {});
            settings.logsVis = newVal;
            localStorage.settings = JSON.stringify(settings);
            logAction(`ุชุบููุฑ ุฅุนุฏุงุฏุงุช ุธููุฑ ุงูุณุฌู ุฅูู: ${map[newVal]}`);
            pushToGithub(); notify("ุชู ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุฎุตูุตูุฉ"); applyRBAC();
        }
    };
}

function renderUsersTable() {
    if(!currentUser || currentUser.role !== 'admin') return;
    const users = safeJSON(localStorage.users, []);
    const tbody = document.getElementById("usersTableBody"); 
    if(!tbody) return;
    let rows = "";
    users.forEach((u, index) => {
        let actions = "";
        if(u.username !== currentUser.username) {
            let banBtn = u.status === 'active' ? `<button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="toggleBan(${index})">ุญุธุฑ</button>` : `<button class="btn btn-success" style="padding:5px 10px; font-size:12px; background:var(--success); color:white" onclick="toggleBan(${index})">ูู ุญุธุฑ</button>`;
            actions = `<div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap"><button class="btn btn-primary" style="padding:5px 10px; font-size:12px" onclick="openEditUserModal(${index})"><i class="fas fa-edit"></i> ุชุนุฏูู</button>${banBtn}<button class="btn btn-danger" style="padding:5px 10px; font-size:12px" onclick="deleteUser(${index})"><i class="fas fa-trash"></i></button></div>`;
        } else { actions = "<small>ุงูุญุณุงุจ ุงูุญุงูู</small>"; }
        let statusClass = u.status === 'active' ? 'security-status-active' : 'security-status-banned';
        let statusText = u.status === 'active' ? 'ูุดุท' : 'ูุญุธูุฑ';
        rows += `<tr><td>${u.username}</td><td><span class="badge badge-info">${getRoleName(u.role)}</span></td><td class="${statusClass}">${statusText}</td><td style="font-size:12px">${u.lastLogin}</td><td style="font-size:12px">${u.deviceInfo}</td><td>${actions}</td></tr>`;
    });
    tbody.innerHTML = rows;
}

function refreshLogs() {
    let logs = safeJSON(localStorage.activityLog, []);
    let search = document.getElementById("logsSearch").value.toLowerCase();
    const tbody = document.getElementById("logsTableBody");
    let rows = "";
    logs.forEach((log, index) => {
        if(search && !log.user.toLowerCase().includes(search) && !log.action.toLowerCase().includes(search)) return;
        let detailsBtn = "";
        if(log.details) {
            detailsBtn = `<button class="btn btn-primary" style="padding:5px 10px; font-size:12px" onclick='showModalDetails(${JSON.stringify(log.details)})'><i class="fas fa-eye"></i></button>`;
        }
        rows += `<tr><td style="direction:ltr; text-align:right">${log.time}</td><td><b>${log.user}</b></td><td>${log.action}</td><td>${detailsBtn}</td></tr>`;
    });
    tbody.innerHTML = rows;
}

async function clearLogs() {
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท", "error");
    let ok = await showConfirm("ูุณุญ ุณุฌู ุงูุญุฑูุงุช", "ุณูุชู ุญุฐู ุฌููุน ุณุฌูุงุช ุงูุญุฑูุงุช ููุงุฆูุงู.", "ูุณุญ", "ุฅูุบุงุก", "๐๏ธ");
    if(ok) {
        localStorage.activityLog = "[]";
        refreshLogs();
        logAction("ูุงู ุงูุฃุฏูู ุจูุณุญ ุณุฌู ุงูุญุฑูุงุช");
        pushToGithub();
        notify("ุชู ูุณุญ ุงูุณุฌู");
    }
}

// editUserPass and changeUserRole are legacy functions kept for backward compatibility
// They now use the modal-based openEditUserModal instead
async function editUserPass(index) {
    let users = safeJSON(localStorage.users, []);
    let newP = await showPrompt(`ุชุบููุฑ ูููุฉ ูุฑูุฑ ${users[index].username}`, "", "ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ...", "๐");
    if(newP) {
        users[index].password = newP;
        localStorage.users = JSON.stringify(users);
        logAction(`ุชุบููุฑ ูููุฉ ูุฑูุฑ ุงููุณุชุฎุฏู: ${users[index].username}`);
        pushToGithub(); notify("ุชู ุชุบููุฑ ูููุฉ ุงููุฑูุฑ");
    }
}

async function changeUserRole(index) {
    // This function is superseded by openEditUserModal, kept for compatibility
    openEditUserModal(index);
}

function addNewUser() {
    const u = document.getElementById("newUserName").value.trim(), p = document.getElementById("newUserPass").value.trim(), r = document.getElementById("newUserRole").value;
    if(!u || !p) return notify("ูุฑุฌู ููุก ุงูุจูุงูุงุช", "error");
    let users = safeJSON(localStorage.users, []);
    if(users.some(x => x.username.toLowerCase() === u.toLowerCase())) return notify("ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ", "error");
    users.push({ username: u, password: p, role: r, status: "active", lastLogin: "-", deviceInfo: "-" });
    localStorage.users = JSON.stringify(users);
    logAction(`ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ: ${u} ุจุตูุงุญูุฉ ${r}`);
    document.getElementById("newUserName").value = ""; document.getElementById("newUserPass").value = "";
    renderUsersTable(); pushToGithub(); notify("ุชู ุฅุถุงูุฉ ุงููุณุชุฎุฏู");
}

function toggleBan(index) {
    let users = safeJSON(localStorage.users, []);
    let newState = users[index].status === 'active' ? 'banned' : 'active';
    users[index].status = newState;
    localStorage.users = JSON.stringify(users);
    logAction(`ุชุบููุฑ ุญุงูุฉ ุงููุณุชุฎุฏู ${users[index].username} ุฅูู ${newState}`);
    renderUsersTable(); pushToGithub();
}

async function deleteUser(index) {
    let ok = await showConfirm("ุญุฐู ุงููุณุชุฎุฏู", "ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุณุชุฎุฏู ููุงุฆูุงูุ", "ุญุฐู", "ุฅูุบุงุก", "๐ค");
    if(!ok) return;
    let users = safeJSON(localStorage.users, []);
    logAction(`ุญุฐู ุงููุณุชุฎุฏู: ${users[index].username}`);
    users.splice(index, 1);
    localStorage.users = JSON.stringify(users);
    renderUsersTable(); pushToGithub();
}


function changeMyPassword() {
    let newP = document.getElementById("changePassInput").value.trim();
    if(!newP) return notify("ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ", "error");
    let users = safeJSON(localStorage.users, []);
    let myIndex = users.findIndex(u => u.username === currentUser.username);
    if(myIndex !== -1) {
        users[myIndex].password = newP;
        currentUser.password = newP; 
        localStorage.users = JSON.stringify(users);
        document.getElementById("changePassInput").value = "";
        logAction("ูุงู ุจุชุบููุฑ ูููุฉ ุงููุฑูุฑ ุงูุฎุงุตุฉ ุจู");
        pushToGithub(); notify("ุชู ุงูุชุบููุฑ ุจูุฌุงุญ");
    }
}

// --- QUEUE & RETRY SYSTEM ---
async function pushToGithub(force = false) {
    if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) return;

    if(isDemoMode) {
        // notify("ูุถุน ุชุฌุฑูุจู: ุชู ุญูุธ ุงูุจูุงูุงุช ูุญููุงู ููุท", "success");
        return;
    }

    if (isSyncing) {
        syncPending = true;
        updateSyncStatus("ุชู ูุถุน ุงูุชุนุฏูู ูู ุงูุทุงุจูุฑ...", "loading");
        return;
    }

    isSyncing = true;
    updateSyncStatus(retryAttempt > 0 ? `ุฌุงุฑู ุงููุญุงููุฉ (${retryAttempt})...` : "ุฌุงุฑู ุงูุญูุธ...", "loading");

    const db = {
        users: safeJSON(localStorage.users, []),
        wallets: safeJSON(localStorage.wallets, {}),
        purchases: safeJSON(localStorage.purchases, []),
        invest: safeJSON(localStorage.invest, {}),
        settings: safeJSON(localStorage.settings, {}),
        generalNotes: safeJSON(localStorage.generalNotes, []),
        todoList: safeJSON(localStorage.todoList, []),
        activityLog: safeJSON(localStorage.activityLog, []),
        stock: safeJSON(localStorage.stock, []),
        lastUpdate: new Date().toISOString()
    };

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(db))));
    const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${ghConfig.file}`;

    const body = { message: "Update via MegaStore Audit", content: content };
    if (ghConfig.sha) body.sha = ghConfig.sha;

    try {
        const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        
        if (response.status === 409) {
            console.log("Conflict detected, fetching latest SHA...");
            const getResp = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}` } });
            if(getResp.ok) {
                const getJson = await getResp.json();
                ghConfig.sha = getJson.sha; 
                throw new Error("Conflict Resolved - Retrying");
            }
        } else if (!response.ok) {
            throw new Error("Network/API Error");
        } else {
            const data = await response.json();
            ghConfig.sha = data.content.sha;
            
            retryAttempt = 0; 
            isSyncing = false;
            
            if (syncPending) {
                syncPending = false;
                pushToGithub(); 
            } else {
                updateSyncStatus("ุชู ุงูุญูุธ ุณุญุงุจูุงู", "success");
            }
        }
    } catch (error) { 
        console.error(error);
        retryAttempt++;
        if(retryAttempt > MAX_RETRIES) {
            updateSyncStatus("ูุดู ููุงุฆู. ุชุฃูุฏ ูู ุงููุช", "error");
            isSyncing = false;
            retryAttempt = 0;
        } else {
            updateSyncStatus(`ูุดู.. ุฅุนุงุฏุฉ ุงููุญุงููุฉ (${retryAttempt})...`, "error");
            setTimeout(() => {
                isSyncing = false; 
                pushToGithub(); 
            }, 2000); 
        }
    }
}

function showPage(id, btn){
    if(currentUser) {
        if((currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') && (id === 'purchase' || id === 'security' || id === 'backup')) return notify("ููุณ ูุฏูู ุตูุงุญูุฉ", "error");
        if(currentUser.role === 'employee' && (id === 'security' || id === 'backup')) return notify("ููุณ ูุฏูู ุตูุงุญูุฉ", "error");
    }
    document.querySelectorAll(".card").forEach(x=>x.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
    if(window.innerWidth <= 768) { let sidebar = document.getElementById("mySidebar"); if(sidebar.classList.contains("active")) toggleSidebar(); }
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    if(btn) btn.classList.add("active");
    
    if(id === 'generalNotes') refreshGeneralNotes();
    if(id === 'investment') refreshInvestment();
    if(id === 'history') refreshHistory();
    if(id === 'wallets') refreshWallets();
    if(id === 'expiring') refreshExpiring();
    if(id === 'analytics') refreshAnalytics();
    if(id === 'security') renderUsersTable();
    if(id === 'logs') refreshLogs();
    if(id === 'stock') refreshStock();
}

function toggleSidebar() {
    let sidebar = document.getElementById("mySidebar"), overlay = document.querySelector(".sidebar-overlay"), btnIcon = document.querySelector("#menuBtn i");
    sidebar.classList.toggle("active"); overlay.classList.toggle("active");
    if(sidebar.classList.contains("active")){ btnIcon.classList.remove("fa-bars"); btnIcon.classList.add("fa-times"); } else { btnIcon.classList.remove("fa-times"); btnIcon.classList.add("fa-bars"); }
}

function toggleDarkMode() {
    document.body.classList.toggle("dark-mode");
    let isDark = document.body.classList.contains("dark-mode");
    localStorage.setItem("darkMode", isDark);
    
    if(document.getElementById("darkModeToggle")) document.getElementById("darkModeToggle").checked = isDark;
    if(document.getElementById("loginThemeCheck")) document.getElementById("loginThemeCheck").checked = isDark;
}

let _notifyQueue = [];
let _notifyBusy = false;
function notify(msg, type="success") {
    _notifyQueue.push({msg, type});
    if(!_notifyBusy) _processNotifyQueue();
}
function _processNotifyQueue() {
    if(_notifyQueue.length === 0) { _notifyBusy = false; return; }
    _notifyBusy = true;
    let {msg, type} = _notifyQueue.shift();
    let n = document.getElementById("notification");
    n.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}"></i> ` + msg;
    n.style.background = type === "success" ? "#10b981" : "#ef4444";
    n.style.display = "block";
    setTimeout(() => { n.style.display = "none"; setTimeout(_processNotifyQueue, 200); }, 2800);
}

function loadWallets(){
    let wallets=safeJSON(localStorage.wallets, {});
    const selects = [wallet, modWallet, fromWallet, renameWalletSelect, tfFromWallet, tfToWallet, wWalletAhmad, wWalletMohamed, wWalletStore];
    selects.forEach(s => { 
        if(s) { 
            s.innerHTML = s.id.startsWith("wWallet") ? '<option value="">ุงุฎุชุฑ ูุญูุธุฉ ุงูุณุญุจ</option>' : ""; 
            Object.keys(wallets).forEach(w=>{ 
                let o=document.createElement("option"); 
                o.value=w; o.text=w + ` (${wallets[w].cur})`; 
                s.appendChild(o); 
            }); 
        } 
    });
}
function loadProfitSettings(){
    let s = safeJSON(localStorage.settings, {});
    setAhmadProp.value = s.ahmad; setMohamedProp.value = s.mohamed; setStoreProp.value = s.store;
    setDeductCost.checked = s.deductCost; setExchangeRate.value = s.exchangeRate || 0;
}
function loadGithubInputs(){
    document.getElementById("ghUser").value = ghConfig.user; document.getElementById("ghRepo").value = ghConfig.repo;
    document.getElementById("ghToken").value = ghConfig.token; document.getElementById("ghFile").value = ghConfig.file;
}
function saveProfitSettings(){
    let a = +setAhmadProp.value, m = +setMohamedProp.value, s = +setStoreProp.value;
    if(a + m + s !== 100){ notify("ูุฌููุน ุงููุณุจ ูุฌุจ ุฃู ูุณุงูู 100%","error"); return; }
    let sObj = safeJSON(localStorage.settings, {});
    sObj.ahmad = a; sObj.mohamed = m; sObj.store = s; sObj.deductCost = setDeductCost.checked; sObj.exchangeRate = +setExchangeRate.value;
    localStorage.settings = JSON.stringify(sObj);
    logAction("ุชุนุฏูู ุฅุนุฏุงุฏุงุช ุชูุฒูุน ุงูุฃุฑุจุงุญ");
    pushToGithub(); notify("ุชู ุงูุญูุธ");
}
function saveGithubSettings() {
    const u = document.getElementById("ghUser").value.trim(), r = document.getElementById("ghRepo").value.trim(), t = document.getElementById("ghToken").value.trim(), f = document.getElementById("ghFile").value.trim() || "db.json";
    if(!u || !r || !t) return notify("ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู", "error");
    localStorage.setItem("gh_user", u); localStorage.setItem("gh_repo", r); localStorage.setItem("gh_token", t); localStorage.setItem("gh_file", f);
    ghConfig = {user: u, repo: r, token: t, file: f, sha: ""};
    logAction("ุชุนุฏูู ุฅุนุฏุงุฏุงุช ุงูุฑุจุท ุงูุณุญุงุจู");
    notify("ุชู ุงูุญูุธุ ุฌุงุฑู ุงูุงุชุตุงู...", "success"); fetchFromGithub();
}
// Phone validation
function validatePhoneInput(el) {
    let v = el.value.trim();
    if(!v) { el.classList.remove("phone-valid","phone-invalid"); return; }
    let digits = v.replace(/\D/g,'');
    if(digits.length >= 7 && /^[\d\s\-\+\(\)]+$/.test(v)) {
        el.classList.add("phone-valid"); el.classList.remove("phone-invalid");
    } else {
        el.classList.add("phone-invalid"); el.classList.remove("phone-valid");
    }
}

function addPurchase(){
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return;
    if(paidAmount.value === "" || costAmount.value === "") { notify("ุงููุฃ ุงููุจูุบ ุงููุฏููุน ูุงูุชูููุฉ","error"); return; }
    if(!sub.value.trim()) { notify("ุฃุฏุฎู ููุน ุงูุงุดุชุฑุงู","error"); return; }
    
    // Phone validation warning (not blocking)
    let phoneVal = customerPhone.value.trim();
    if(phoneVal && phoneVal !== '-') {
        let digits = phoneVal.replace(/\D/g,'');
        if(digits.length < 7) { notify("ุฑูู ุงูุฌูุงู ูุจุฏู ุบูุฑ ุตุญูุญ","error"); return; }
    }
    
    let paid=+paidAmount.value, cost=+costAmount.value;
    let paidCur=paidCurrency.value, costCur=costCurrency.value;
    let from=fromWallet.value, duration = +subDuration.value;
    let settings=safeJSON(localStorage.settings, {});
    let walletsTmp=safeJSON(localStorage.wallets, {});
    
    if(walletsTmp[from].bal < cost && walletsTmp[from].cur == costCur){ notify("ุฑุตูุฏ ุบูุฑ ูุงูู","error"); return; }
    
    // Check exchange rate if currencies differ
    let rate = settings.exchangeRate && settings.exchangeRate > 0 ? settings.exchangeRate : 0;
    if(paidCur !== costCur && rate === 0) {
        notify("ุนููุชุง ุงูุฏูุน ูุงูุชูููุฉ ูุฎุชููุชุงู. ูุฑุฌู ุชุนููู ุณุนุฑ ุงูุตุฑู ูู ุงูุฅุนุฏุงุฏุงุช ุฃููุงู.", "error");
        return;
    }
    
    // Show confirmation modal
    let profit = settings.deductCost 
        ? (paidCur === costCur ? paid - cost : (paidCur === '$' ? paid - cost/rate : paid - cost*rate))
        : paid;
    let profitStr = `${fix(profit)} ${paidCur}`;
    
    document.getElementById("purchaseConfirmBody").innerHTML = `
        <div style="display:grid; gap:4px;">
            <div>๐ <b>ุงูุฎุฏูุฉ:</b> ${sub.value}</div>
            <div>๐ค <b>ุงูุนููู:</b> ${customer.value||'โ'} ${phoneVal?'('+phoneVal+')':''}</div>
            <div>๐ <b>ุงููุฏุฉ:</b> ${duration} ุดูุฑ</div>
            <div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border-color)">
                <span style="color:var(--success)">๐ฐ ูุฏููุน: ${paid}${paidCur}</span> &nbsp;|&nbsp;
                <span style="color:var(--danger)">๐ธ ุชูููุฉ: ${cost}${costCur}</span>
            </div>
            <div>๐ <b>ุตุงูู ุงูุฑุจุญ ุชูุฑูุจุงู:</b> <b style="color:var(--primary)">${profitStr}</b></div>
            <div style="font-size:12px; margin-top:6px; color:var(--text-muted)">โฌ๏ธ ูู ูุญูุธุฉ: ${from} &nbsp;|&nbsp; โก๏ธ ุฅูู ูุญูุธุฉ: ${wallet.value}</div>
        </div>`;
    
    document.getElementById("purchaseConfirmModal").style.display = "flex";
    document.getElementById("purchaseConfirmOkBtn").onclick = () => {
        document.getElementById("purchaseConfirmModal").style.display = "none";
        _executePurchase(paid, cost, paidCur, costCur, from, duration, rate, settings);
    };
}

function _executePurchase(paid, cost, paidCur, costCur, from, duration, rate, settings) {
    let wallets=safeJSON(localStorage.wallets, {}), invest=safeJSON(localStorage.invest, {}), purchases=safeJSON(localStorage.purchases, []);
    
    let wBefore = wallets[from].bal;
    let tBefore = wallets[wallet.value].bal;
    let invest_before_profit = JSON.parse(JSON.stringify(invest));
    
    wallets[from].bal -= cost;
    
    // Deduct cost from store capital
    if(costCur === '$') {
        if(invest.store.d >= cost) invest.store.d -= cost;
        else { let rem = cost - invest.store.d; invest.store.d = 0; invest.store.s -= (rem * rate); }
    } else {
        if(invest.store.s >= cost) invest.store.s -= cost;
        else { let rem = cost - invest.store.s; invest.store.s = 0; if(rate > 0) invest.store.d -= (rem / rate); }
    }
    
    // Calculate profit distribution
    let profitBase = paid, costInPaidCurrency = 0;
    if(settings.deductCost) {
        if(paidCur === costCur) { profitBase = paid - cost; costInPaidCurrency = cost; }
        else { let costCv = (paidCur === '$') ? cost/rate : cost*rate; profitBase = paid - costCv; costInPaidCurrency = costCv; }
    }
    
    let aP = +(profitBase * (settings.ahmad/100)).toFixed(2);
    let mP = +(profitBase * (settings.mohamed/100)).toFixed(2);
    let sP = +(profitBase * (settings.store/100)).toFixed(2);
    
    if(paidCur === '$') {
        invest.ahmad.d += aP; invest.mohamed.d += mP; invest.store.d += sP;
        if(settings.deductCost) invest.store.d += costInPaidCurrency;
    } else {
        invest.ahmad.s += aP; invest.mohamed.s += mP; invest.store.s += sP;
        if(settings.deductCost) invest.store.s += costInPaidCurrency;
    }
    
    wallets[wallet.value].bal += paid;
    
    let d = new Date(), exp = new Date(d);
    exp.setMonth(exp.getMonth() + duration);
    if(exp.getDate() !== d.getDate()) exp.setDate(0);
    
    purchases.push({
        id: Date.now() + '_' + Math.random().toString(36).substr(2,5),
        date: d.getFullYear()+'-'+(d.getMonth()+1)+'-'+d.getDate(),
        customer: customer.value||"ุนููู",
        phone: customerPhone.value||"-",
        sub: sub.value,
        duration: duration,
        paid: paid+paidCur,
        cost: cost+costCur,
        wallet: wallet.value,
        fromWallet: from,
        expiry: exp.getTime(),
        investSnapshot: invest_before_profit
    });
    
    localStorage.wallets=JSON.stringify(wallets);
    localStorage.invest=JSON.stringify(invest);
    localStorage.purchases=JSON.stringify(purchases);
    
    logAction(`ุฅุถุงูุฉ ุนูููุฉ ุดุฑุงุก: ${sub.value} ููุนููู ${customer.value}`, {
        type: 'purchase',
        customer: customer.value||"ุนููู",
        sub: sub.value,
        cost: cost+costCur, paid: paid+paidCur,
        wName: from, wBefore: wBefore, wAfter: wallets[from].bal,
        toName: wallet.value, tBefore: tBefore, tAfter: wallets[wallet.value].bal
    });
    
    refreshAll(); pushToGithub(); notify("โ ุชูุช ุงูุนูููุฉ ุจูุฌุงุญ");
    paidAmount.value=""; costAmount.value=""; customer.value=""; sub.value=""; customerPhone.value=""; subDuration.value="1";
    customerPhone.classList.remove("phone-valid","phone-invalid");
}
function refreshAll(){
    // Always update stats and wallets (shown in header)
    refreshWallets();
    
    // Update stats
    let p = safeJSON(localStorage.purchases, []);
    let now = new Date();
    let todayStr = now.getFullYear() + '-' + (now.getMonth()+1) + '-' + now.getDate();
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    document.getElementById("statSales").textContent = p.filter(x => x.date.includes(todayStr)).length;
    if(isRestricted) {
        document.getElementById("statDollar").textContent = "****";
        document.getElementById("statShekel").textContent = "****";
    }
    
    // Update expiry badge
    let days3 = 3 * 86400000, nowMs = now.getTime();
    let expiringCount = p.filter(x => x.expiry && !x.expiryDismissed && (x.expiry - nowMs < days3 && x.expiry - nowMs > -2592000000)).length;
    let badge = document.getElementById("expiryBadge");
    if(badge) { badge.textContent = expiringCount; badge.style.display = expiringCount > 0 ? "inline-flex" : "none"; }
    
    // Only refresh currently visible sections to save performance
    const visMap = {
        'history': refreshHistory,
        'investment': refreshInvestment,
        'generalNotes': refreshGeneralNotes,
        'expiring': refreshExpiring,
        'analytics': refreshAnalytics,
        'logs': refreshLogs,
        'stock': refreshStock,
        'modify': () => { refreshTodoList(); }
    };
    
    // Always refresh a few critical ones
    refreshInvestment();
    refreshExpiring();
    
    // Refresh currently visible card
    document.querySelectorAll(".main-content > .card:not(.hidden)").forEach(card => {
        let id = card.id;
        if(visMap[id]) visMap[id]();
    });
    
    // Also refresh history and generalNotes since they are often needed
    if(!document.getElementById("history").classList.contains("hidden")) refreshHistory();
    if(!document.getElementById("generalNotes").classList.contains("hidden")) refreshGeneralNotes();
    if(!document.getElementById("stock").classList.contains("hidden")) refreshStock();
}
function refreshExpiring() {
    let p = safeJSON(localStorage.purchases, []);
    let body = document.getElementById("expiringBody"); 
    if(!body) return;
    let now = new Date().getTime(), days3 = 3 * 86400000;
    let list = p.map((d, i) => ({ d, i })).filter(x => x.d.expiry && !x.d.expiryDismissed && (x.d.expiry - now < days3 && x.d.expiry - now > -2592000000));
    list.sort((a, b) => a.d.expiry - b.d.expiry);
    
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let isViewer = currentUser ? (currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') : true;
    
    let rows = "";
    list.forEach(x => {
        let item = x.d, daysLeft = Math.ceil((item.expiry - now) / 86400000);
        let status = daysLeft <= 0 ? 'ููุชูู' : daysLeft + ' ููู';
        let wa = `https://wa.me/${item.phone.replace(/\D/g, '').replace(/^0/, '970')}?text=${encodeURIComponent(`ุงูุณูุงู ุนูููู ${item.customer}ุ ููุฏ ุชุฐููุฑูู ุจุงูุชูุงุก ุงุดุชุฑุงู ${item.sub} ุจุนุฏ ${status}. ููุชุฌุฏูุฏ ูุฑุฌู ุงูุชูุงุตู ูุนูุง.`)}`;
        let btnHTML = isViewer ? '' : `<a href="${wa}" target="_blank" onclick="markAsReminded(${x.i})" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> ุชุฐููุฑ</a>`;
        let phoneDisplay = isRestricted ? '----' : item.phone;
        let serviceDisplay = isRestricted ? '----' : `<b>${item.sub}</b>`;
        rows += `<tr class="${item.reminded?'reminded':''}"><td>${serviceDisplay}</td><td>${item.customer}</td><td>${phoneDisplay}</td><td>${new Date(item.expiry).toLocaleDateString('ar-EG')}</td><td><span class="badge ${daysLeft<=0?'badge-danger':'badge-warning'}">${status}</span></td><td>${btnHTML}</td></tr>`;
    });
    body.innerHTML = rows || "<tr><td colspan='6' style='text-align:center; padding:30px'>ูุง ุชูุฌุฏ ุชูุจููุงุช</td></tr>";
    
    // Update badge
    let badge = document.getElementById("expiryBadge");
    if(badge) { badge.textContent = list.length; badge.style.display = list.length > 0 ? "inline-flex" : "none"; }
}
function markAsReminded(i) { let p = safeJSON(localStorage.purchases, []); p[i].reminded = true; localStorage.purchases = JSON.stringify(p); refreshExpiring(); pushToGithub(); }
async function deleteExpired() { 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; 
    let ok = await showConfirm("ุฅุฎูุงุก ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ", "ุณูุชู ุฅุฎูุงุก ุฌููุน ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ ูู ุงููุงุฆูุฉ.", "ุฅุฎูุงุก", "ุฅูุบุงุก", "๐");
    if(!ok) return;
    let p = safeJSON(localStorage.purchases, []), now = new Date().getTime(); 
    p.forEach(x => { if(x.expiry && x.expiry < now) x.expiryDismissed = true; }); 
    localStorage.purchases = JSON.stringify(p); logAction("ุฅุฎูุงุก ุงูุงุดุชุฑุงูุงุช ุงูููุชููุฉ"); refreshAll(); pushToGithub(); 
}
function refreshWallets(){
    let w=safeJSON(localStorage.wallets, {}), td=0, ts=0;
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let rows="";
    for(let k in w){
        let act = w[k].active !== false;
        let balDisplay = isRestricted ? '****' : fix(w[k].bal);
        rows+=`<tr><td><b>${k}</b></td><td><span class="badge ${w[k].cur=='$'?'badge-success':'badge-info'}">${w[k].cur}</span></td><td style="text-align:center; font-weight:800">${balDisplay}</td><td>${act?'<i class="fas fa-check-circle" style="color:var(--success)"></i>':'<i class="fas fa-times-circle" style="color:var(--danger)"></i>'}</td></tr>`;
        if(w[k].cur=="$") td+=w[k].bal; else ts+=w[k].bal;
    }
    walletList.innerHTML=rows;
    if(!isRestricted) {
        statDollar.textContent=fix(td)+" $"; statShekel.textContent=fix(ts)+" โช";
    }
}
function refreshHistory(){
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let rows = "";
    safeJSON(localStorage.purchases, []).slice().reverse().forEach(p=>{
        let phoneD = isRestricted ? '----' : p.phone;
        let subD = isRestricted ? '----' : `<span class="badge badge-info">${p.sub}</span>`;
        let paidD = isRestricted ? '----' : p.paid;
        let costD = isRestricted ? '----' : p.cost;
        let walletD = isRestricted ? '----' : p.wallet;
        rows+=`<tr><td>${p.date}</td><td><b>${p.customer}</b></td><td>${phoneD}</td><td>${subD}</td><td>${p.duration||'-'} ุดูุฑ</td><td style="color:var(--success)">${paidD}</td><td style="color:var(--danger)">${costD}</td><td>${walletD}</td></tr>`;
    });
    historyBody.innerHTML = rows;
}
function filterHistory() { let v = document.getElementById("historySearch").value.toLowerCase(); document.querySelectorAll("#historyBody tr").forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? "" : "none"); }
function refreshInvestment(){
    let i=safeJSON(localStorage.invest, {});
    let isRestricted = currentUser ? (currentUser.role === 'viewer') : true;
    let aD = isRestricted ? "****" : `${fix(i.ahmad.d)}$ | ${fix(i.ahmad.s)}โช`;
    let mD = isRestricted ? "****" : `${fix(i.mohamed.d)}$ | ${fix(i.mohamed.s)}โช`;
    let sD = isRestricted ? "****" : `${fix(i.store.d)}$ | ${fix(i.store.s)}โช`;
    
    investBox.innerHTML=`<div class="card" style="border-top:5px solid var(--success)"><div>ุญุตุฉ ุฃุญูุฏ</div><div style="font-size:22px; font-weight:900">${aD}</div></div><div class="card" style="border-top:5px solid var(--accent)"><div>ุญุตุฉ ูุญูุฏ</div><div style="font-size:22px; font-weight:900">${mD}</div></div><div class="card" style="border-top:5px solid var(--primary)"><div>ุฑุฃุณ ูุงู ุงููุชุฌุฑ</div><div style="font-size:22px; font-weight:900">${sD}</div></div>`;
}
function refreshAnalytics() {
    let invest = safeJSON(localStorage.invest, {}), purchases = safeJSON(localStorage.purchases, []);
    if (myProfitChart) myProfitChart.destroy();
    
    // Hide profit chart for viewer
    if(currentUser && currentUser.role === 'viewer') {
        // Empty or dummy chart
    } else {
        myProfitChart = new Chart(document.getElementById('profitChart').getContext('2d'), { type: 'doughnut', data: { labels: ['ุฃุญูุฏ', 'ูุญูุฏ', 'ุงููุชุฌุฑ'], datasets: [{ data: [invest.ahmad.d*3.5+invest.ahmad.s, invest.mohamed.d*3.5+invest.mohamed.s, invest.store.d*3.5+invest.store.s], backgroundColor: ['#10b981', '#f59e0b', '#6366f1'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    
    let months = {}, labels = [], data = [];
    for(let i=5; i>=0; i--){ let d = new Date(); d.setMonth(d.getMonth() - i); labels.push((d.getMonth()+1)+'/'+d.getFullYear()); months[labels[labels.length-1]] = 0; }
    purchases.forEach(p => { let d = new Date(p.date), k = (d.getMonth()+1)+'/'+d.getFullYear(); if(months[k] !== undefined) months[k]++; });
    labels.forEach(l => data.push(months[l]));
    
    if (mySalesChart) mySalesChart.destroy();
    mySalesChart = new Chart(document.getElementById('salesChart').getContext('2d'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'ูุจูุนุงุช', data: data, backgroundColor: '#6366f1', borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
}
function addGeneralNote(){ let t=gnText.value.trim(); if(!t)return; let n=safeJSON(localStorage.generalNotes, []); n.push({text:t, date:new Date().toLocaleString("ar-EG")}); localStorage.generalNotes=JSON.stringify(n); gnText.value=""; logAction("ุฅุถุงูุฉ ููุงุญุธุฉ ุฌุฏูุฏุฉ"); refreshGeneralNotes(); pushToGithub(); }
function refreshGeneralNotes(){ 
    let n = safeJSON(localStorage.generalNotes, []); 
    let box = document.getElementById("generalNotesBox");
    if(!box) return; 
    if(currentUser && currentUser.role === 'viewer') { box.innerHTML = ""; return; }
    let rows = "";
    n.forEach((x,i)=>{ 
        let isViewerPlus = currentUser ? (currentUser.role === 'viewer_plus') : true;
        let delBtn = isViewerPlus ? '' : `<i class="fas fa-trash" onclick="deleteNote(${i})" style="color:var(--danger); cursor:pointer"></i>`;
        rows += `<div class="todo-item" style="border-right-color:var(--primary)"><div><small>${x.date}</small><div>${x.text}</div></div>${delBtn}</div>`; 
    }); 
    box.innerHTML = rows;
}
function deleteNote(i){ if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; let n=safeJSON(localStorage.generalNotes, []); n.splice(i,1); localStorage.generalNotes=JSON.stringify(n); logAction("ุญุฐู ููุงุญุธุฉ"); refreshGeneralNotes(); pushToGithub(); }
function addTodo(){ let t=todoInput.value.trim(); if(!t)return; let l=safeJSON(localStorage.todoList, []); l.push({text:t, date:new Date().toLocaleString("ar-EG")}); localStorage.todoList=JSON.stringify(l); todoInput.value=""; logAction("ุฅุถุงูุฉ ูููุฉ ุฌุฏูุฏุฉ"); refreshTodoList(); pushToGithub(); }
function refreshTodoList(){ 
    let l=safeJSON(localStorage.todoList, []); 
    let rows=""; 
    l.forEach((x,i)=>{ rows+=`<div class="todo-item"><div>${x.text}</div><button class="btn btn-primary" style="padding:5px 10px" onclick="completeTodo(${i})">ุชูุช</button></div>`; }); 
    todoBox.innerHTML=rows;
}
function completeTodo(i){ let l=safeJSON(localStorage.todoList, []); logAction(`ุฅููุงู ูููุฉ: ${l[i].text}`); l.splice(i,1); localStorage.todoList=JSON.stringify(l); refreshTodoList(); pushToGithub(); }

// --- ENHANCED WITHDRAWAL LOGIC ---
async function withdrawPartial(p){ 
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท","error");
    
    let input = document.getElementById(p==='ahmad'?'withdrawAhmad':p==='mohamed'?'withdrawMohamed':'withdrawStore');
    let walletSelect = document.getElementById(p==='ahmad'?'wWalletAhmad':p==='mohamed'?'wWalletMohamed':'wWalletStore');
    
    let amount = +input.value;
    let walletName = walletSelect.value;

    if(!amount) return notify("ุฃุฏุฎู ุงููุจูุบ","error");
    if(!walletName) return notify("ูุฑุฌู ุงุฎุชูุงุฑ ุงููุญูุธุฉ ุงูุชู ุณูุชู ุงูุฏูุน ูููุง","error");

    let reason = await showPrompt("ุณุจุจ ุงูุณุญุจ", "ูุฐุง ุงูุญูู ุฅุฌุจุงุฑู", "ุฃุฏุฎู ุณุจุจ ุงูุณุญุจ...", "๐ธ");
    if(!reason) return notify("ุชู ุงูุฅูุบุงุก: ุงูุณุจุจ ูุทููุจ","error");

    let i = safeJSON(localStorage.invest, {});
    let w = safeJSON(localStorage.wallets, {});
    
    let wallet = w[walletName];
    let currency = wallet.cur; // '$' or 'โช'
    
    // Determine which share to deduct from based on Wallet Currency
    let shareType = (currency === '$') ? 'd' : 's';

    // Check Profit Balance
    if(i[p][shareType] < amount) { notify(`ุฑุตูุฏ ุงูุญุตุฉ (${currency}) ุบูุฑ ูุงูู ููุณุญุจ`,"error"); return; }
    
    if(wallet.bal < amount) {
        notify(`ุฑุตูุฏ ุงููุญูุธุฉ (${walletName}) ุบูุฑ ูุงูู.`, "error");
        return;
    }

    // EXECUTE
    let shareBefore = i[p][shareType];
    let walletBefore = wallet.bal;

    i[p][shareType] -= amount; // Deduct from Profit Share (same currency)
    w[walletName].bal -= amount; // Deduct from Wallet (same currency)

    localStorage.invest = JSON.stringify(i); 
    localStorage.wallets = JSON.stringify(w);

    logAction(`ุณุญุจ ุฃุฑุจุงุญ ูู ุญุตุฉ ${p} ุนุจุฑ ${walletName}`, {
        type: 'withdraw',
        person: p,
        amount: amount,
        currency: currency,
        walletName: walletName,
        deductedFromWallet: amount,
        reason: reason,
        shareBefore: shareBefore,
        shareAfter: i[p][shareType],
        walletBefore: walletBefore,
        walletAfter: w[walletName].bal
    });

    refreshInvestment(); refreshWallets(); input.value=""; 
    pushToGithub(); notify("ุชู ุงูุณุญุจ ุจูุฌุงุญ");
}

function addNewWallet(){ let n=newWalletName.value.trim(), c=newWalletCurrency.value, w=safeJSON(localStorage.wallets, {}); if(!n||w[n]) return notify("ุฎุทุฃ ุจุงูุงุณู","error"); w[n]={bal:0, cur:c, active:true}; localStorage.wallets=JSON.stringify(w); loadWallets(); refreshWallets(); newWalletName.value=""; logAction(`ุฅูุดุงุก ูุญูุธุฉ ุฌุฏูุฏุฉ: ${n}`); pushToGithub(); notify("ุชูุช"); }
function renameWallet(){ let o=renameWalletSelect.value, n=renameWalletInput.value.trim(), w=safeJSON(localStorage.wallets, {}); if(!n||w[n]) return notify("ุฎุทุฃ","error"); w[n]=w[o]; delete w[o]; localStorage.wallets=JSON.stringify(w); let p=safeJSON(localStorage.purchases, []); p.forEach(x=>{if(x.wallet===o)x.wallet=n}); localStorage.purchases=JSON.stringify(p); loadWallets(); refreshAll(); renameWalletInput.value=""; logAction(`ุชุบููุฑ ุงุณู ูุญูุธุฉ ูู ${o} ุฅูู ${n}`); pushToGithub(); notify("ุชู"); }

// --- TRANSFER LOGIC: DEDUCT FEE FROM STORE CAPITAL (AUTO CURRENCY) ---
function calculateTransfer() {
    let amount = parseFloat(document.getElementById("tfAmount").value) || 0;
    let fee = parseFloat(document.getElementById("tfFee").value) || 0;
    let rate = parseFloat(document.getElementById("tfRate").value) || 1;
    
    // Logic: Fee is part of the total deducted from source wallet.
    // Net amount to be converted = Amount - Fee
    let net = amount - fee;
    
    // Auto-Calculate Direction based on Currencies (Visual Only)
    let from = document.getElementById("tfFromWallet").value;
    let to = document.getElementById("tfToWallet").value;
    let w = safeJSON(localStorage.wallets, {});
    
    let result = 0;
    if(from && to && w[from] && w[to]) {
        let fromCur = w[from].cur;
        let toCur = w[to].cur;
        
        if(fromCur === toCur) {
            result = net; // Same currency
        } else if (fromCur === '$' && toCur === 'โช') {
            // USD to ILS -> Multiply by rate
            result = net * rate;
        } else if (fromCur === 'โช' && toCur === '$') {
            // ILS to USD -> Divide by rate
            result = net / rate;
        }
    }
    
    document.getElementById("tfResult").value = result.toFixed(2);
}

function executeTransfer() {
    let from = document.getElementById("tfFromWallet").value;
    let to = document.getElementById("tfToWallet").value;
    let amount = parseFloat(document.getElementById("tfAmount").value);
    let fee = parseFloat(document.getElementById("tfFee").value) || 0;
    let rate = parseFloat(document.getElementById("tfRate").value) || 1;
    let result = parseFloat(document.getElementById("tfResult").value);

    if(!amount || !from || !to) return notify("ูุฑุฌู ุชุนุจุฆุฉ ุงูุจูุงูุงุช", "error");
    if(from === to) return notify("ูุง ูููู ุงูุชุญููู ูููุณ ุงููุญูุธุฉ", "error");

    let w = safeJSON(localStorage.wallets, {});
    if(w[from].bal < amount) return notify("ุงูุฑุตูุฏ ุบูุฑ ูุงูู", "error");

    let fromCur = w[from].cur;
    let toCur = w[to].cur;

    // 1. Deduct Full Amount from Source
    w[from].bal -= amount;
    
    // 2. Add Result to Destination
    w[to].bal += result;

    // 3. CLOSED LOOP FIX: Deduct Fee from Store Capital using SOURCE Currency
    let invest = safeJSON(localStorage.invest, {});
    
    if(fee > 0) {
        if(fromCur === '$') {
            invest.store.d -= fee;
        } else {
            invest.store.s -= fee;
        }
    }

    localStorage.wallets = JSON.stringify(w);
    localStorage.invest = JSON.stringify(invest);
    
    logAction(`ุชุญููู ูู ${from} ุฅูู ${to}`, {
        type: 'transfer',
        from: from,
        to: to,
        amount: amount,
        fee: fee,
        feeCur: fromCur,
        rate: rate,
        result: result,
        netAmount: amount - fee,
        fromCur: fromCur,
        toCur: toCur
    });

    refreshWallets(); 
    refreshInvestment(); // Update investment display
    pushToGithub(); 
    notify("ุชู ุงูุชุญููู ูุฎุตู ุงูุนูููุฉ ูู ุงููุชุฌุฑ");
    
    // Reset inputs
    document.getElementById("tfAmount").value = "";
    document.getElementById("tfFee").value = "0";
    document.getElementById("tfResult").value = "";
}

function addToWallet(){ 
    // Legacy function support if needed, but UI now uses setWallet logic mainly or explicit ops
    // Keeping for safety if older buttons exist, though removed from this UI
}

async function setWallet(){ 
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท", "error");
    
    let reason = await showPrompt("ุณุจุจ ุงูุชุนููู ุงููุจุงุดุฑ", "ูุฐุง ุงูุญูู ุฅุฌุจุงุฑู", "ุฃุฏุฎู ุณุจุจ ุงูุชุนููู...", "๐ผ");
    if(!reason) return;
    
    let w=safeJSON(localStorage.wallets, {}); 
    let before = w[modWallet.value].bal;
    w[modWallet.value].bal = +modAmount.value; 
    localStorage.wallets=JSON.stringify(w); 
    
    logAction(`ุชุนููู ุฑุตูุฏ ูุญูุธุฉ ${modWallet.value}`, {
        type: 'manual',
        wallet: modWallet.value,
        reason: reason,
        before: before,
        after: w[modWallet.value].bal,
        diff: (+modAmount.value - before)
    });
    refreshWallets(); pushToGithub(); notify("ุชู"); 
}

async function setProfitShare() {
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท", "error");

    let person = document.getElementById("setSharePerson").value;
    let currency = document.getElementById("setShareCurrency").value;
    let amount = parseFloat(document.getElementById("setShareAmount").value);

    if(isNaN(amount)) return notify("ุฃุฏุฎู ุงูุฑุตูุฏ ุงูุฌุฏูุฏ", "error");
    
    let reason = await showPrompt("ุณุจุจ ุชุนุฏูู ุงูุญุตุฉ", "ูุฐุง ุงูุญูู ุฅุฌุจุงุฑู", "ุฃุฏุฎู ุงูุณุจุจ...", "๐");
    if(!reason) return;

    let invest = safeJSON(localStorage.invest, {});
    let before = invest[person][currency];

    invest[person][currency] = amount;
    localStorage.invest = JSON.stringify(invest);

    logAction(`ุชุนุฏูู ูุจุงุดุฑ ูุญุตุฉ ${person}`, {
        type: 'manual_invest',
        person: person,
        currency: currency,
        reason: reason,
        before: before,
        after: amount
    });

    refreshInvestment();
    pushToGithub();
    notify("ุชู ุชุญุฏูุซ ุงูุญุตุฉ");
}

async function deleteWallet(){ 
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท", "error"); 
    let ok = await showConfirm("ุญุฐู ุงููุญูุธุฉ", `ูู ุชุฑูุฏ ุญุฐู ูุญูุธุฉ "${modWallet.value}" ููุงุฆูุงูุ`, "ุญุฐู", "ุฅูุบุงุก", "๐๏ธ");
    if(!ok) return;
    let w=safeJSON(localStorage.wallets, {}); delete w[modWallet.value]; localStorage.wallets=JSON.stringify(w); logAction(`ุญุฐู ูุญูุธุฉ ${modWallet.value}`); loadWallets(); refreshWallets(); pushToGithub(); notify("ุชู ุงูุญุฐู"); 
}
function exportData(){ if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return; let a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(localStorage)],{type:"application/json"})); a.download=`MegaBackup_${new Date().toLocaleDateString()}.json`; a.click(); logAction("ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ"); }
function importData(){ 
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท","error");
    let f=importFile.files[0], r=new FileReader(); 
    r.onload=async (e)=>{ try{ let d=JSON.parse(e.target.result); Object.keys(d).forEach(k=>localStorage.setItem(k,d[k])); notify("ุชู ุงูุงุณุชุนุงุฏุฉุ ุฌุงุฑู ุงูุชุญุฏูุซ..."); logAction("ุงุณุชูุฑุงุฏ ุจูุงูุงุช ูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ"); await pushToGithub(true); location.reload(); }catch(err){notify("ููู ุชุงูู","error");} }; 
    if(f) r.readAsText(f); else notify("ุงุฎุชุฑ ููู","error"); 
}
async function undoLastPurchase(){ 
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return;
    
    let purchases = safeJSON(localStorage.purchases, []);
    if(purchases.length === 0) return notify("ูุง ุชูุฌุฏ ุนูููุงุช ููุชุฑุงุฌุน ุนููุง", "error");
    
    let ok = await showConfirm("ุชุฑุงุฌุน ุนู ุขุฎุฑ ุนูููุฉ", "ุณูุชู ุงุณุชุนุงุฏุฉ ุฌููุน ุงูุฃุฑุตุฏุฉ ูุงูุญุตุต. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ", "ูุนูุ ุชุฑุงุฌุน", "ูุงุ ุฅูุบุงุก", "โฉ๏ธ");
    if(!ok) return;
    
    let lastP = purchases.pop();
    let wallets = safeJSON(localStorage.wallets, {});
    
    // RESTORE WALLETS
    if(lastP.fromWallet && wallets[lastP.fromWallet]) {
        wallets[lastP.fromWallet].bal += parseFloat(lastP.cost);
    }
    if(lastP.wallet && wallets[lastP.wallet]) {
        wallets[lastP.wallet].bal -= parseFloat(lastP.paid);
    }
    
    localStorage.wallets = JSON.stringify(wallets);
    localStorage.purchases = JSON.stringify(purchases);
    
    // RESTORE INVEST SNAPSHOT - precise undo of profit shares
    if(lastP.investSnapshot) {
        localStorage.invest = JSON.stringify(lastP.investSnapshot);
    }
    
    logAction("ุชุฑุงุฌุน ุนู ุนูููุฉ ุดุฑุงุก", { type: 'undo', data: lastP, refunded: lastP.cost, deducted: lastP.paid });
    
    refreshAll(); pushToGithub(); notify("ุชู ุงูุชุฑุงุฌุน ูุงุณุชุนุงุฏุฉ ุฌููุน ุงูุฃุฑุตุฏุฉ ูุงูุญุตุต ุจุฏูุฉ"); 
}
async function clearHistory(){ 
    if(currentUser.role !== 'admin') return notify("ููุฃุฏูู ููุท","error"); 
    let ok = await showConfirm("ูุณุญ ุณุฌู ุงูุนูููุงุช", "ุณูุชู ุญุฐู ุฌููุน ุงูุนูููุงุช ุงููุงููุฉ ุงููุณุฌูุฉ ููุงุฆูุงู. ูุง ูููู ุงูุชุฑุงุฌุน!", "ูุณุญ ุงููู", "ุฅูุบุงุก", "๐๏ธ");
    if(ok){ localStorage.purchases="[]"; logAction("ูุณุญ ุณุฌู ุงูุนูููุงุช ุจุงููุงูู"); refreshHistory(); pushToGithub(); notify("ุชู ุงููุณุญ"); } 
}

// --- EDIT USER MODAL FUNCTIONS ---
function closeEditUserModal(e) { if(e === 'force' || e.target.id === 'editUserModal') document.getElementById("editUserModal").classList.add("hidden"); }

function openEditUserModal(index) {
    let users = safeJSON(localStorage.users, []), u = users[index];
    document.getElementById("editUserIndex").value = index;
    document.getElementById("editUserName").value = u.username;
    document.getElementById("editUserPassInput").value = "";
    document.getElementById("editUserRoleSelect").value = u.role;
    document.getElementById("editUserModal").classList.remove("hidden");
}

async function saveUserEdit() {
    let index = +document.getElementById("editUserIndex").value;
    let newPass = document.getElementById("editUserPassInput").value.trim();
    let newRole = document.getElementById("editUserRoleSelect").value;
    let users = safeJSON(localStorage.users, []);
    if(newPass) users[index].password = newPass;
    if(users[index].username === currentUser.username && newRole !== 'admin') {
        let ok = await showConfirm("ุชุบููุฑ ุตูุงุญูุชู", "ุณุชููู ุตูุงุญูุชู ูู ุฃุฏูู. ูู ุฃูุช ูุชุฃูุฏุ", "ูุนู", "ุฅูุบุงุก", "โ๏ธ");
        if(!ok) return;
    }
    users[index].role = newRole;
    localStorage.users = JSON.stringify(users);
    logAction(`ุชุนุฏูู ุจูุงูุงุช ุงููุณุชุฎุฏู: ${users[index].username}`);
    document.getElementById("editUserModal").classList.add("hidden");
    renderUsersTable(); pushToGithub(); notify("ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู");
}

// --- STOCK FUNCTIONS ---
function closeStockModal(e) { if(e === 'force' || e.target.id === 'stockModal') document.getElementById("stockModal").classList.add("hidden"); }

function openAddStockModal() {
    document.getElementById("stockModalTitle").innerText = "ุฅุถุงูุฉ ุงุดุชุฑุงู ูููุฎุฒูู";
    document.getElementById("stockIndex").value = "-1";
    ["stService","stEmail","stPass","stNotes"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("stDuration").value = "1";
    document.getElementById("stockModal").classList.remove("hidden");
}

function saveStock() {
    let index = +document.getElementById("stockIndex").value;
    let s = {
        id: index === -1 ? Date.now() + '_' + Math.random().toString(36).substr(2,5) : (safeJSON(localStorage.stock, [])[index]?.id || Date.now()),
        service: document.getElementById("stService").value.trim(),
        duration: document.getElementById("stDuration").value,
        email: document.getElementById("stEmail").value.trim(),
        pass: document.getElementById("stPass").value,
        notes: document.getElementById("stNotes").value,
        date: new Date().toLocaleDateString('ar-EG'),
        timestamp: new Date().getTime()
    };
    if(!s.service) return notify("ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงูุฎุฏูุฉ", "error");
    let stock = safeJSON(localStorage.stock, []);
    if(index === -1) { stock.push(s); logAction(`ุฅุถุงูุฉ ุงุดุชุฑุงู ูููุฎุฒูู: ${s.service}`); }
    else { stock[index] = s; logAction(`ุชุนุฏูู ุงุดุชุฑุงู ูู ุงููุฎุฒูู: ${s.service}`); }
    localStorage.stock = JSON.stringify(stock);
    document.getElementById("stockModal").classList.add("hidden");
    refreshStock(); pushToGithub(); notify("ุชู ุงูุญูุธ ุจูุฌุงุญ");
}

function refreshStock() {
    let stock = safeJSON(localStorage.stock, []);
    let tbody = document.getElementById("stockBody"); if(!tbody) return;
    let rows = "";
    stock.forEach((item, i) => {
        let purchaseDate = new Date(item.timestamp);
        let expiryDate = new Date(purchaseDate);
        expiryDate.setMonth(expiryDate.getMonth() + parseInt(item.duration));
        let daysLeft = Math.max(0, Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24)));
        rows += `<tr>
            <td><span class="badge badge-info">${item.service}</span></td>
            <td class="eng-num">${item.date}</td>
            <td class="eng-num">${item.duration} ุดูุฑ</td>
            <td class="eng-num"><span class="badge ${daysLeft===0?'badge-danger':'badge-warning'}">${daysLeft} ููู</span></td>
            <td><button class="btn btn-primary" style="padding:5px 10px" onclick="editStock(${i})"><i class="fas fa-eye"></i></button></td>
            <td><button class="btn" style="padding:5px 10px; background:var(--success); color:#fff" onclick="sellStock(${i})"><i class="fas fa-check"></i> ุจูุน</button></td>
        </tr>`;
    });
    tbody.innerHTML = rows || "<tr><td colspan='6' style='text-align:center; padding:20px; color:var(--text-muted)'>ูุง ููุฌุฏ ุงุดุชุฑุงูุงุช ูู ุงููุฎุฒูู</td></tr>";
}

function editStock(i) {
    let stock = safeJSON(localStorage.stock, []), item = stock[i];
    document.getElementById("stockModalTitle").innerText = "ุชูุงุตูู ุงูุงุดุชุฑุงู (ุชุนุฏูู)";
    document.getElementById("stockIndex").value = i;
    document.getElementById("stService").value = item.service;
    document.getElementById("stDuration").value = item.duration;
    document.getElementById("stEmail").value = item.email;
    document.getElementById("stPass").value = item.pass;
    document.getElementById("stNotes").value = item.notes;
    document.getElementById("stockModal").classList.remove("hidden");
}

async function sellStock(i) {
    let ok = await showConfirm("ุจูุน ุงูุงุดุชุฑุงู", "ุณูุชู ุฅุฒุงูุฉ ูุฐุง ุงูุงุดุชุฑุงู ูู ุงููุฎุฒูู.", "ุจูุน", "ุฅูุบุงุก", "โ");
    if(!ok) return;
    let stock = safeJSON(localStorage.stock, []);
    let removed = stock.splice(i, 1);
    localStorage.stock = JSON.stringify(stock);
    logAction(`ุจูุน ุงุดุชุฑุงู ูู ุงููุฎุฒูู: ${removed[0].service}`);
    refreshStock(); pushToGithub(); notify("ุชู ุจูุน ุงูุงุดุชุฑุงู");
}

// --- EXPORT HISTORY TO CSV (Excel) ---
function exportHistoryCSV() {
    if(currentUser.role === 'viewer' || currentUser.role === 'viewer_plus') return notify("ููุณ ูุฏูู ุตูุงุญูุฉ","error");
    let purchases = safeJSON(localStorage.purchases, []);
    if(purchases.length === 0) return notify("ูุง ุชูุฌุฏ ุนูููุงุช ููุชุตุฏูุฑ","error");
    
    let bom = "\uFEFF"; // UTF-8 BOM for Arabic support in Excel
    let header = ["ุงูุชุงุฑูุฎ","ุงูุนููู","ุงูุฌูุงู","ุงูุฎุฏูุฉ","ุงููุฏุฉ","ุงููุฏููุน","ุงูุชูููุฉ","ุงููุญูุธุฉ"].join(",");
    let rows = purchases.slice().reverse().map(p => [
        `"${p.date}"`,
        `"${p.customer}"`,
        `"${p.phone||'-'}"`,
        `"${p.sub}"`,
        `"${p.duration||'-'} ุดูุฑ"`,
        `"${p.paid}"`,
        `"${p.cost}"`,
        `"${p.wallet}"`
    ].join(",")).join("\n");
    
    let csv = bom + header + "\n" + rows;
    let blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
    let a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MegaStore_Archive_${new Date().toLocaleDateString('en')}.csv`;
    a.click();
    logAction("ุชุตุฏูุฑ ุงูุฃุฑุดูู ุงููุงูู ุฅูู Excel (CSV)");
    notify("โ ุชู ุชุตุฏูุฑ ุงูููู");
}

// --- PRINT/PDF HISTORY ---
function printHistory() {
    if(currentUser.role === 'viewer') return notify("ููุณ ูุฏูู ุตูุงุญูุฉ","error");
    // Make sure history is visible then print
    let histCard = document.getElementById("history");
    let wasHidden = histCard.classList.contains("hidden");
    if(wasHidden) {
        document.querySelectorAll(".card").forEach(x=>x.classList.add("hidden"));
        histCard.classList.remove("hidden");
    }
    window.print();
    if(wasHidden) {
        histCard.classList.add("hidden");
        document.getElementById("purchase").classList.remove("hidden");
    }
    logAction("ุทุจุงุนุฉ/ุชุตุฏูุฑ PDF ููุฃุฑุดูู ุงููุงูู");
}

// --- GLOBAL SEARCH ---
function runGlobalSearch() {
    let q = document.getElementById("globalSearchInput").value.trim().toLowerCase();
    let resultsDiv = document.getElementById("globalSearchResults");
    
    if(q.length < 2) { resultsDiv.style.display = "none"; return; }
    
    let results = [];
    let purchases = safeJSON(localStorage.purchases, []);
    let notes = safeJSON(localStorage.generalNotes, []);
    let stock = safeJSON(localStorage.stock, []);
    
    // Search purchases
    purchases.forEach((p, i) => {
        if((p.customer||'').toLowerCase().includes(q) || (p.sub||'').toLowerCase().includes(q) || (p.phone||'').includes(q)) {
            results.push({ tag: "ุนูููุฉ", text: `${p.customer} - ${p.sub} (${p.date})`, action: () => showPage('history', document.getElementById('btnHistory')) });
        }
    });
    
    // Search notes
    notes.forEach((n, i) => {
        if((n.text||'').toLowerCase().includes(q)) {
            results.push({ tag: "ููุงุญุธุฉ", text: n.text.substring(0,60), action: () => showPage('generalNotes', document.getElementById('btnNotes')) });
        }
    });
    
    // Search stock
    stock.forEach((s, i) => {
        if((s.service||'').toLowerCase().includes(q) || (s.email||'').toLowerCase().includes(q)) {
            results.push({ tag: "ูุฎุฒูู", text: `${s.service} - ${s.email||''}`, action: () => showPage('stock', document.getElementById('btnStock')) });
        }
    });
    
    if(results.length === 0) {
        resultsDiv.innerHTML = `<div class="sr-empty"><i class="fas fa-search"></i> ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูู "${q}"</div>`;
    } else {
        resultsDiv.innerHTML = results.slice(0, 10).map((r, i) => 
            `<div class="sr-item" onclick="selectSearchResult(${i})" data-idx="${i}">
                <span class="sr-tag">${r.tag}</span> ${r.text}
            </div>`
        ).join('');
        resultsDiv._results = results;
    }
    
    resultsDiv.style.display = "block";
}

function selectSearchResult(i) {
    let results = document.getElementById("globalSearchResults")._results;
    if(results && results[i]) {
        results[i].action();
        hideSearchResults();
        document.getElementById("globalSearchInput").value = "";
    }
}

function hideSearchResults() {
    document.getElementById("globalSearchResults").style.display = "none";
}

// --- AUTO NOTIFY EXPIRING SUBSCRIPTIONS ON LOGIN ---
function checkExpiringOnLogin() {
    let p = safeJSON(localStorage.purchases, []);
    let now = new Date().getTime(), days3 = 3 * 86400000;
    let expiring = p.filter(x => x.expiry && !x.expiryDismissed && (x.expiry - now < days3 && x.expiry - now > -2592000000));
    
    if(expiring.length > 0) {
        let expired = expiring.filter(x => x.expiry < now).length;
        let soon = expiring.length - expired;
        
        setTimeout(() => {
            if(expired > 0) notify(`โ๏ธ ${expired} ุงุดุชุฑุงู ููุชูู ุงูุตูุงุญูุฉ`, "error");
            if(soon > 0) setTimeout(() => notify(`๐ ${soon} ุงุดุชุฑุงู ููุชูู ุฎูุงู 3 ุฃูุงู`, "error"), 1000);
        }, 1500);
        
        // Update badge
        let badge = document.getElementById("expiryBadge");
        if(badge) { badge.textContent = expiring.length; badge.style.display = "inline-flex"; }
    }
}

window.onload=init;
</script>
</body>
</html>
