<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mega Store Pro | Closed System</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%236366f1' d='M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7l5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5H488c13.3 0 24 10.7 24 24s-10.7 24-24 24H199.7c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5H24C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z'/%3E%3C/svg%3E">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6366f1; 
            --primary-dark: #4f46e5; 
            --accent: #f59e0b;
            --success: #10b981; 
            --danger: #ef4444;
            --bg-body: #f8fafc; 
            --bg-card: #ffffff; 
            --bg-input: #f8fafc; 
            --bg-sidebar: #0f172a;
            --text-main: #1e293b; 
            --text-muted: #64748b; 
            --border-color: #e2e8f0;
            --stat-card-border: rgba(255,255,255,0.8);
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --yellow-bg: #fefce8; 
            --yellow-border: #fde047; 
            --yellow-text: #854d0e;
            --yellow-item-bg: #fffbeb; 
            --yellow-item-border: #eab308; 
            --yellow-item-text: #713f12;
            --yellow-btn-bg: #eab308; 
            --yellow-btn-hover: #ca8a04;
        }
        
        body.dark-mode {
            --bg-body: #0f172a; 
            --bg-card: #1e293b; 
            --bg-input: #334155; 
            --bg-sidebar: #020617;
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8; 
            --border-color: #334155;
            --stat-card-border: #334155; 
            --card-shadow: none;
            --yellow-bg: rgba(234, 179, 8, 0.1); 
            --yellow-border: rgba(234, 179, 8, 0.3);
            --yellow-text: #fde047; 
            --yellow-item-bg: rgba(234, 179, 8, 0.15);
            --yellow-item-border: #eab308; 
            --yellow-item-text: #fef08a;
            --yellow-btn-bg: #eab308; 
            --yellow-btn-hover: #ca8a04;
        }
        
        body.dark-mode .stat-icon[style*="#e0e7ff"] { 
            background: rgba(99, 102, 241, 0.2) !important; 
            color: #818cf8 !important; 
        }
        body.dark-mode .stat-icon[style*="#dcfce7"] { 
            background: rgba(16, 185, 129, 0.2) !important; 
            color: #34d399 !important; 
        }
        body.dark-mode .stat-icon[style*="#fef3c7"] { 
            background: rgba(245, 158, 11, 0.2) !important; 
            color: #fbbf24 !important; 
        }
        
        * { 
            box-sizing: border-box; 
            font-family: 'Tajawal', 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
        }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background-color: #cbd5e1; 
            border-radius: 20px; 
            border: 2px solid transparent; 
            background-clip: content-box; 
        }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }
        body.dark-mode ::-webkit-scrollbar-thumb { background-color: #334155; }
        body.dark-mode ::-webkit-scrollbar-thumb:hover { background-color: var(--primary); }

        html, body { 
            width: 100%; 
            height: 100%; 
            overflow-x: hidden; 
            position: relative; 
        }
        
        body { 
            background: var(--bg-body); 
            margin: 0; 
            color: var(--text-main); 
            display: flex; 
            min-height: 100vh; 
            transition: background 0.3s, color 0.3s; 
        }
        
        /* --- MODAL STYLES --- */
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            z-index: 300000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(5px); 
            animation: fadeIn 0.3s; 
            padding: 20px;
        }
        
        .modal-content { 
            background: var(--bg-card); 
            width: 100%; 
            max-width: 500px; 
            padding: 24px; 
            border-radius: 24px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            border: 1px solid var(--border-color); 
            color: var(--text-main); 
            transform: translateY(20px); 
            animation: slideUp 0.3s forwards; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        
        @keyframes slideUp { to { transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .detail-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px 0; 
            border-bottom: 1px solid var(--border-color);
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .detail-row:last-child { border-bottom: none; }
        
        .detail-label { 
            font-weight: 600; 
            color: var(--text-muted);
            min-width: 100px;
        }
        
        .detail-value { 
            font-weight: 700; 
            color: var(--text-main);
            text-align: left;
        }
        
        .val-inc { color: var(--success); } 
        .val-dec { color: var(--danger); }

        /* --- LOGIN STYLES --- */
        .login-overlay { 
            position: fixed; 
            top:0; 
            left:0; 
            width:100%; 
            height:100%; 
            background: linear-gradient(135deg, #1e1b4b 0%, #4338ca 100%); 
            z-index: 200000; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
            overflow: hidden; 
        }
        
        .login-overlay::before { 
            content: ''; 
            position: absolute; 
            width: 600px; 
            height: 600px; 
            background: rgba(99, 102, 241, 0.15); 
            border-radius: 50%; 
            top: -100px; 
            left: -100px; 
            animation: float 10s infinite ease-in-out; 
        }
        
        .login-overlay::after { 
            content: ''; 
            position: absolute; 
            width: 400px; 
            height: 400px; 
            background: rgba(245, 158, 11, 0.1); 
            border-radius: 50%; 
            bottom: -50px; 
            right: -50px; 
            animation: float 8s infinite ease-in-out reverse; 
        }
        
        @keyframes float { 
            0% { transform: translate(0, 0); } 
            50% { transform: translate(20px, 40px); } 
            100% { transform: translate(0, 0); } 
        }
        
        .login-card { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 40px 30px; 
            border-radius: 30px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            width: 100%; 
            max-width: 420px; 
            text-align: center; 
            position: relative; 
            z-index: 10; 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.3); 
            transform: translateY(20px); 
            opacity: 0; 
            animation: slideUpFade 0.6s forwards 0.2s; 
            transition: background 0.3s, border-color 0.3s; 
        }
        
        body.dark-mode .login-card { 
            background: rgba(30, 41, 59, 0.95); 
            border-color: rgba(255,255,255,0.1); 
        }
        
        body.dark-mode .login-card h2 { color: #f1f5f9; } 
        body.dark-mode .login-card p { color: #94a3b8; }
        
        @keyframes slideUpFade { to { transform: translateY(0); opacity: 1; } }
        
        .login-icon-wrap { 
            width: 90px; 
            height: 90px; 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin: 0 auto 20px auto; 
            color: white; 
            font-size: 36px; 
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); 
            animation: pulseIcon 3s infinite; 
        }
        
        @keyframes pulseIcon { 
            0% { 
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); 
                transform: scale(1); 
            } 
            50% { transform: scale(1.05); } 
            70% { box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); } 
            100% { 
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); 
                transform: scale(1); 
            } 
        }
        
        .login-card h2 { 
            color: #1e293b; 
            margin-bottom: 5px; 
            font-weight: 800; 
            font-size: 24px; 
        }
        
        .login-card p { 
            color: #64748b; 
            margin-bottom: 30px; 
            font-size: 14px; 
        }
        
        .custom-input { 
            position: relative; 
            margin-bottom: 20px; 
        }
        
        .custom-input i { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #94a3b8; 
            transition: 0.3s; 
        }
        
        .custom-input input { 
            width: 100%; 
            padding: 14px 45px 14px 15px; 
            border-radius: 16px; 
            border: 2px solid #e2e8f0; 
            background: #f8fafc; 
            color: #1e293b; 
            font-size: 15px; 
            transition: all 0.3s; 
            outline: none; 
        }
        
        .custom-input input:focus { 
            border-color: var(--primary); 
            background: #fff; 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
        }
        
        .custom-input input:focus + i { color: var(--primary); }
        
        body.dark-mode .custom-input input { 
            background: #0f172a; 
            border-color: #334155; 
            color: #f1f5f9; 
        }
        
        body.dark-mode .custom-input input:focus { 
            border-color: var(--primary); 
            background: #1e293b; 
        }
        
        .btn-login { 
            width: 100%; 
            padding: 16px; 
            background: linear-gradient(90deg, var(--primary), var(--primary-dark)); 
            color: white; 
            border: none; 
            border-radius: 16px; 
            font-size: 16px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s; 
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
        }
        
        .btn-login:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4); 
        }
        
        .btn-login:active { transform: translateY(-1px); }
        
        .loading-spinner { 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(255,255,255,0.3); 
            border-top-color: white; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            display: none; 
        }
        
        .btn-login.loading .loading-spinner { display: block; }
        .btn-login.loading span { display: none; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .login-theme-toggle { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            z-index: 200001; 
        }
        
        .login-theme-toggle label { 
            background: rgba(255,255,255,0.2); 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            color: white; 
            transition: 0.3s; 
            backdrop-filter: blur(5px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        
        .login-theme-toggle label:hover { 
            background: rgba(255,255,255,0.3); 
            transform: scale(1.1); 
        }
        
        .login-theme-toggle input { display: none; }
        
        body.dark-mode .login-theme-toggle label { 
            background: var(--primary); 
            color: white; 
        }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 280px; 
            background: var(--bg-sidebar); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            position: fixed; 
            height: 100dvh; 
            right: 0; 
            top: 0; 
            z-index: 9999; 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            box-shadow: -5px 0 25px rgba(0,0,0,0.2); 
            border-left: 1px solid var(--border-color); 
            transform: translateX(0); 
            padding-bottom: 20px; 
        }
        
        .mobile-menu-btn { 
            display: none; 
            position: fixed; 
            top: max(15px, env(safe-area-inset-top)); 
            right: max(15px, env(safe-area-inset-right)); 
            z-index: 100000; 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 12px 16px; 
            border-radius: 12px; 
            font-size: 20px; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); 
        }
        
        .mobile-menu-btn:active { transform: scale(0.95); }
        
        .sidebar-overlay { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 9990; 
            backdrop-filter: blur(4px); 
            -webkit-backdrop-filter: blur(4px); 
        }
        
        .brand { 
            padding: 30px 20px 5px 20px; 
            text-align: center; 
            font-size: 18px; 
            font-weight: 900; 
            background: linear-gradient(135deg, var(--primary), #a855f7); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            letter-spacing: -0.5px; 
        }
        
        .theme-switch-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding-bottom: 10px; 
            gap: 10px; 
            font-size: 13px; 
            color: #94a3b8; 
        }
        
        .theme-switch { 
            position: relative; 
            display: inline-block; 
            width: 40px; 
            height: 20px; 
        }
        
        .theme-switch input { display: none; }
        
        .slider { 
            position: absolute; 
            cursor: pointer; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: #334155; 
            transition: .4s; 
            border-radius: 34px; 
        }
        
        .slider:before { 
            position: absolute; 
            content: ""; 
            height: 14px; 
            width: 14px; 
            left: 3px; 
            bottom: 3px; 
            background-color: white; 
            transition: .4s; 
            border-radius: 50%; 
        }
        
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .nav { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
            margin-top: 10px;
        }
        
        .nav-item { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            padding: 14px 18px; 
            margin-bottom: 6px; 
            border-radius: 14px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            color: #94a3b8; 
            font-weight: 600; 
            position: relative; 
            overflow: hidden; 
        }
        
        .nav-item:hover { 
            background: rgba(255,255,255,0.08); 
            color: white; 
            transform: translateX(-3px); 
        }
        
        .nav-item.active { 
            background: linear-gradient(90deg, var(--primary), var(--primary-dark)); 
            color: white; 
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); 
        }
        
        .nav-item i { 
            font-size: 18px; 
            width: 24px; 
            text-align: center; 
        }
        
        .nav-badge { 
            background: var(--danger); 
            color: white; 
            font-size: 11px; 
            font-weight: 700; 
            padding: 3px 8px; 
            border-radius: 12px; 
            margin-right: auto; 
            display: none; 
            animation: pulse 2s infinite; 
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        
        .user-profile { 
            padding: 15px 20px; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-top: auto; 
        }
        
        .user-avatar { 
            width: 42px; 
            height: 42px; 
            background: linear-gradient(135deg, var(--primary), #a855f7); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            color: white; 
            font-weight: 700; 
        }
        
        .user-details { 
            flex: 1; 
            overflow: hidden; 
        }
        
        .user-name { 
            font-weight: 700; 
            color: white; 
            font-size: 14px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .user-role { 
            font-size: 12px; 
            color: #94a3b8; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .logout-btn { 
            background: rgba(239, 68, 68, 0.2); 
            color: #f87171; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: 0.3s; 
        }
        
        .logout-btn:hover { 
            background: var(--danger); 
            color: white; 
        }

        /* --- MAIN CONTENT --- */
        .main-content { 
            flex: 1; 
            margin-right: 280px; 
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left)); 
            overflow-y: auto; 
            transition: margin-right 0.3s; 
        }
        
        .top-bar { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 25px; 
            flex-wrap: wrap; 
        }
        
        .welcome { 
            flex: 1; 
            min-width: 200px;
        }
        
        .welcome h1 { 
            font-size: clamp(20px, 5vw, 28px); 
            font-weight: 900; 
            color: var(--text-main); 
            margin: 0 0 5px 0; 
        }
        
        .welcome p { 
            color: var(--text-muted); 
            margin: 0; 
            font-size: 14px; 
        }
        
        .search-container { 
            position: relative; 
            min-width: 250px;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input { 
            width: 100%; 
            padding: 12px 45px 12px 15px; 
            border-radius: 14px; 
            border: 2px solid var(--border-color); 
            background: var(--bg-input); 
            color: var(--text-main); 
            font-size: 14px; 
            transition: all 0.3s; 
            outline: none; 
        }
        
        .search-input:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
        }
        
        .search-icon { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--text-muted); 
            pointer-events: none; 
        }
        
        .search-results { 
            position: absolute; 
            top: calc(100% + 10px); 
            left: 0; 
            right: 0; 
            background: var(--bg-card); 
            border: 1px solid var(--border-color); 
            border-radius: 14px; 
            box-shadow: var(--card-shadow); 
            max-height: 300px; 
            overflow-y: auto; 
            z-index: 1000; 
            display: none; 
        }
        
        .sr-item { 
            padding: 12px 15px; 
            border-bottom: 1px solid var(--border-color); 
            cursor: pointer; 
            transition: 0.2s; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sr-item:last-child { border-bottom: none; }
        
        .sr-item:hover { 
            background: var(--bg-input); 
        }
        
        .sr-tag { 
            background: var(--primary); 
            color: white; 
            padding: 4px 10px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 700; 
        }
        
        .sr-empty { 
            padding: 40px 20px; 
            text-align: center; 
            color: var(--text-muted); 
        }
        
        .sr-empty i { 
            font-size: 36px; 
            margin-bottom: 10px; 
            opacity: 0.5; 
        }

        /* --- STATS GRID --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }
        
        .stat-card { 
            background: var(--bg-card); 
            padding: 24px; 
            border-radius: 20px; 
            border: 1px solid var(--stat-card-border); 
            box-shadow: var(--card-shadow); 
            display: flex; 
            align-items: center; 
            gap: 18px; 
            transition: all 0.3s; 
        }
        
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.15); 
        }
        
        .stat-icon { 
            width: 64px; 
            height: 64px; 
            border-radius: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 28px; 
            flex-shrink: 0; 
        }
        
        .stat-details { 
            flex: 1; 
            overflow: hidden;
        }
        
        .stat-label { 
            font-size: 13px; 
            color: var(--text-muted); 
            font-weight: 600; 
            margin-bottom: 5px; 
        }
        
        .stat-value { 
            font-size: clamp(22px, 4vw, 28px); 
            font-weight: 900; 
            color: var(--text-main); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }

        /* --- CARDS --- */
        .card { 
            background: var(--bg-card); 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            margin-bottom: 25px; 
        }
        
        .card.hidden { display: none; }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .card-title { 
            font-size: clamp(18px, 4vw, 22px); 
            font-weight: 800; 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .card-actions { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap;
        }
        
        .btn { 
            padding: 10px 18px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            font-size: 14px; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap;
        }
        
        .btn:active { transform: scale(0.97); }
        
        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: var(--primary-dark); 
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3); 
        }
        
        .btn-secondary { 
            background: var(--bg-input); 
            color: var(--text-main); 
            border: 1px solid var(--border-color); 
        }
        
        .btn-secondary:hover { 
            background: var(--border-color); 
        }
        
        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        
        .btn-success:hover { 
            background: #059669; 
        }
        
        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }
        
        .btn-danger:hover { 
            background: #dc2626; 
        }
        
        .btn-icon { 
            width: 40px; 
            height: 40px; 
            padding: 0; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
        }

        /* --- FORMS --- */
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 18px; 
            margin-bottom: 20px; 
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
        }
        
        .form-group.full-width { 
            grid-column: 1 / -1; 
        }
        
        label { 
            font-weight: 600; 
            color: var(--text-main); 
            font-size: 14px; 
        }
        
        input, select, textarea { 
            padding: 12px 15px; 
            border-radius: 12px; 
            border: 2px solid var(--border-color); 
            background: var(--bg-input); 
            color: var(--text-main); 
            font-size: 14px; 
            transition: all 0.3s; 
            outline: none; 
            font-family: inherit; 
        }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
        }
        
        textarea { 
            resize: vertical; 
            min-height: 100px; 
        }
        
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .checkbox-group input[type="checkbox"] { 
            width: 20px; 
            height: 20px; 
            cursor: pointer; 
            accent-color: var(--primary); 
        }
        
        .checkbox-group label { 
            cursor: pointer; 
            margin: 0; 
        }

        /* --- TABLE --- */
        .table-container { 
            overflow-x: auto; 
            margin-top: 20px; 
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background: var(--bg-card); 
        }
        
        thead { 
            background: var(--bg-input); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        th { 
            padding: 14px 12px; 
            text-align: right; 
            font-weight: 700; 
            color: var(--text-main); 
            font-size: 13px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            white-space: nowrap;
        }
        
        td { 
            padding: 14px 12px; 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-main); 
            font-size: 14px; 
        }
        
        tbody tr { 
            transition: 0.2s; 
        }
        
        tbody tr:hover { 
            background: var(--bg-input); 
        }
        
        tbody tr:last-child td { 
            border-bottom: none; 
        }
        
        .table-actions { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap;
        }

        /* --- EXPIRY ALERTS --- */
        .expiry-container { 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        
        .expiry-item { 
            background: var(--yellow-item-bg); 
            border: 2px solid var(--yellow-item-border); 
            border-radius: 14px; 
            padding: 16px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.3s; 
        }
        
        .expiry-item:hover { 
            transform: translateX(-5px); 
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.2); 
        }
        
        .expiry-icon { 
            width: 40px; 
            height: 40px; 
            background: var(--yellow-btn-bg); 
            color: white; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 18px; 
            flex-shrink: 0; 
        }
        
        .expiry-details { 
            flex: 1; 
            overflow: hidden;
        }
        
        .expiry-customer { 
            font-weight: 700; 
            color: var(--yellow-item-text); 
            margin-bottom: 3px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .expiry-service { 
            font-size: 13px; 
            color: var(--yellow-text); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .expiry-date { 
            font-size: 12px; 
            font-weight: 600; 
            color: var(--yellow-text); 
            white-space: nowrap; 
        }
        
        .expiry-actions { 
            display: flex; 
            gap: 6px; 
            flex-shrink: 0; 
        }
        
        .btn-renew { 
            background: var(--yellow-btn-bg); 
            color: white; 
        }
        
        .btn-renew:hover { 
            background: var(--yellow-btn-hover); 
        }

        /* --- CHART --- */
        .chart-container { 
            position: relative; 
            height: 300px; 
            margin-top: 20px; 
        }

        /* --- NOTIFICATIONS --- */
        .notification { 
            position: fixed; 
            top: max(20px, env(safe-area-inset-top)); 
            left: 50%; 
            transform: translateX(-50%) translateY(-150%); 
            background: var(--bg-card); 
            color: var(--text-main); 
            padding: 16px 24px; 
            border-radius: 14px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); 
            z-index: 400000; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            min-width: 280px; 
            max-width: 90vw; 
            border: 1px solid var(--border-color); 
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; 
        }
        
        @keyframes slideDown { 
            to { transform: translateX(-50%) translateY(0); } 
        }
        
        .notification.success { 
            border-left: 4px solid var(--success); 
        }
        
        .notification.error { 
            border-left: 4px solid var(--danger); 
        }
        
        .notification i { 
            font-size: 20px; 
        }
        
        .notification.success i { color: var(--success); }
        .notification.error i { color: var(--danger); }
        
        .notification-text { 
            flex: 1; 
            font-weight: 600; 
        }

        /* --- EMPTY STATE --- */
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-muted); 
        }
        
        .empty-state i { 
            font-size: 64px; 
            margin-bottom: 20px; 
            opacity: 0.3; 
        }
        
        .empty-state h3 { 
            font-size: 20px; 
            font-weight: 700; 
            margin: 0 0 10px 0; 
        }
        
        .empty-state p { 
            margin: 0; 
            font-size: 14px; 
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { 
                transform: translateX(100%); 
                box-shadow: none; 
            }
            
            .sidebar.open { 
                transform: translateX(0); 
                box-shadow: -5px 0 25px rgba(0,0,0,0.5); 
            }
            
            .sidebar-overlay.show { 
                display: block; 
            }
            
            .mobile-menu-btn { 
                display: block; 
            }
            
            .main-content { 
                margin-right: 0; 
                padding: max(70px, env(safe-area-inset-top)) 15px max(15px, env(safe-area-inset-bottom)) 15px; 
            }
            
            .stats-grid { 
                grid-template-columns: 1fr; 
            }
            
            .form-grid { 
                grid-template-columns: 1fr; 
            }
            
            .top-bar { 
                flex-direction: column; 
                align-items: stretch; 
            }
            
            .search-container { 
                max-width: 100%; 
                min-width: 100%; 
            }
            
            .card { 
                padding: 20px 15px; 
            }
            
            .card-header { 
                flex-direction: column; 
                align-items: stretch; 
            }
            
            .card-actions { 
                width: 100%; 
            }
            
            .card-actions .btn { 
                flex: 1; 
                justify-content: center; 
            }
            
            .table-container { 
                margin-left: -15px; 
                margin-right: -15px; 
                border-radius: 0; 
                border-left: none; 
                border-right: none; 
            }
            
            th, td { 
                padding: 10px 8px; 
                font-size: 13px; 
            }
            
            .modal-content { 
                padding: 20px; 
                max-height: 80vh; 
            }
            
            .login-card { 
                padding: 30px 20px; 
            }
        }
        
        @media (max-width: 480px) {
            .stat-card { 
                padding: 18px; 
            }
            
            .stat-icon { 
                width: 52px; 
                height: 52px; 
                font-size: 24px; 
            }
            
            .btn { 
                padding: 8px 14px; 
                font-size: 13px; 
            }
            
            .expiry-item { 
                padding: 12px; 
            }
            
            .expiry-icon { 
                width: 36px; 
                height: 36px; 
                font-size: 16px; 
            }
        }

        /* --- PRINT STYLES --- */
        @media print {
            body { 
                background: white; 
                color: black; 
            }
            
            .sidebar, 
            .mobile-menu-btn, 
            .top-bar, 
            .card-actions, 
            .btn, 
            .table-actions, 
            .notification { 
                display: none !important; 
            }
            
            .main-content { 
                margin: 0; 
                padding: 0; 
            }
            
            .card { 
                page-break-inside: avoid; 
                box-shadow: none; 
                border: 1px solid #ddd; 
            }
            
            table { 
                page-break-inside: auto; 
            }
            
            tr { 
                page-break-inside: avoid; 
                page-break-after: auto; 
            }
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-theme-toggle">
            <label>
                <input type="checkbox" id="loginThemeToggle" onchange="toggleDarkMode()">
                <i class="fas fa-moon"></i>
            </label>
        </div>
        <div class="login-card">
            <div class="login-icon-wrap">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <h2>Mega Store Pro</h2>
            <p>ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ŸÖÿ∫ŸÑŸÇ - ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</p>
            <form onsubmit="attemptLogin(event)">
                <div class="custom-input">
                    <input type="text" id="loginUsername" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" autocomplete="username" required>
                    <i class="fas fa-user"></i>
                </div>
                <div class="custom-input">
                    <input type="password" id="loginPassword" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±" autocomplete="current-password" required>
                    <i class="fas fa-lock"></i>
                </div>
                <button type="submit" class="btn-login" id="loginBtn">
                    <div class="loading-spinner"></div>
                    <span>ÿØÿÆŸàŸÑ</span>
                </button>
            </form>
        </div>
    </div>

    <!-- MOBILE MENU BUTTON -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- SIDEBAR OVERLAY -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-shopping-cart"></i> MEGA STORE PRO
        </div>
        
        <div class="theme-switch-container">
            <span>ŸÅÿßÿ™ÿ≠</span>
            <label class="theme-switch">
                <input type="checkbox" id="themeToggle" onchange="toggleDarkMode()">
                <span class="slider"></span>
            </label>
            <span>ÿØÿßŸÉŸÜ</span>
        </div>
        
        <div class="nav">
            <div class="nav-item active" id="btnPurchase" onclick="showPage('purchase', this)">
                <i class="fas fa-shopping-bag"></i>
                <span>ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ°</span>
            </div>
            <div class="nav-item" id="btnHistory" onclick="showPage('history', this)">
                <i class="fas fa-history"></i>
                <span>ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ</span>
            </div>
            <div class="nav-item" id="btnStock" onclick="showPage('stock', this)">
                <i class="fas fa-box"></i>
                <span>ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ</span>
            </div>
            <div class="nav-item" id="btnExpiry" onclick="showPage('expiry', this)">
                <i class="fas fa-bell"></i>
                <span>ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</span>
                <span class="nav-badge" id="expiryBadge">0</span>
            </div>
            <div class="nav-item" id="btnNotes" onclick="showPage('generalNotes', this)">
                <i class="fas fa-sticky-note"></i>
                <span>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿπÿßŸÖÿ©</span>
            </div>
            <div class="nav-item" id="btnAudit" onclick="showPage('audit', this)">
                <i class="fas fa-shield-alt"></i>
                <span>ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©</span>
            </div>
        </div>
        
        <div class="user-profile">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
                <div class="user-name" id="userName">ŸÖÿØŸäÿ±</div>
                <div class="user-role" id="userRole">ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ</div>
            </div>
            <button class="logout-btn" onclick="logout()" title="ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="welcome">
                <h1>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ üëã</h1>
                <p id="currentDate">ÿßŸÑÿ£ÿ≠ÿØÿå 12 ŸÅÿ®ÿ±ÿßŸäÿ± 2026</p>
            </div>
            <div class="search-container">
                <input type="text" 
                       class="search-input" 
                       id="globalSearchInput" 
                       placeholder="ÿ®ÿ≠ÿ´ ÿ≥ÿ±Ÿäÿπ ŸÅŸä ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ŸàÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™..." 
                       oninput="runGlobalSearch()"
                       onfocus="runGlobalSearch()">
                <i class="fas fa-search search-icon"></i>
                <div class="search-results" id="globalSearchResults"></div>
            </div>
        </div>

        <!-- STATS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e0e7ff; color: #6366f1;">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</div>
                    <div class="stat-value" id="totalSales">0 IQD</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #dcfce7; color: #10b981;">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-label">ÿπÿØÿØ ÿßŸÑÿπŸÖŸÑÿßÿ°</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fef3c7; color: #f59e0b;">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-details">
                    <div class="stat-label">ŸÖÿ®Ÿäÿπÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±</div>
                    <div class="stat-value" id="monthSales">0 IQD</div>
                </div>
            </div>
        </div>

        <!-- PURCHASE CARD -->
        <div class="card" id="purchase">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-shopping-bag"></i>
                    ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ° ÿ¨ÿØŸäÿØÿ©
                </h2>
            </div>
            
            <form onsubmit="submitPurchase(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="customer" required>
                    </div>
                    <div class="form-group">
                        <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label>ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ <span style="color: var(--danger);">*</span></label>
                        <select id="sub" required onchange="updatePrice()">
                            <option value="">ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</option>
                            <option value="Netflix ÿ¥Ÿáÿ±Ÿä">Netflix ÿ¥Ÿáÿ±Ÿä</option>
                            <option value="Netflix ÿ≥ŸÜŸàŸä">Netflix ÿ≥ŸÜŸàŸä</option>
                            <option value="Spotify ÿ¥Ÿáÿ±Ÿä">Spotify ÿ¥Ÿáÿ±Ÿä</option>
                            <option value="Spotify ÿ≥ŸÜŸàŸä">Spotify ÿ≥ŸÜŸàŸä</option>
                            <option value="YouTube Premium ÿ¥Ÿáÿ±Ÿä">YouTube Premium ÿ¥Ÿáÿ±Ÿä</option>
                            <option value="YouTube Premium ÿ≥ŸÜŸàŸä">YouTube Premium ÿ≥ŸÜŸàŸä</option>
                            <option value="Disney+ ÿ¥Ÿáÿ±Ÿä">Disney+ ÿ¥Ÿáÿ±Ÿä</option>
                            <option value="Disney+ ÿ≥ŸÜŸàŸä">Disney+ ÿ≥ŸÜŸàŸä</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ≥ÿπÿ± (IQD) <span style="color: var(--danger);">*</span></label>
                        <input type="number" id="price" required>
                    </div>
                    <div class="form-group full-width">
                        <div class="checkbox-group">
                            <input type="checkbox" id="hasExpiry" onchange="toggleExpiry()">
                            <label for="hasExpiry">Ÿáÿ∞ÿß ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÑŸá ÿ™ÿßÿ±ŸäÿÆ ÿßŸÜÿ™Ÿáÿßÿ°</label>
                        </div>
                    </div>
                    <div class="form-group" id="expiryGroup" style="display: none;">
                        <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</label>
                        <input type="date" id="expiryDate">
                    </div>
                    <div class="form-group full-width">
                        <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                        <textarea id="notes" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="card-actions">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i>
                        ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÖŸÑŸäÿ©
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearPurchaseForm()">
                        <i class="fas fa-times"></i>
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
            </form>
        </div>

        <!-- HISTORY CARD -->
        <div class="card hidden" id="history">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-history"></i>
                    ÿ£ÿ±ÿ¥ŸäŸÅ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
                </h2>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="exportHistory()">
                        <i class="fas fa-file-excel"></i>
                        ÿ™ÿµÿØŸäÿ± Excel
                    </button>
                    <button class="btn btn-secondary" onclick="printHistory()">
                        <i class="fas fa-print"></i>
                        ÿ∑ÿ®ÿßÿπÿ©
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                            <th>ÿßŸÑÿπŸÖŸäŸÑ</th>
                            <th>ÿßŸÑŸáÿßÿ™ŸÅ</th>
                            <th>ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</th>
                            <th>ÿßŸÑÿ≥ÿπÿ±</th>
                            <th>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                            <th>ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                    </tbody>
                </table>
            </div>
            
            <div id="emptyHistory" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÖŸÑŸäÿßÿ™ ÿ®ÿπÿØ</h3>
                <p>ÿßÿ®ÿØÿ£ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸàŸÑ ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ°</p>
            </div>
        </div>

        <!-- STOCK CARD -->
        <div class="card hidden" id="stock">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-box"></i>
                    ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ
                </h2>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="showAddStock()">
                        <i class="fas fa-plus"></i>
                        ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ≥ÿßÿ®
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿÆÿØŸÖÿ©</th>
                            <th>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</th>
                            <th>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</th>
                            <th>ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ</th>
                            <th>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                            <th>ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="stockTable">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                    </tbody>
                </table>
            </div>
            
            <div id="emptyStock" class="empty-state" style="display: none;">
                <i class="fas fa-box-open"></i>
                <h3>ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÅÿßÿ±ÿ∫</h3>
                <p>ŸÇŸÖ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÖÿ™ŸàŸÅÿ±ÿ©</p>
            </div>
        </div>

        <!-- EXPIRY ALERTS CARD -->
        <div class="card hidden" id="expiry">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-bell"></i>
                    ÿ™ŸÜÿ®ŸäŸáÿßÿ™ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™
                </h2>
            </div>
            
            <div class="expiry-container" id="expiryContainer">
                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
            </div>
            
            <div id="emptyExpiry" class="empty-state" style="display: none;">
                <i class="fas fa-check-circle"></i>
                <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÜÿ®ŸäŸáÿßÿ™</h3>
                <p>ÿ¨ŸÖŸäÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉÿßÿ™ ÿµÿßŸÑÿ≠ÿ©</p>
            </div>
        </div>

        <!-- GENERAL NOTES CARD -->
        <div class="card hidden" id="generalNotes">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-sticky-note"></i>
                    ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ©
                </h2>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="showAddNote()">
                        <i class="fas fa-plus"></i>
                        ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ©
                    </button>
                </div>
            </div>
            
            <div id="notesContainer">
                <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
            </div>
            
            <div id="emptyNotes" class="empty-state" style="display: none;">
                <i class="fas fa-file-alt"></i>
                <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</h3>
                <p>ŸÇŸÖ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ¨ÿØŸäÿØÿ©</p>
            </div>
        </div>

        <!-- AUDIT LOG CARD -->
        <div class="card hidden" id="audit">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-shield-alt"></i>
                    ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©
                </h2>
                <div class="card-actions">
                    <button class="btn btn-danger" onclick="clearAuditLog()">
                        <i class="fas fa-trash"></i>
                        ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑŸàŸÇÿ™</th>
                            <th>ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</th>
                            <th>ÿßŸÑŸÜÿ¥ÿßÿ∑</th>
                        </tr>
                    </thead>
                    <tbody id="auditTable">
                        <!-- ÿ≥Ÿäÿ™ŸÖ ŸÖŸÑÿ§Ÿáÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿßŸã -->
                    </tbody>
                </table>
            </div>
            
            <div id="emptyAudit" class="empty-state" style="display: none;">
                <i class="fas fa-clipboard-list"></i>
                <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÜÿ¥ÿ∑ÿ©</h3>
                <p>ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ŸáŸÜÿß</p>
            </div>
        </div>
    </div>

<script>
// --- USERS DATABASE ---
const USERS = [
    { username: 'admin', password: 'admin123', role: 'admin', name: 'ÿßŸÑŸÖÿØŸäÿ± ÿßŸÑÿπÿßŸÖ' },
    { username: 'manager', password: 'manager123', role: 'manager', name: 'ÿßŸÑŸÖÿØŸäÿ±' },
    { username: 'viewer', password: 'viewer123', role: 'viewer', name: 'ÿπÿßÿ±ÿ∂' }
];

// --- GLOBAL STATE ---
let currentUser = null;

// --- SUBSCRIPTION PRICES ---
const PRICES = {
    'Netflix ÿ¥Ÿáÿ±Ÿä': 8000,
    'Netflix ÿ≥ŸÜŸàŸä': 85000,
    'Spotify ÿ¥Ÿáÿ±Ÿä': 6000,
    'Spotify ÿ≥ŸÜŸàŸä': 60000,
    'YouTube Premium ÿ¥Ÿáÿ±Ÿä': 7000,
    'YouTube Premium ÿ≥ŸÜŸàŸä': 75000,
    'Disney+ ÿ¥Ÿáÿ±Ÿä': 8000,
    'Disney+ ÿ≥ŸÜŸàŸä': 80000
};

// --- UTILITY FUNCTIONS ---
function safeJSON(str, def = null) {
    try { return JSON.parse(localStorage[str] || 'null') || def; } 
    catch { return def; }
}

function formatDate(d) {
    if (!d) return '';
    let date = new Date(d);
    return date.toLocaleDateString('ar-IQ', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit' 
    });
}

function formatDateTime(d) {
    if (!d) return '';
    let date = new Date(d);
    return date.toLocaleDateString('ar-IQ', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatCurrency(num) {
    return new Intl.NumberFormat('ar-IQ').format(num) + ' IQD';
}

// --- NOTIFICATION SYSTEM ---
function notify(msg, type = 'success') {
    let notif = document.createElement('div');
    notif.className = `notification ${type}`;
    
    let icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
    
    notif.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span class="notification-text">${msg}</span>
    `;
    
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.animation = 'slideDown 0.4s reverse';
        setTimeout(() => notif.remove(), 400);
    }, 3000);
}

// --- DARK MODE ---
function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    let isDark = document.body.classList.contains('dark-mode');
    localStorage.darkMode = isDark;
    
    // Sync both toggles
    document.getElementById('themeToggle').checked = isDark;
    document.getElementById('loginThemeToggle').checked = isDark;
}

function loadDarkMode() {
    if (localStorage.darkMode === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('themeToggle').checked = true;
        document.getElementById('loginThemeToggle').checked = true;
    }
}

// --- LOGIN SYSTEM ---
function attemptLogin(e) {
    e.preventDefault();
    
    let btn = document.getElementById('loginBtn');
    btn.classList.add('loading');
    
    setTimeout(() => {
        let username = document.getElementById('loginUsername').value.trim();
        let password = document.getElementById('loginPassword').value.trim();
        
        let user = USERS.find(u => u.username === username && u.password === password);
        
        btn.classList.remove('loading');
        
        if (user) {
            currentUser = user;
            localStorage.currentUser = JSON.stringify(user);
            document.getElementById('loginOverlay').style.display = 'none';
            initApp();
            logAction(`ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ - ${user.name}`);
        } else {
            notify('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ£Ÿà ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠ÿ©', 'error');
        }
    }, 1000);
}

function logout() {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
        logAction(`ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ - ${currentUser.name}`);
        localStorage.removeItem('currentUser');
        location.reload();
    }
}

function checkAuth() {
    let user = safeJSON(localStorage.currentUser);
    if (user && USERS.find(u => u.username === user.username)) {
        currentUser = user;
        document.getElementById('loginOverlay').style.display = 'none';
        return true;
    }
    return false;
}

// --- AUDIT LOG ---
function logAction(action) {
    if (!currentUser) return;
    
    let logs = safeJSON(localStorage.auditLog, []);
    logs.unshift({
        timestamp: new Date().getTime(),
        user: currentUser.name,
        action: action
    });
    
    // Keep last 100 entries
    if (logs.length > 100) logs = logs.slice(0, 100);
    
    localStorage.auditLog = JSON.stringify(logs);
    renderAuditLog();
}

function renderAuditLog() {
    let logs = safeJSON(localStorage.auditLog, []);
    let tbody = document.getElementById('auditTable');
    let empty = document.getElementById('emptyAudit');
    
    if (logs.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${formatDateTime(log.timestamp)}</td>
            <td><strong>${log.user}</strong></td>
            <td>${log.action}</td>
        </tr>
    `).join('');
}

function clearAuditLog() {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ', 'error');
        return;
    }
    
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©ÿü')) {
        localStorage.auditLog = JSON.stringify([]);
        renderAuditLog();
        logAction('ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©');
        notify('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©', 'success');
    }
}

// --- PAGE NAVIGATION ---
function showPage(pageId, btn) {
    document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    document.getElementById(pageId).classList.remove('hidden');
    if (btn) btn.classList.add('active');
    
    // Close mobile menu
    if (window.innerWidth <= 768) {
        toggleSidebar();
    }
    
    // Hide search results
    hideSearchResults();
    
    logAction(`ÿπÿ±ÿ∂ ÿµŸÅÿ≠ÿ©: ${btn ? btn.textContent.trim() : pageId}`);
}

function toggleSidebar() {
    document.getElementById('sidebar').classList.toggle('open');
    document.querySelector('.sidebar-overlay').classList.toggle('show');
}

// --- PURCHASE FORM ---
function updatePrice() {
    let sub = document.getElementById('sub').value;
    if (PRICES[sub]) {
        document.getElementById('price').value = PRICES[sub];
    }
}

function toggleExpiry() {
    let checked = document.getElementById('hasExpiry').checked;
    document.getElementById('expiryGroup').style.display = checked ? 'block' : 'none';
}

function submitPurchase(e) {
    e.preventDefault();
    
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑŸäÿßÿ™', 'error');
        return;
    }
    
    let purchase = {
        id: Date.now(),
        date: new Date().getTime(),
        customer: document.getElementById('customer').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        sub: document.getElementById('sub').value,
        price: parseFloat(document.getElementById('price').value),
        notes: document.getElementById('notes').value.trim()
    };
    
    if (document.getElementById('hasExpiry').checked) {
        let expiryDate = document.getElementById('expiryDate').value;
        if (expiryDate) {
            purchase.expiry = new Date(expiryDate).getTime();
        }
    }
    
    let purchases = safeJSON(localStorage.purchases, []);
    purchases.unshift(purchase);
    localStorage.purchases = JSON.stringify(purchases);
    
    notify('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    clearPurchaseForm();
    renderHistory();
    updateStats();
    checkExpiring();
    logAction(`ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ° - ${purchase.customer}`);
}

function clearPurchaseForm() {
    document.getElementById('customer').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('sub').value = '';
    document.getElementById('price').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('hasExpiry').checked = false;
    document.getElementById('expiryDate').value = '';
    toggleExpiry();
}

// --- HISTORY ---
function renderHistory() {
    let purchases = safeJSON(localStorage.purchases, []);
    let tbody = document.getElementById('historyTable');
    let empty = document.getElementById('emptyHistory');
    
    if (purchases.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    tbody.innerHTML = purchases.map(p => `
        <tr>
            <td>${formatDate(p.date)}</td>
            <td><strong>${p.customer}</strong></td>
            <td>${p.phone || '-'}</td>
            <td>${p.sub}</td>
            <td><strong>${formatCurrency(p.price)}</strong></td>
            <td>${p.notes || '-'}</td>
            <td>
                <div class="table-actions">
                    <button class="btn btn-secondary btn-icon" onclick="viewPurchase(${p.id})" title="ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${currentUser.role !== 'viewer' ? `
                        <button class="btn btn-danger btn-icon" onclick="deletePurchase(${p.id})" title="ÿ≠ÿ∞ŸÅ">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function viewPurchase(id) {
    let purchases = safeJSON(localStorage.purchases, []);
    let p = purchases.find(x => x.id === id);
    if (!p) return;
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 class="card-title" style="margin-bottom: 20px;">
                <i class="fas fa-receipt"></i>
                ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿπŸÖŸÑŸäÿ©
            </h2>
            <div class="detail-row">
                <span class="detail-label">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</span>
                <span class="detail-value">${formatDate(p.date)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</span>
                <span class="detail-value">${p.customer}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</span>
                <span class="detail-value">${p.phone || '-'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ</span>
                <span class="detail-value">${p.sub}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">ÿßŸÑÿ≥ÿπÿ±</span>
                <span class="detail-value" style="color: var(--success);">${formatCurrency(p.price)}</span>
            </div>
            ${p.expiry ? `
            <div class="detail-row">
                <span class="detail-label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°</span>
                <span class="detail-value">${formatDate(p.expiry)}</span>
            </div>
            ` : ''}
            ${p.notes ? `
            <div class="detail-row">
                <span class="detail-label">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</span>
                <span class="detail-value">${p.notes}</span>
            </div>
            ` : ''}
            <div style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="width: 100%;">
                    <i class="fas fa-times"></i>
                    ÿ•ÿ∫ŸÑÿßŸÇ
                </button>
            </div>
        </div>
    `;
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    document.body.appendChild(modal);
}

function deletePurchase(id) {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ', 'error');
        return;
    }
    
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿπŸÖŸÑŸäÿ©ÿü')) return;
    
    let purchases = safeJSON(localStorage.purchases, []);
    let p = purchases.find(x => x.id === id);
    purchases = purchases.filter(x => x.id !== id);
    localStorage.purchases = JSON.stringify(purchases);
    
    notify('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿπŸÖŸÑŸäÿ©', 'success');
    renderHistory();
    updateStats();
    checkExpiring();
    if (p) logAction(`ÿ≠ÿ∞ŸÅ ÿπŸÖŸÑŸäÿ© ÿ¥ÿ±ÿßÿ° - ${p.customer}`);
}

function exportHistory() {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'error');
        return;
    }
    
    let purchases = safeJSON(localStorage.purchases, []);
    if (purchases.length === 0) {
        notify('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÖŸÑŸäÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±', 'error');
        return;
    }
    
    let csv = 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ,ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ,ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ,ŸÜŸàÿπ ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ,ÿßŸÑÿ≥ÿπÿ±,ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°,ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™\n';
    purchases.forEach(p => {
        csv += `${formatDate(p.date)},${p.customer},${p.phone || ''},${p.sub},${p.price},${p.expiry ? formatDate(p.expiry) : ''},${p.notes || ''}\n`;
    });
    
    let blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `purchases_${formatDate(Date.now())}.csv`;
    a.click();
    logAction('ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ ÿ•ŸÑŸâ Excel');
    notify('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑŸÖŸÑŸÅ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
}

function printHistory() {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ∑ÿ®ÿßÿπÿ©', 'error');
        return;
    }
    
    let histCard = document.getElementById('history');
    let wasHidden = histCard.classList.contains('hidden');
    
    if (wasHidden) {
        document.querySelectorAll('.card').forEach(x => x.classList.add('hidden'));
        histCard.classList.remove('hidden');
    }
    
    window.print();
    
    if (wasHidden) {
        histCard.classList.add('hidden');
        document.getElementById('purchase').classList.remove('hidden');
    }
    
    logAction('ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ£ÿ±ÿ¥ŸäŸÅ');
}

// --- STOCK MANAGEMENT ---
function renderStock() {
    let stock = safeJSON(localStorage.stock, []);
    let tbody = document.getElementById('stockTable');
    let empty = document.getElementById('emptyStock');
    
    if (stock.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    tbody.innerHTML = stock.map(s => `
        <tr>
            <td><strong>${s.service}</strong></td>
            <td>${s.email || '-'}</td>
            <td>${s.password || '-'}</td>
            <td>
                <span style="padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; 
                      background: ${s.used ? 'var(--danger)' : 'var(--success)'}20; 
                      color: ${s.used ? 'var(--danger)' : 'var(--success)'};">
                    ${s.used ? 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : 'ŸÖÿ™ÿßÿ≠'}
                </span>
            </td>
            <td>${s.notes || '-'}</td>
            <td>
                <div class="table-actions">
                    ${currentUser.role !== 'viewer' ? `
                        <button class="btn ${s.used ? 'btn-success' : 'btn-secondary'} btn-icon" 
                                onclick="toggleStockUsed(${s.id})" 
                                title="${s.used ? 'ÿ™ÿ≠ÿØŸäÿØ ŸÉŸÖÿ™ÿßÿ≠' : 'ÿ™ÿ≠ÿØŸäÿØ ŸÉŸÖÿ≥ÿ™ÿÆÿØŸÖ'}">
                            <i class="fas fa-${s.used ? 'check' : 'times'}"></i>
                        </button>
                        <button class="btn btn-danger btn-icon" onclick="deleteStock(${s.id})" title="ÿ≠ÿ∞ŸÅ">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function showAddStock() {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ≥ÿßÿ®ÿßÿ™', 'error');
        return;
    }
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 class="card-title" style="margin-bottom: 20px;">
                <i class="fas fa-plus"></i>
                ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ
            </h2>
            <form onsubmit="submitStock(event, this.closest('.modal-overlay'))">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>ÿßŸÑÿÆÿØŸÖÿ©</label>
                        <input type="text" name="service" required>
                    </div>
                    <div class="form-group">
                        <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                        <input type="text" name="email">
                    </div>
                    <div class="form-group">
                        <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                        <input type="text" name="password">
                    </div>
                    <div class="form-group full-width">
                        <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                        <textarea name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-check"></i>
                        ÿ≠ŸÅÿ∏
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
            </form>
        </div>
    `;
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    document.body.appendChild(modal);
}

function submitStock(e, modal) {
    e.preventDefault();
    
    let formData = new FormData(e.target);
    let item = {
        id: Date.now(),
        service: formData.get('service').trim(),
        email: formData.get('email').trim(),
        password: formData.get('password').trim(),
        notes: formData.get('notes').trim(),
        used: false
    };
    
    let stock = safeJSON(localStorage.stock, []);
    stock.unshift(item);
    localStorage.stock = JSON.stringify(stock);
    
    notify('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ® ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    renderStock();
    modal.remove();
    logAction(`ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿ≥ÿßÿ® ŸÖÿÆÿ≤ŸàŸÜ - ${item.service}`);
}

function toggleStockUsed(id) {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ', 'error');
        return;
    }
    
    let stock = safeJSON(localStorage.stock, []);
    let item = stock.find(x => x.id === id);
    if (item) {
        item.used = !item.used;
        localStorage.stock = JSON.stringify(stock);
        renderStock();
        logAction(`ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿ≠ÿ≥ÿßÿ® - ${item.service}: ${item.used ? 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : 'ŸÖÿ™ÿßÿ≠'}`);
    }
}

function deleteStock(id) {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ', 'error');
        return;
    }
    
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≠ÿ≥ÿßÿ®ÿü')) return;
    
    let stock = safeJSON(localStorage.stock, []);
    let item = stock.find(x => x.id === id);
    stock = stock.filter(x => x.id !== id);
    localStorage.stock = JSON.stringify(stock);
    
    notify('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ÿ≥ÿßÿ®', 'success');
    renderStock();
    if (item) logAction(`ÿ≠ÿ∞ŸÅ ÿ≠ÿ≥ÿßÿ® ŸÖÿÆÿ≤ŸàŸÜ - ${item.service}`);
}

// --- EXPIRY ALERTS ---
function checkExpiring() {
    let purchases = safeJSON(localStorage.purchases, []);
    let now = new Date().getTime();
    let days3 = 3 * 24 * 60 * 60 * 1000;
    
    let expiring = purchases.filter(p => {
        if (!p.expiry || p.expiryDismissed) return false;
        let diff = p.expiry - now;
        // Show if within 3 days or expired within last month
        return diff < days3 && diff > -30 * 24 * 60 * 60 * 1000;
    });
    
    renderExpiring(expiring);
    
    // Update badge
    let badge = document.getElementById('expiryBadge');
    if (expiring.length > 0) {
        badge.textContent = expiring.length;
        badge.style.display = 'inline-flex';
    } else {
        badge.style.display = 'none';
    }
}

function renderExpiring(expiring) {
    let container = document.getElementById('expiryContainer');
    let empty = document.getElementById('emptyExpiry');
    
    if (expiring.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    let now = new Date().getTime();
    
    container.innerHTML = expiring.map(p => {
        let isExpired = p.expiry < now;
        let daysLeft = Math.ceil((p.expiry - now) / (24 * 60 * 60 * 1000));
        
        return `
            <div class="expiry-item">
                <div class="expiry-icon">
                    <i class="fas fa-${isExpired ? 'exclamation-triangle' : 'bell'}"></i>
                </div>
                <div class="expiry-details">
                    <div class="expiry-customer">${p.customer}</div>
                    <div class="expiry-service">${p.sub}</div>
                </div>
                <div class="expiry-date">
                    ${isExpired ? 'ŸÖŸÜÿ™ŸáŸä' : `${daysLeft} ŸäŸàŸÖ`}
                </div>
                <div class="expiry-actions">
                    <button class="btn btn-renew btn-icon" onclick="renewSubscription(${p.id})" title="ÿ™ÿ¨ÿØŸäÿØ">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn btn-secondary btn-icon" onclick="dismissExpiry(${p.id})" title="ÿ™ÿ¨ÿßŸáŸÑ">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function renewSubscription(id) {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ™ÿ¨ÿØŸäÿØ', 'error');
        return;
    }
    
    let purchases = safeJSON(localStorage.purchases, []);
    let p = purchases.find(x => x.id === id);
    if (!p) return;
    
    // Fill purchase form with existing data
    document.getElementById('customer').value = p.customer;
    document.getElementById('phone').value = p.phone || '';
    document.getElementById('sub').value = p.sub;
    document.getElementById('price').value = p.price;
    document.getElementById('hasExpiry').checked = true;
    toggleExpiry();
    
    // Set new expiry date (30 days from today)
    let newExpiry = new Date();
    newExpiry.setDate(newExpiry.getDate() + 30);
    document.getElementById('expiryDate').value = newExpiry.toISOString().split('T')[0];
    
    // Switch to purchase page
    showPage('purchase', document.getElementById('btnPurchase'));
    
    notify('ÿ™ŸÖ ŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ÿå ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ÿπÿØŸäŸÑ Ÿàÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ¨ÿØŸäÿØ', 'success');
    logAction(`ÿ®ÿØÿ° ÿ™ÿ¨ÿØŸäÿØ ÿßÿ¥ÿ™ÿ±ÿßŸÉ - ${p.customer}`);
}

function dismissExpiry(id) {
    let purchases = safeJSON(localStorage.purchases, []);
    let p = purchases.find(x => x.id === id);
    if (p) {
        p.expiryDismissed = true;
        localStorage.purchases = JSON.stringify(purchases);
        checkExpiring();
        logAction(`ÿ™ÿ¨ÿßŸáŸÑ ÿ™ŸÜÿ®ŸäŸá ÿßŸÜÿ™Ÿáÿßÿ° - ${p.customer}`);
    }
}

function checkExpiringOnLogin() {
    let purchases = safeJSON(localStorage.purchases, []);
    let now = new Date().getTime();
    let days3 = 3 * 24 * 60 * 60 * 1000;
    
    let expiring = purchases.filter(p => {
        if (!p.expiry || p.expiryDismissed) return false;
        let diff = p.expiry - now;
        return diff < days3 && diff > -30 * 24 * 60 * 60 * 1000;
    });
    
    if (expiring.length > 0) {
        let expired = expiring.filter(p => p.expiry < now).length;
        let soon = expiring.length - expired;
        
        setTimeout(() => {
            if (expired > 0) notify(`${expired} ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©`, 'error');
            if (soon > 0) setTimeout(() => notify(`${soon} ÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸäŸÜÿ™ŸáŸä ÿÆŸÑÿßŸÑ 3 ÿ£ŸäÿßŸÖ`, 'error'), 1000);
        }, 1500);
    }
}

// --- GENERAL NOTES ---
function renderNotes() {
    let notes = safeJSON(localStorage.generalNotes, []);
    let container = document.getElementById('notesContainer');
    let empty = document.getElementById('emptyNotes');
    
    if (notes.length === 0) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    container.innerHTML = notes.map(n => `
        <div class="card" style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
                <div style="flex: 1;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">
                        <i class="fas fa-clock"></i> ${formatDateTime(n.date)}
                    </div>
                    <div style="white-space: pre-wrap; color: var(--text-main);">${n.text}</div>
                </div>
                ${currentUser.role !== 'viewer' ? `
                    <button class="btn btn-danger btn-icon" onclick="deleteNote(${n.id})" title="ÿ≠ÿ∞ŸÅ">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
}

function showAddNote() {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', 'error');
        return;
    }
    
    let modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 class="card-title" style="margin-bottom: 20px;">
                <i class="fas fa-plus"></i>
                ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ¨ÿØŸäÿØÿ©
            </h2>
            <form onsubmit="submitNote(event, this.closest('.modal-overlay'))">
                <div class="form-group">
                    <label>ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©</label>
                    <textarea name="text" rows="5" required></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        <i class="fas fa-check"></i>
                        ÿ≠ŸÅÿ∏
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()" style="flex: 1;">
                        <i class="fas fa-times"></i>
                        ÿ•ŸÑÿ∫ÿßÿ°
                    </button>
                </div>
            </form>
        </div>
    `;
    modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
    };
    document.body.appendChild(modal);
}

function submitNote(e, modal) {
    e.preventDefault();
    
    let formData = new FormData(e.target);
    let note = {
        id: Date.now(),
        date: new Date().getTime(),
        text: formData.get('text').trim()
    };
    
    let notes = safeJSON(localStorage.generalNotes, []);
    notes.unshift(note);
    localStorage.generalNotes = JSON.stringify(notes);
    
    notify('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success');
    renderNotes();
    modal.remove();
    logAction('ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿπÿßŸÖÿ©');
}

function deleteNote(id) {
    if (currentUser.role === 'viewer') {
        notify('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ', 'error');
        return;
    }
    
    if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©ÿü')) return;
    
    let notes = safeJSON(localStorage.generalNotes, []);
    notes = notes.filter(x => x.id !== id);
    localStorage.generalNotes = JSON.stringify(notes);
    
    notify('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿ©', 'success');
    renderNotes();
    logAction('ÿ≠ÿ∞ŸÅ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿπÿßŸÖÿ©');
}

// --- STATISTICS ---
function updateStats() {
    let purchases = safeJSON(localStorage.purchases, []);
    
    // Total sales
    let total = purchases.reduce((sum, p) => sum + p.price, 0);
    document.getElementById('totalSales').textContent = formatCurrency(total);
    
    // Unique customers
    let customers = new Set(purchases.map(p => p.customer));
    document.getElementById('totalCustomers').textContent = customers.size;
    
    // This month sales
    let now = new Date();
    let thisMonth = purchases.filter(p => {
        let d = new Date(p.date);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    });
    let monthTotal = thisMonth.reduce((sum, p) => sum + p.price, 0);
    document.getElementById('monthSales').textContent = formatCurrency(monthTotal);
}

// --- SEARCH ---
function runGlobalSearch() {
    let q = document.getElementById('globalSearchInput').value.trim().toLowerCase();
    let resultsDiv = document.getElementById('globalSearchResults');
    
    if (q.length < 2) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    let results = [];
    let purchases = safeJSON(localStorage.purchases, []);
    let notes = safeJSON(localStorage.generalNotes, []);
    let stock = safeJSON(localStorage.stock, []);
    
    // Search purchases
    purchases.forEach(p => {
        if ((p.customer || '').toLowerCase().includes(q) || 
            (p.sub || '').toLowerCase().includes(q) || 
            (p.phone || '').includes(q)) {
            results.push({
                tag: 'ÿπŸÖŸÑŸäÿ©',
                text: `${p.customer} - ${p.sub} (${formatDate(p.date)})`,
                action: () => showPage('history', document.getElementById('btnHistory'))
            });
        }
    });
    
    // Search notes
    notes.forEach(n => {
        if ((n.text || '').toLowerCase().includes(q)) {
            results.push({
                tag: 'ŸÖŸÑÿßÿ≠ÿ∏ÿ©',
                text: n.text.substring(0, 60) + '...',
                action: () => showPage('generalNotes', document.getElementById('btnNotes'))
            });
        }
    });
    
    // Search stock
    stock.forEach(s => {
        if ((s.service || '').toLowerCase().includes(q) || 
            (s.email || '').toLowerCase().includes(q)) {
            results.push({
                tag: 'ŸÖÿÆÿ≤ŸàŸÜ',
                text: `${s.service} - ${s.email || ''}`,
                action: () => showPage('stock', document.getElementById('btnStock'))
            });
        }
    });
    
    if (results.length === 0) {
        resultsDiv.innerHTML = `
            <div class="sr-empty">
                <i class="fas fa-search"></i>
                <div>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÄ "${q}"</div>
            </div>
        `;
    } else {
        resultsDiv.innerHTML = results.slice(0, 10).map((r, i) => `
            <div class="sr-item" onclick="selectSearchResult(${i})" data-idx="${i}">
                <span class="sr-tag">${r.tag}</span>
                <span>${r.text}</span>
            </div>
        `).join('');
        resultsDiv._results = results;
    }
    
    resultsDiv.style.display = 'block';
}

function selectSearchResult(i) {
    let results = document.getElementById('globalSearchResults')._results;
    if (results && results[i]) {
        results[i].action();
        hideSearchResults();
        document.getElementById('globalSearchInput').value = '';
    }
}

function hideSearchResults() {
    document.getElementById('globalSearchResults').style.display = 'none';
}

// Close search on click outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-container')) {
        hideSearchResults();
    }
});

// --- INITIALIZATION ---
function initApp() {
    // Update user info
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = 
        currentUser.role === 'admin' ? 'ŸÖÿØŸäÿ± ÿßŸÑŸÜÿ∏ÿßŸÖ' : 
        currentUser.role === 'manager' ? 'ŸÖÿØŸäÿ±' : 'ÿπÿßÿ±ÿ∂';
    document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
    
    // Update current date
    let dateOptions = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    document.getElementById('currentDate').textContent = 
        new Date().toLocaleDateString('ar-IQ', dateOptions);
    
    // Render all data
    renderHistory();
    renderStock();
    renderNotes();
    renderAuditLog();
    updateStats();
    checkExpiring();
    
    // Check for expiring subscriptions on login
    checkExpiringOnLogin();
}

function init() {
    loadDarkMode();
    
    if (checkAuth()) {
        initApp();
    }
}

window.onload = init;
</script>
</body>
</html>
